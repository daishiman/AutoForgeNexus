# AutoForgeNexus - Alert Configuration
# observability-engineer ã«ã‚ˆã‚‹åŒ…æ‹¬çš„ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

metadata:
  name: autoforgenexus-alerts
  version: "1.0.0"
  description: "åŒ…æ‹¬çš„ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã¨ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥"
  maintainer: "observability-engineer"
  last_updated: "2024-09-27"

# ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒ£ãƒãƒ«è¨­å®š
channels:
  discord:
    type: webhook
    url: "${DISCORD_WEBHOOK_URL}"
    enabled: true
    format: discord_embed
    timeout: 30s
    retry_count: 3
    severity_filter: ["critical", "high", "medium"]

  email:
    type: smtp
    enabled: false  # æœ¬ç•ªç’°å¢ƒã§æœ‰åŠ¹åŒ–
    smtp_host: "${SMTP_HOST}"
    smtp_port: 587
    smtp_user: "${SMTP_USER}"
    smtp_password: "${SMTP_PASSWORD}"
    from: "alerts@autoforgenexus.com"
    to: ["admin@autoforgenexus.com"]
    severity_filter: ["critical", "high"]

  pagerduty:
    type: pagerduty
    enabled: false  # æœ¬ç•ªç’°å¢ƒã§æœ‰åŠ¹åŒ–
    integration_key: "${PAGERDUTY_INTEGRATION_KEY}"
    severity_filter: ["critical"]

# é‡è¦åº¦ãƒ¬ãƒ™ãƒ«å®šç¾©
severity_levels:
  critical:
    description: "ã‚·ã‚¹ãƒ†ãƒ ãƒ€ã‚¦ãƒ³ã€ãƒ‡ãƒ¼ã‚¿æå¤±ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³"
    response_time: "5åˆ†ä»¥å†…"
    escalation_time: "15åˆ†"
    channels: ["discord", "email", "pagerduty"]

  high:
    description: "ä¸»è¦æ©Ÿèƒ½ã®éšœå®³ã€å¤§å¹…ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹"
    response_time: "15åˆ†ä»¥å†…"
    escalation_time: "30åˆ†"
    channels: ["discord", "email"]

  medium:
    description: "éƒ¨åˆ†çš„ãªæ©Ÿèƒ½éšœå®³ã€è­¦å‘Šãƒ¬ãƒ™ãƒ«ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
    response_time: "1æ™‚é–“ä»¥å†…"
    escalation_time: "4æ™‚é–“"
    channels: ["discord"]

  low:
    description: "æƒ…å ±æä¾›ã€å°†æ¥çš„ãªå•é¡Œã®äºˆå…†"
    response_time: "24æ™‚é–“ä»¥å†…"
    escalation_time: "ãªã—"
    channels: ["discord"]

# ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚¢ãƒ©ãƒ¼ãƒˆ
infrastructure_alerts:
  # ã‚µãƒ¼ãƒ“ã‚¹å¯ç”¨æ€§
  service_availability:
    name: "ã‚µãƒ¼ãƒ“ã‚¹å¯ç”¨æ€§ä½ä¸‹"
    description: "ã‚µãƒ¼ãƒ“ã‚¹ã®å¯ç”¨æ€§ãŒé–¾å€¤ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ"
    severity: critical
    enabled: true
    conditions:
      - metric: "availability_percentage"
        operator: "less_than"
        threshold: 99.9
        duration: "5m"
    query: "sum(rate(http_requests_total{job='autoforgenexus'}[5m])) / sum(rate(http_requests_total{job='autoforgenexus'}[5m]))"

  # ã‚¨ãƒ©ãƒ¼ç‡
  error_rate:
    name: "é«˜ã‚¨ãƒ©ãƒ¼ç‡"
    description: "HTTP ã‚¨ãƒ©ãƒ¼ç‡ãŒç•°å¸¸ã«é«˜ããªã£ã¦ã„ã¾ã™"
    severity: high
    enabled: true
    conditions:
      - metric: "error_rate_percentage"
        operator: "greater_than"
        threshold: 5.0
        duration: "5m"
    query: "sum(rate(http_requests_total{job='autoforgenexus',status=~'5..'}[5m])) / sum(rate(http_requests_total{job='autoforgenexus'}[5m])) * 100"

  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
  response_time:
    name: "é«˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“"
    description: "P95 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒé–¾å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™"
    severity: medium
    enabled: true
    conditions:
      - metric: "response_time_p95"
        operator: "greater_than"
        threshold: 2000  # ms
        duration: "10m"
    query: "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job='autoforgenexus'}[5m])) by (le)) * 1000"

  # CPU ä½¿ç”¨ç‡
  cpu_usage:
    name: "é«˜CPUä½¿ç”¨ç‡"
    description: "CPU ä½¿ç”¨ç‡ãŒç¶™ç¶šçš„ã«é«˜ã„çŠ¶æ…‹ã§ã™"
    severity: medium
    enabled: true
    conditions:
      - metric: "cpu_usage_percentage"
        operator: "greater_than"
        threshold: 80.0
        duration: "15m"
    query: "100 - (avg by (instance) (irate(node_cpu_seconds_total{mode='idle'}[5m])) * 100)"

  # ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
  memory_usage:
    name: "é«˜ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡"
    description: "ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒå±é™ºãƒ¬ãƒ™ãƒ«ã«é”ã—ã¦ã„ã¾ã™"
    severity: high
    enabled: true
    conditions:
      - metric: "memory_usage_percentage"
        operator: "greater_than"
        threshold: 90.0
        duration: "10m"
    query: "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100"

  # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡
  disk_usage:
    name: "é«˜ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡"
    description: "ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒè­¦å‘Šãƒ¬ãƒ™ãƒ«ã§ã™"
    severity: medium
    enabled: true
    conditions:
      - metric: "disk_usage_percentage"
        operator: "greater_than"
        threshold: 85.0
        duration: "5m"
    query: "100 - ((node_filesystem_avail_bytes{mountpoint='/'} * 100) / node_filesystem_size_bytes{mountpoint='/'})"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ©ãƒ¼ãƒˆ
application_alerts:
  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
  database_connection:
    name: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šéšœå®³"
    description: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™"
    severity: critical
    enabled: true
    conditions:
      - metric: "database_connection_failures"
        operator: "greater_than"
        threshold: 5
        duration: "2m"
    query: "sum(rate(database_connection_errors_total[5m]))"

  # Redisæ¥ç¶š
  redis_connection:
    name: "Redisæ¥ç¶šéšœå®³"
    description: "Redis æ¥ç¶šã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™"
    severity: high
    enabled: true
    conditions:
      - metric: "redis_connection_failures"
        operator: "greater_than"
        threshold: 3
        duration: "5m"
    query: "sum(rate(redis_connection_errors_total[5m]))"

  # LLM API ã‚¨ãƒ©ãƒ¼
  llm_api_errors:
    name: "LLM API ã‚¨ãƒ©ãƒ¼"
    description: "LLM API å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ãŒå¢—åŠ ã—ã¦ã„ã¾ã™"
    severity: medium
    enabled: true
    conditions:
      - metric: "llm_api_error_rate"
        operator: "greater_than"
        threshold: 10.0  # %
        duration: "10m"
    query: "sum(rate(llm_api_errors_total[5m])) / sum(rate(llm_api_requests_total[5m])) * 100"

  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡¦ç†æ™‚é–“
  prompt_processing_time:
    name: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡¦ç†æ™‚é–“ç•°å¸¸"
    description: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡¦ç†æ™‚é–“ãŒç•°å¸¸ã«é•·ããªã£ã¦ã„ã¾ã™"
    severity: medium
    enabled: true
    conditions:
      - metric: "prompt_processing_time_p95"
        operator: "greater_than"
        threshold: 30000  # ms
        duration: "10m"
    query: "histogram_quantile(0.95, sum(rate(prompt_processing_duration_seconds_bucket[5m])) by (le)) * 1000"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ
security_alerts:
  # èªè¨¼å¤±æ•—
  authentication_failures:
    name: "èªè¨¼å¤±æ•—æ€¥å¢—"
    description: "èªè¨¼å¤±æ•—ã®è©¦è¡ŒãŒæ€¥æ¿€ã«å¢—åŠ ã—ã¦ã„ã¾ã™"
    severity: high
    enabled: true
    conditions:
      - metric: "auth_failure_rate"
        operator: "greater_than"
        threshold: 50
        duration: "5m"
    query: "sum(rate(auth_failures_total[5m]))"

  # ç•°å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
  abnormal_request_pattern:
    name: "ç•°å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³"
    description: "é€šå¸¸ã¨ã¯ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    severity: medium
    enabled: true
    conditions:
      - metric: "request_rate_anomaly"
        operator: "greater_than"
        threshold: 3  # æ¨™æº–åå·®
        duration: "10m"
    query: "abs(rate(http_requests_total[5m]) - avg_over_time(rate(http_requests_total[5m])[1h])) / stddev_over_time(rate(http_requests_total[5m])[1h])"

  # å¤§é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  large_file_uploads:
    name: "å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
    description: "ç•°å¸¸ã«å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    severity: medium
    enabled: true
    conditions:
      - metric: "upload_size_mb"
        operator: "greater_than"
        threshold: 100  # MB
        duration: "1m"
    query: "max(upload_size_bytes) / 1024 / 1024"

# ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ
business_alerts:
  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç‡ä½ä¸‹
  user_registration_drop:
    name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç‡ä½ä¸‹"
    description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç‡ãŒé€šå¸¸ã‚ˆã‚Šå¤§å¹…ã«ä½ä¸‹ã—ã¦ã„ã¾ã™"
    severity: medium
    enabled: true
    conditions:
      - metric: "registration_rate_drop"
        operator: "less_than"
        threshold: -50  # % æ¸›å°‘
        duration: "1h"
    query: "(rate(user_registrations_total[1h]) - rate(user_registrations_total[1h] offset 24h)) / rate(user_registrations_total[1h] offset 24h) * 100"

  # APIä½¿ç”¨é‡æ€¥å¢—
  api_usage_spike:
    name: "APIä½¿ç”¨é‡æ€¥å¢—"
    description: "API ä½¿ç”¨é‡ãŒé€šå¸¸ã®3å€ã‚’è¶…ãˆã¦ã„ã¾ã™"
    severity: low
    enabled: true
    conditions:
      - metric: "api_usage_spike"
        operator: "greater_than"
        threshold: 3.0  # å€ç‡
        duration: "15m"
    query: "rate(api_requests_total[15m]) / avg_over_time(rate(api_requests_total[15m])[7d])"

# ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
escalation:
  level_1:
    duration: "15m"
    action: "repeat_notification"
    channels: ["discord"]

  level_2:
    duration: "30m"
    action: "escalate_severity"
    channels: ["discord", "email"]

  level_3:
    duration: "1h"
    action: "page_oncall"
    channels: ["discord", "email", "pagerduty"]

# æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«
suppression:
  maintenance_window:
    enabled: false
    schedule: "0 2 * * 0"  # æ¯é€±æ—¥æ›œæ—¥ 2:00 AM
    duration: "2h"
    alerts: ["infrastructure_alerts"]

  false_positive_reduction:
    enabled: true
    rules:
      - name: "çŸ­æ™‚é–“ã®ã‚¹ãƒ‘ã‚¤ã‚¯ç„¡è¦–"
        condition: "duration < 1m"
        action: "suppress"
      - name: "é–‹ç™ºç’°å¢ƒã®ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶"
        condition: "environment == 'development'"
        action: "suppress"

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š
templates:
  discord_embed:
    title: "ğŸš¨ AutoForgeNexus Alert - {alert_name}"
    description: "{description}"
    color:
      critical: 16711680  # èµ¤
      high: 16776960      # é»„
      medium: 65535       # é’
      low: 8421504        # ç°
    fields:
      - name: "é‡è¦åº¦"
        value: "{severity}"
        inline: true
      - name: "ç’°å¢ƒ"
        value: "{environment}"
        inline: true
      - name: "ç™ºç”Ÿæ™‚åˆ»"
        value: "{timestamp}"
        inline: true
      - name: "ãƒ¡ãƒˆãƒªã‚¯ã‚¹å€¤"
        value: "{metric_value}"
        inline: false
    footer:
      text: "AutoForgeNexus Monitoring"
      icon_url: "https://autoforgenexus.com/icon.png"

  email:
    subject: "[{severity}] AutoForgeNexus Alert: {alert_name}"
    body: |
      ã‚¢ãƒ©ãƒ¼ãƒˆè©³ç´°:

      åå‰: {alert_name}
      é‡è¦åº¦: {severity}
      ç’°å¢ƒ: {environment}
      ç™ºç”Ÿæ™‚åˆ»: {timestamp}
      èª¬æ˜: {description}

      ãƒ¡ãƒˆãƒªã‚¯ã‚¹å€¤: {metric_value}
      ã‚¯ã‚¨ãƒª: {query}

      ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: https://grafana.autoforgenexus.com/d/overview
      ãƒ©ãƒ³ãƒ–ãƒƒã‚¯: https://docs.autoforgenexus.com/runbooks/{alert_name}

      ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

# å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
health_checks:
  alert_manager:
    enabled: true
    endpoint: "/health"
    interval: "30s"
    timeout: "10s"

  notification_channels:
    enabled: true
    test_interval: "1h"
    test_message: "AutoForgeNexus monitoring health check"