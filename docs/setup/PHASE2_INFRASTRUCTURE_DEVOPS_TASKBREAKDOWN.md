# AutoForgeNexus Phase 2: ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»DevOpsç’°å¢ƒæ§‹ç¯‰ è©³ç´°ã‚¿ã‚¹ã‚¯ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³

## ğŸ“‹ **æ¦‚è¦**

AutoForgeNexus AI ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®Phase 2ã€Œã‚¤ãƒ³ãƒ•ãƒ©ãƒ»DevOpsç’°å¢ƒæ§‹ç¯‰ã€ã«ãŠã‘ã‚‹ã€ã‚¤ãƒ³ãƒ•ãƒ©åŸºç›¤æ§‹ç¯‰ä½œæ¥­ã®è©³ç´°ã‚¿ã‚¹ã‚¯åˆ†è§£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚å„ã‚¿ã‚¹ã‚¯ã¯å³åº§ã«å®Ÿè¡Œå¯èƒ½ãªç²’åº¦ã§è¨­è¨ˆã•ã‚Œã€æ˜ç¢ºãªã‚³ãƒãƒ³ãƒ‰ã€æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ç›®çš„ã¨èƒŒæ™¯ã‚’å«ã‚€ã€‚

---

## ğŸ¯ **Phase 2 ç›®æ¨™**

**Dockerç’°å¢ƒã¨Cloudflareã‚¤ãƒ³ãƒ•ãƒ©åŸºç›¤ã®æ§‹ç¯‰ã«ã‚ˆã‚Šã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§ç›£è¦–å¯èƒ½ãªæœ¬ç•ªå¯¾å¿œã‚¤ãƒ³ãƒ•ãƒ©ã‚’ç¢ºç«‹ã™ã‚‹**

- Dockeré–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒã®å®Œå…¨æ§‹ç¯‰
- Cloudflareã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ çµ±åˆï¼ˆWorkers Python, Pages, R2ï¼‰
- ç’°å¢ƒåˆ†é›¢ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã®å®Ÿè£…
- ç›£è¦–ãƒ»ãƒ­ã‚°ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã®åŸºç›¤æ§‹ç¯‰
- CI/CDãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè£…å®Œæˆ
- ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ã‚¢ã‚ºãƒ»ã‚³ãƒ¼ãƒ‰ï¼ˆIaCï¼‰ã«ã‚ˆã‚‹å†ç¾å¯èƒ½ãªã‚¤ãƒ³ãƒ•ãƒ©
- ã‚¿ã‚¹ã‚¯å®Ÿè¡Œæ™‚ã«ä¸è¶³ãŒã‚ã‚Œã°ã€æœ€é©ã§æœ€æ–°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å„æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ±ºå®šã™ã‚‹

**é‡è¦**: Phase 2ã§ã¯å®Ÿéš›ã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨ã‚³ãƒ³ãƒ†ãƒŠæ§‹ç¯‰ã‚’è¡Œã†ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ãƒ»ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä½œæˆã¯Phase 3ä»¥é™ã§å®Ÿæ–½

---

## ğŸ”§ **Phase 2 å¯¾è±¡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆ**

### **ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»DevOpså°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ5ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰**
1. **devops-coordinator Agent** - ã‚¤ãƒ³ãƒ•ãƒ©çµ±æ‹¬ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œæˆã€ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–
2. **security-architect Agent** - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã€ç’°å¢ƒåˆ†é›¢ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
3. **observability-engineer Agent** - ç›£è¦–ã€ãƒ­ã‚°ã€ã‚¢ãƒ©ãƒ¼ãƒˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºç›¤
4. **edge-computing-specialist Agent** - Cloudflareçµ±åˆã€ã‚¨ãƒƒã‚¸è¨­å®šã€CDNæœ€é©åŒ–
5. **performance-optimizer Agent** - ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ãƒªã‚½ãƒ¼ã‚¹æœ€é©åŒ–ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

---

## ğŸ“‹ **äº‹å‰æº–å‚™ã‚¿ã‚¹ã‚¯**

### **Task 0.1: ã‚¤ãƒ³ãƒ•ãƒ©ãƒ„ãƒ¼ãƒ«ç¢ºèªã¨ç’°å¢ƒæº–å‚™**

**ã‚³ãƒãƒ³ãƒ‰**: `ç’°å¢ƒã‚¤ãƒ³ãƒ•ãƒ©ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **devops-coordinator Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Dockerç’°å¢ƒç¢ºèªï¼ˆ24+å¿…é ˆã€docker-composeå«ã‚€ï¼‰
- Node.js/pnpmç¢ºèªï¼ˆPhase 1ã§ç¢ºèªæ¸ˆã¿ï¼‰
- Cloudflare CLI (wrangler) ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
- å¿…è¦ãªãƒ„ãƒ¼ãƒ«è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã«å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¨ã‚µãƒ¼ãƒ“ã‚¹ã®å‰ææ¡ä»¶ç¢ºèª
- **èƒŒæ™¯**: Dockerã‚³ãƒ³ãƒ†ãƒŠåŒ–ã¨Cloudflareãƒ‡ãƒ—ãƒ­ã‚¤ã«ç‰¹åŒ–ã—ãŸãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ãŒå¿…è¦

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# ã‚¤ãƒ³ãƒ•ãƒ©ãƒ„ãƒ¼ãƒ«ç¢ºèª
echo "=== Phase 2 Infrastructure Tools Check ==="
docker --version    # >= 24.0
docker-compose --version  # >= 2.0

# Cloudflare CLIç¢ºèªãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v wrangler &> /dev/null; then
    echo "Installing Wrangler CLI..."
    npm install -g wrangler@latest
fi
wrangler --version

# è¿½åŠ ãƒ„ãƒ¼ãƒ«ç¢ºèª
curl --version     # APIç¢ºèªç”¨
jq --version || echo "jq not found - consider installing"

echo "Infrastructure tools ready âœ…"
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- å…¨ã‚¤ãƒ³ãƒ•ãƒ©ãƒ„ãƒ¼ãƒ«ç¢ºèªæ¸ˆã¿
- Cloudflare CLIæº–å‚™å®Œäº†
- Dockerç’°å¢ƒå‹•ä½œç¢ºèªæ¸ˆã¿

---

## ğŸ“ **Step 2.1: Dockerç’°å¢ƒå®Œå…¨æ§‹ç¯‰**

### **Task 2.1.1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã¨DockeråŸºç›¤ä½œæˆ**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:project-structure --ddd --docker-ready`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **devops-coordinator Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)
- **security-architect Agent** (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆ)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- DDDãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ä½œæˆï¼ˆbackend/, frontend/, infrastructure/ï¼‰
- Dockeré–¢é€£ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ
- åŸºæœ¬çš„ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é…ç½®æº–å‚™
- ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: DockeråŒ–ã«é©ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®ç¢ºç«‹ã¨ã‚¤ãƒ³ãƒ•ãƒ©åŸºç›¤ã®æº–å‚™
- **èƒŒæ™¯**: Phase 3ä»¥é™ã§ã®ã‚³ãƒ¼ãƒ‰å®Ÿè£…å‰ã«ã€é©åˆ‡ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºç›¤ãŒå¿…è¦

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æ§‹é€ ä½œæˆ
mkdir -p {backend,frontend,infrastructure,docs}
mkdir -p infrastructure/{docker,cloudflare,monitoring,scripts}
mkdir -p infrastructure/docker/{development,production}

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ DDD æ§‹é€ 
mkdir -p backend/{src,tests,migrations,scripts}
mkdir -p backend/src/{domain,application,infrastructure,presentation}
mkdir -p backend/src/domain/{entities,value_objects,repositories,services,events}
mkdir -p backend/src/application/{use_cases,services,dtos}
mkdir -p backend/src/infrastructure/{repositories,external,database}
mkdir -p backend/src/presentation/{api,schemas,middleware}

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹é€ 
mkdir -p frontend/{src,public,tests}
mkdir -p frontend/src/{app,components,lib,types}
mkdir -p frontend/src/components/{ui,features,layout}

# ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
touch .env.example
touch .env.local.example
touch .env.production.example

# åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch backend/src/__init__.py
touch frontend/src/.gitkeep

echo "Project structure created âœ…"
tree -L 3 .
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- DDDãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ å®Œæˆ
- Dockerå¯¾å¿œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
- ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåŸºç›¤

---

### **Task 2.1.2: Dockeré–‹ç™ºç’°å¢ƒæ§‹ç¯‰**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:docker-dev --multi-service --hot-reload`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **devops-coordinator Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)
- **security-architect Agent** (ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Dockerfile.devä½œæˆï¼ˆbackend: Python 3.13, frontend: Node.js 20ï¼‰
- docker-compose.dev.ymlä½œæˆï¼ˆãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆï¼‰
- ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œè¨­å®š
- é–‹ç™ºç”¨ç’°å¢ƒå¤‰æ•°è¨­å®š
- ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°æœ€é©åŒ–

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: é«˜é€Ÿã§åŠ¹ç‡çš„ãªé–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¯èƒ½ã«ã™ã‚‹Dockerç’°å¢ƒæ§‹ç¯‰
- **èƒŒæ™¯**: ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºã«ãŠã‘ã‚‹ç’°å¢ƒä¸€è²«æ€§ã¨é–‹ç™ºåŠ¹ç‡ã®ä¸¡ç«‹ãŒå¿…è¦

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# Backend Dockerfile.dev
cat > backend/Dockerfile.dev << 'EOF'
FROM python:3.13-slim

WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã¨ãƒ„ãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Pythonä¾å­˜é–¢ä¿‚
COPY requirements.txt* pyproject.toml ./
RUN pip install --no-cache-dir -r requirements.txt || \
    pip install --no-cache-dir -e .[dev] || \
    echo "No requirements file found yet"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œï¼‰
COPY . .

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000
CMD ["python", "-m", "uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
EOF

# Frontend Dockerfile.dev
cat > frontend/Dockerfile.dev << 'EOF'
FROM node:20-alpine

WORKDIR /app

# pnpmæœ‰åŠ¹åŒ–
RUN corepack enable pnpm

# ä¾å­˜é–¢ä¿‚ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–ï¼‰
COPY package*.json pnpm-lock.yaml* ./
RUN pnpm install || echo "No package.json found yet"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
COPY . .

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1

EXPOSE 3000
CMD ["pnpm", "dev"]
EOF

# docker-compose.dev.yml
cat > docker-compose.dev.yml << 'EOF'
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=sqlite:///./data/autoforge.db
      - REDIS_URL=redis://redis:6379
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-dev-secret}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-dev-public}
      - LANGFUSE_HOST=http://langfuse:3000
    volumes:
      - ./backend:/app
      - backend_data:/app/data
    depends_on:
      - redis
      - langfuse
    restart: unless-stopped
    networks:
      - autoforge-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_ENVIRONMENT=development
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - autoforge-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - autoforge-network

  langfuse:
    image: langfuse/langfuse:latest
    ports:
      - "3001:3000"
    environment:
      - DATABASE_URL=postgresql://langfuse:password@langfuse-db:5432/langfuse
      - NEXTAUTH_SECRET=your-development-secret-key-change-in-production
      - SALT=your-development-salt-change-in-production
      - NEXTAUTH_URL=http://localhost:3001
    depends_on:
      - langfuse-db
    restart: unless-stopped
    networks:
      - autoforge-network

  langfuse-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=langfuse
    volumes:
      - langfuse_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - autoforge-network

volumes:
  backend_data:
  redis_data:
  langfuse_data:

networks:
  autoforge-network:
    driver: bridge
EOF

# é–‹ç™ºç’°å¢ƒå¤‰æ•°
cat > .env.dev << 'EOF'
# Development Environment Variables
ENVIRONMENT=development

# Database
DATABASE_URL=sqlite:///./data/autoforge.db

# Redis
REDIS_URL=redis://localhost:6379

# LangFuse (Development)
LANGFUSE_SECRET_KEY=dev-secret-key
LANGFUSE_PUBLIC_KEY=dev-public-key
LANGFUSE_HOST=http://localhost:3001

# Frontend
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_ENVIRONMENT=development

# Security (Development)
CLERK_PUBLISHABLE_KEY=pk_test_dev_key_replace_in_production
CLERK_SECRET_KEY=sk_test_dev_key_replace_in_production
ENCRYPTION_KEY=dev_32_byte_key_replace_in_production
PYTHON_SERVICE_API_KEY=dev_api_key_replace_in_production
EOF

# ã‚»ã‚­ãƒ¥ã‚¢åŒ–ã•ã‚ŒãŸé–‹ç™ºç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
cat > infrastructure/scripts/setup-dev-secrets.sh << 'EOF'
#!/bin/bash
echo "ğŸ” Generating secure development secrets..."

if [ ! -f .env.local ]; then
  echo "# Development Secrets - DO NOT COMMIT" > .env.local
  echo "CLERK_PUBLISHABLE_KEY=pk_test_$(openssl rand -hex 16)" >> .env.local
  echo "CLERK_SECRET_KEY=sk_test_$(openssl rand -hex 32)" >> .env.local
  echo "ENCRYPTION_KEY=$(openssl rand -hex 32)" >> .env.local
  echo "PYTHON_SERVICE_API_KEY=$(openssl rand -hex 32)" >> .env.local
  echo "TURSO_AUTH_TOKEN=dev_token_$(openssl rand -hex 16)" >> .env.local
  echo "âœ… Development secrets generated in .env.local"
else
  echo "âœ… .env.local already exists"
fi

# .gitignore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šå¼·åŒ–
echo "# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«é™¤å¤–" >> .gitignore
echo ".env.local" >> .gitignore
echo ".env.*.local" >> .gitignore
echo "wrangler.toml.local" >> .gitignore
echo "**/secrets/" >> .gitignore
echo "**/*.pem" >> .gitignore
echo "**/*.key" >> .gitignore

echo "ğŸ”’ Security configuration updated"
EOF

chmod +x infrastructure/scripts/setup-dev-secrets.sh
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- é–‹ç™ºç”¨Dockerfileã‚»ãƒƒãƒˆ
- docker-compose.dev.ymlå®Œæˆ
- ç’°å¢ƒå¤‰æ•°è¨­å®š
- ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºç’°å¢ƒ

---

### **Task 2.1.3: Dockeræœ¬ç•ªç’°å¢ƒæ§‹ç¯‰**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:docker-prod --optimized --security-hardened`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **devops-coordinator Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)
- **security-architect Agent** (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š)
- **performance-optimizer Agent** (æœ€é©åŒ–)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Dockerfileæœ¬ç•ªç”¨ä½œæˆï¼ˆãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼‰
- docker-compose.prod.ymlä½œæˆï¼ˆæœ¬ç•ªæœ€é©åŒ–ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šå¼·åŒ–
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–è¨­å®š
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»ç›£è¦–è¨­å®š

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: æœ¬ç•ªç’°å¢ƒã«å¯¾å¿œã—ãŸã‚»ã‚­ãƒ¥ã‚¢ã§é«˜æ€§èƒ½ãªDockerç’°å¢ƒã®æ§‹ç¯‰
- **èƒŒæ™¯**: é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®è¦ä»¶å·®ç•°ã«å¯¾å¿œã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# Backend Dockerfile (æœ¬ç•ªç”¨)
cat > backend/Dockerfile << 'EOF'
# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
FROM python:3.13-slim as builder

WORKDIR /app

# ãƒ“ãƒ«ãƒ‰ä¾å­˜é–¢ä¿‚
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt pyproject.toml ./
RUN pip install --no-cache-dir --user -r requirements.txt

# æœ¬ç•ªã‚¹ãƒ†ãƒ¼ã‚¸
FROM python:3.13-slim

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# æœ€å°é™ã®ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ä¾å­˜é–¢ä¿‚ã‚³ãƒ”ãƒ¼
COPY --from=builder /root/.local /root/.local

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
COPY . .
RUN chown -R appuser:appuser /app

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER appuser

# PATHè¨­å®š
ENV PATH=/root/.local/bin:$PATH

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000
CMD ["python", "-m", "uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
EOF

# Frontend Dockerfile (æœ¬ç•ªç”¨)
cat > frontend/Dockerfile << 'EOF'
# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
FROM node:20-alpine as builder

WORKDIR /app

# pnpmæœ‰åŠ¹åŒ–
RUN corepack enable pnpm

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
COPY . .
RUN pnpm build

# æœ¬ç•ªã‚¹ãƒ†ãƒ¼ã‚¸
FROM node:20-alpine

WORKDIR /app

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/package*.json ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
EOF

# docker-compose.prod.yml
cat > docker-compose.prod.yml << 'EOF'
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST}
    volumes:
      - backend_data:/app/data
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - autoforge-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_ENVIRONMENT=production
    depends_on:
      - backend
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - autoforge-network

volumes:
  backend_data:

networks:
  autoforge-network:
    driver: bridge
EOF
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- æœ¬ç•ªç”¨Dockerfileã‚»ãƒƒãƒˆï¼ˆæœ€é©åŒ–æ¸ˆã¿ï¼‰
- docker-compose.prod.yml
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨­å®š
- ç›£è¦–ãƒ»ãƒ­ã‚°è¨­å®š

---

## ğŸ“ **Step 2.2: Cloudflareç’°å¢ƒæ§‹ç¯‰**

### **Task 2.2.1: Cloudflare Workers Pythonè¨­å®š**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:cloudflare-workers --python --fastapi`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **edge-computing-specialist Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)
- **devops-coordinator Agent** (ãƒ‡ãƒ—ãƒ­ã‚¤çµ±åˆ)
- **security-architect Agent** (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- wrangler.tomlè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- Workers Pythonç’°å¢ƒè¨­å®š
- FastAPI for Workerså¯¾å¿œè¨­å®š
- ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†è¨­å®š

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: Cloudflare Workers Pythonã‚’ä½¿ç”¨ã—ãŸã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç’°å¢ƒã®æ§‹ç¯‰
- **èƒŒæ™¯**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚¨ãƒƒã‚¸å±•é–‹ã«ã‚ˆã‚Šä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’å®Ÿç¾

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# Cloudflareè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
mkdir -p infrastructure/cloudflare/workers

# wrangler.toml (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆ)
cat > infrastructure/cloudflare/workers/wrangler.toml << 'EOF'
name = "autoforge-nexus-api"
main = "src/main.py"
compatibility_date = "2024-10-01"

# æœ¬ç•ªç’°å¢ƒè¨­å®š
[env.production]
name = "autoforge-nexus-api"
vars = { ENVIRONMENT = "production" }

# âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
[env.production.security]
cors = { origins = ["https://autoforge.nexus"], methods = ["GET", "POST", "PUT", "DELETE"] }
csp = "default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.clerk.dev;"
hsts = { max_age = 31536000, include_subdomains = true, preload = true }

# âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š
[[env.production.durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiter"

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒè¨­å®š
[env.staging]
name = "autoforge-nexus-api-staging"
vars = { ENVIRONMENT = "staging" }

[env.staging.security]
cors = { origins = ["https://staging.autoforge.nexus", "http://localhost:3000"], methods = ["GET", "POST", "PUT", "DELETE"] }
csp = "default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none';"
hsts = { max_age = 31536000, include_subdomains = true }

# é–‹ç™ºç’°å¢ƒè¨­å®š
[env.development]
name = "autoforge-nexus-api-dev"
vars = { ENVIRONMENT = "development" }

[env.development.security]
cors = { origins = ["http://localhost:3000", "http://localhost:3001"], methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"] }

# ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¨­å®š
[[env.production.r2_buckets]]
binding = "BUCKET"
bucket_name = "autoforge-nexus-storage"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "your-kv-namespace-id-here"

[[env.staging.r2_buckets]]
binding = "BUCKET"
bucket_name = "autoforge-nexus-storage-staging"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "your-staging-kv-namespace-id-here"

# ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
[build]
command = "cp -r ../../../backend/src/* ."

# è¦³æ¸¬æ€§
[observability]
enabled = true
EOF

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ
cat > infrastructure/cloudflare/setup-workers.sh << 'EOF'
#!/bin/bash
echo "ğŸ” Setting up secure Cloudflare Workers environment..."

# Wranglerèªè¨¼ç¢ºèª
if ! wrangler whoami > /dev/null 2>&1; then
    echo "âŒ Please login to Wrangler first:"
    echo "wrangler login"
    exit 1
fi

echo "âœ… Wrangler authentication confirmed"

# KV Namespaceä½œæˆ
echo "ğŸ“¦ Creating KV namespaces..."
wrangler kv:namespace create "CACHE" --env production
wrangler kv:namespace create "CACHE" --env staging

# R2 Bucketä½œæˆ
echo "ğŸª£ Creating R2 buckets..."
wrangler r2 bucket create autoforge-nexus-storage
wrangler r2 bucket create autoforge-nexus-storage-staging

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
echo "ğŸ”‘ Setting up security secrets..."
echo "Please set the following production secrets:"
echo "wrangler secret put CLERK_SECRET_KEY --env production"
echo "wrangler secret put DATABASE_URL --env production"
echo "wrangler secret put TURSO_AUTH_TOKEN --env production"
echo "wrangler secret put ENCRYPTION_KEY --env production"
echo "wrangler secret put LANGFUSE_SECRET_KEY --env production"
echo "wrangler secret put LANGFUSE_PUBLIC_KEY --env production"
echo "wrangler secret put PYTHON_SERVICE_API_KEY --env production"

echo "ğŸ”’ Staging environment secrets:"
echo "wrangler secret put CLERK_SECRET_KEY --env staging"
echo "wrangler secret put DATABASE_URL --env staging"
echo "wrangler secret put TURSO_AUTH_TOKEN --env staging"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
cat > ../../../backend/src/security/middleware.py << 'PYEOF'
"""
Cloudflare Workers Security Middleware
"""
import json
import time
from typing import Dict, Any, Optional

class SecurityMiddleware:
    @staticmethod
    def validate_request(request: Dict[str, Any], env: Dict[str, Any]) -> Dict[str, Any]:
        """âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼"""

        # CORSæ¤œè¨¼
        origin = request.get('headers', {}).get('origin')
        if not SecurityMiddleware._is_allowed_origin(origin, env.get('ALLOWED_ORIGINS', '')):
            return {'valid': False, 'error': 'CORS violation'}

        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
        client_id = SecurityMiddleware._get_client_id(request)
        if not SecurityMiddleware._check_rate_limit(client_id, env):
            return {'valid': False, 'error': 'Rate limit exceeded'}

        # Clerkèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
        auth_header = request.get('headers', {}).get('authorization', '')
        auth_result = SecurityMiddleware._validate_clerk_token(auth_header, env.get('CLERK_PUBLISHABLE_KEY'))

        return {'valid': auth_result['valid'], 'user_data': auth_result.get('user_data')}

    @staticmethod
    def _is_allowed_origin(origin: Optional[str], allowed_origins: str) -> bool:
        """âœ… CORS originæ¤œè¨¼"""
        if not origin:
            return False
        return any(origin.endswith(domain) for domain in allowed_origins.split(','))

    @staticmethod
    def _get_client_id(request: Dict[str, Any]) -> str:
        """âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDå–å¾—ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ï¼‰"""
        # IP address or user ID based identification
        return request.get('headers', {}).get('x-forwarded-for', 'unknown')

    @staticmethod
    def _check_rate_limit(client_id: str, env: Dict[str, Any]) -> bool:
        """âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆKVä½¿ç”¨ï¼‰"""
        # Implementation would use Cloudflare KV for rate limiting
        # For now, return True (implement with KV in production)
        return True

    @staticmethod
    def _validate_clerk_token(auth_header: str, clerk_key: str) -> Dict[str, Any]:
        """âœ… Clerk JWT ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼"""
        if not auth_header.startswith('Bearer '):
            return {'valid': False}

        token = auth_header[7:]
        # Implement actual JWT validation with Clerk
        # For now, basic validation
        return {'valid': len(token) > 10, 'user_data': {'user_id': 'temp'}}
PYEOF

echo "âœ… Cloudflare Workers secure setup complete!"
echo "ğŸ” Next steps:"
echo "1. Run the secret setup commands shown above"
echo "2. Update wrangler.toml with actual KV and R2 IDs"
echo "3. Test security middleware in staging environment"
EOF

chmod +x infrastructure/cloudflare/setup-workers.sh
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- wrangler.tomlè¨­å®š
- Cloudflare Workers Pythonç’°å¢ƒ
- R2ãƒ»KVè¨­å®š
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†è¨­å®š

---

### **Task 2.2.2: Cloudflare Pagesè¨­å®š**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:cloudflare-pages --nextjs --static-optimization`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **edge-computing-specialist Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Cloudflare Pagesè¨­å®š
- Next.js Static Exportæœ€é©åŒ–
- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šæº–å‚™
- CDNãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–è¨­å®š

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: Cloudflare Pagesã‚’ä½¿ç”¨ã—ãŸé«˜æ€§èƒ½ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ä¿¡ç’°å¢ƒã®æ§‹ç¯‰
- **èƒŒæ™¯**: ã‚°ãƒ­ãƒ¼ãƒãƒ«CDNã¨ã‚¨ãƒƒã‚¸æœ€é©åŒ–ã«ã‚ˆã‚‹æœ€é«˜ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä½“é¨“ã‚’æä¾›

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# Pagesè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
mkdir -p infrastructure/cloudflare/pages

# Pagesè¨­å®š
cat > infrastructure/cloudflare/pages/pages-config.json << 'EOF'
{
  "name": "autoforge-nexus-frontend",
  "production_branch": "main",
  "build_config": {
    "build_command": "pnpm build && pnpm export",
    "destination_dir": "out",
    "root_dir": "frontend"
  },
  "env_vars": {
    "NODE_VERSION": "20",
    "NEXT_PUBLIC_API_URL": "$CLOUDFLARE_WORKERS_URL"
  },
  "functions_config": {
    "compatibility_date": "2024-10-01"
  },
  "redirects": [
    {
      "source": "/api/*",
      "destination": "$CLOUDFLARE_WORKERS_URL/api/*",
      "status_code": 200
    }
  ],
  "headers": [
    {
      "source": "/*",
      "headers": {
        "X-Frame-Options": "DENY",
        "X-Content-Type-Options": "nosniff",
        "Referrer-Policy": "strict-origin-when-cross-origin",
        "Permissions-Policy": "camera=(), microphone=(), geolocation=()"
      }
    }
  ]
}
EOF

# Pages ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
cat > infrastructure/cloudflare/pages/deploy.sh << 'EOF'
#!/bin/bash
echo "Deploying to Cloudflare Pages..."

cd frontend

# ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
echo "Building optimized frontend..."
pnpm build
pnpm export

# Pages ãƒ‡ãƒ—ãƒ­ã‚¤
echo "Deploying to Pages..."
wrangler pages deploy out --project-name autoforge-nexus-frontend

echo "Frontend deployed to Cloudflare Pages!"
EOF

chmod +x infrastructure/cloudflare/pages/deploy.sh

# Next.js Pagesæœ€é©åŒ–è¨­å®š
cat > frontend/next.config.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  trailingSlash: true,
  images: {
    unoptimized: true
  },
  experimental: {
    typedRoutes: true
  },
  poweredByHeader: false,
  generateEtags: false,
  compress: true,

  // Cloudflare Pagesæœ€é©åŒ–
  assetPrefix: process.env.NODE_ENV === 'production' ? undefined : undefined,

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload'
          }
        ],
      },
    ]
  },
}

module.exports = nextConfig
EOF
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- Cloudflare Pagesè¨­å®š
- Next.jsæœ€é©åŒ–è¨­å®š
- ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–è¨­å®š

---

### **Task 2.2.3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã¨æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:security:validation --cloudflare --clerk-auth`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **security-architect Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)
- **devops-coordinator Agent** (çµ±åˆæ”¯æ´)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Clerkèªè¨¼çµ±åˆã¨MFAå¿…é ˆåŒ–è¨­å®š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šã¨CSPå¼·åŒ–
- æš—å·åŒ–éµç®¡ç†ã¨ãƒ‡ãƒ¼ã‚¿ä¿è­·å®Ÿè£…

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: Phase Aï¼ˆç„¡æ–™ï¼‰ç’°å¢ƒã«ãŠã‘ã‚‹åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºç›¤ã®ç¢ºç«‹
- **èƒŒæ™¯**: æ®µéšçš„ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# Clerkèªè¨¼è¨­å®šï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
mkdir -p frontend/src/lib/auth

cat > frontend/src/lib/auth/clerk-config.ts << 'EOF'
import { ClerkProvider } from '@clerk/nextjs';
import { dark } from '@clerk/themes';

// âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–Clerkè¨­å®š
export const clerkConfig = {
  appearance: {
    baseTheme: dark,
    signIn: {
      variables: {
        // MFAå¿…é ˆåŒ–
        forceMFA: true,
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™ï¼ˆ1æ™‚é–“ï¼‰
        sessionTimeout: 3600000,
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦è¦ä»¶
        passwordComplexity: {
          minimumLength: 12,
          requireNumbers: true,
          requireLowercase: true,
          requireUppercase: true,
          requireSpecialCharacters: true
        }
      }
    }
  },
  // âœ… çµ„ç¹”æ©Ÿèƒ½æœ‰åŠ¹åŒ–
  afterSignInUrl: "/dashboard",
  afterSignUpUrl: "/onboarding",
  // âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  afterSignOutUrl: "/",
  // âœ… çµ„ç¹”ä½œæˆåˆ¶é™
  organizationMode: "required" as const
};
EOF

# APIãƒ«ãƒ¼ãƒˆä¿è­·å®Ÿè£…
cat > frontend/src/middleware/auth.ts << 'EOF'
import { auth } from '@clerk/nextjs/server';
import { NextRequest, NextResponse } from 'next/server';

export async function authMiddleware(request: NextRequest) {
  // âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯
  const { userId, orgId } = auth();

  if (!userId) {
    return new NextResponse('Unauthorized', { status: 401 });
  }

  // âœ… çµ„ç¹”ãƒ¬ãƒ™ãƒ«èªå¯
  if (request.url.includes('/org/') && !orgId) {
    return new NextResponse('Organization membership required', { status: 403 });
  }

  // âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 
  const response = NextResponse.next();
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');

  return response;
}
EOF

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
cat > infrastructure/scripts/security-check.sh << 'EOF'
#!/bin/bash
echo "ğŸ” AutoForgeNexus ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"

ERRORS=0

# âœ… Phase A å¿…é ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
PHASE_A_SECRETS=(
  "CLERK_PUBLISHABLE_KEY"
  "CLERK_SECRET_KEY"
  "DATABASE_URL"
  "TURSO_AUTH_TOKEN"
  "ENCRYPTION_KEY"
  "PYTHON_SERVICE_API_KEY"
)

echo "ğŸ“‹ Phase A ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯:"
for secret in "${PHASE_A_SECRETS[@]}"; do
  if [ -z "${!secret}" ] && [ ! -f .env.local ]; then
    echo "âŒ Missing critical secret: $secret"
    ERRORS=$((ERRORS + 1))
  else
    echo "âœ… $secret configured"
  fi
done

# âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯
echo "ğŸ”’ ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯:"
if [ -f .env.local ]; then
  PERM=$(stat -c "%a" .env.local 2>/dev/null || stat -f "%A" .env.local 2>/dev/null)
  if [ "$PERM" != "600" ]; then
    echo "âš ï¸  .env.local permissions should be 600 (currently $PERM)"
    chmod 600 .env.local
    echo "âœ… Fixed .env.local permissions"
  else
    echo "âœ… .env.local permissions secure"
  fi
fi

# âœ… .gitignore ãƒã‚§ãƒƒã‚¯
echo "ğŸ“ .gitignore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯:"
SECURITY_IGNORES=(".env.local" ".env.*.local" "**/*.key" "**/*.pem")
for ignore in "${SECURITY_IGNORES[@]}"; do
  if ! grep -q "$ignore" .gitignore; then
    echo "âš ï¸  Missing in .gitignore: $ignore"
    echo "$ignore" >> .gitignore
    echo "âœ… Added $ignore to .gitignore"
  else
    echo "âœ… $ignore excluded from git"
  fi
done

# âœ… Cloudflareè¨­å®šãƒã‚§ãƒƒã‚¯
echo "â˜ï¸  Cloudflareè¨­å®šãƒã‚§ãƒƒã‚¯:"
if [ -f infrastructure/cloudflare/workers/wrangler.toml ]; then
  if grep -q "security" infrastructure/cloudflare/workers/wrangler.toml; then
    echo "âœ… wrangler.toml security configuration found"
  else
    echo "âŒ wrangler.toml missing security configuration"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "âŒ wrangler.toml not found"
  ERRORS=$((ERRORS + 1))
fi

# âœ… çµæœãƒ¬ãƒãƒ¼ãƒˆ
if [ $ERRORS -eq 0 ]; then
  echo "ğŸ‰ All Phase A security requirements met"
  echo "ğŸš€ Ready for Phase B security implementation"
  exit 0
else
  echo "ğŸ’¥ $ERRORS security issues found"
  echo "ğŸ”§ Please fix the issues above before proceeding"
  exit 1
fi
EOF

chmod +x infrastructure/scripts/security-check.sh

# CSPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
cat > public/_headers << 'EOF'
/*
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  Referrer-Policy: strict-origin-when-cross-origin
  Permissions-Policy: geolocation=(), camera=(), microphone=()
  Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://clerk.dev; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.clerk.dev https://clerk.dev; frame-ancestors 'none';
  Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
EOF

echo "âœ… Security configuration and validation scripts created"
echo "ğŸ” Run './infrastructure/scripts/security-check.sh' to validate security setup"
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- Clerkèªè¨¼MFAå¿…é ˆåŒ–è¨­å®š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- CSPãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
- æš—å·åŒ–ãƒ»ãƒ‡ãƒ¼ã‚¿ä¿è­·å®Ÿè£…

---

## ğŸ“ **Step 2.3: CI/CDå®Ÿè£…å®Œæˆ**

### **Task 2.3.1: GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè£…**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:cicd-deploy --cloudflare --automated`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **devops-coordinator Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)
- **security-architect Agent** (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Phase 1ã§ä½œæˆã—ãŸCD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…éƒ¨åˆ†å®Œæˆ
- Cloudflareãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…
- ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥å®Ÿè£…
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: Phase 1ã§è¨­å®šã—ãŸCI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªçŠ¶æ…‹ã«å®Œæˆ
- **èƒŒæ™¯**: å®Ÿéš›ã®ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šãŒå®Œäº†ã—ãŸãŸã‚ã€å…·ä½“çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…å¯èƒ½

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ›´æ–°ï¼ˆå®Ÿè£…ç‰ˆï¼‰
cat > .github/workflows/cd.yml << 'EOF'
name: CD - Deploy to Cloudflare

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js for Wrangler
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Deploy to Cloudflare Workers
        run: |
          cd infrastructure/cloudflare/workers
          cp -r ../../../backend/src/* .
          wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Build frontend
        run: |
          cd frontend
          pnpm build
          pnpm export
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.CLOUDFLARE_WORKERS_URL }}

      - name: Deploy to Cloudflare Pages
        run: |
          npm install -g wrangler@latest
          cd frontend
          wrangler pages deploy out --project-name autoforge-nexus-frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  health-check:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    steps:
      - name: Health Check Backend
        run: |
          sleep 30
          curl -f ${{ secrets.CLOUDFLARE_WORKERS_URL }}/health

      - name: Health Check Frontend
        run: |
          curl -f https://autoforge-nexus-frontend.pages.dev/
EOF

# ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
cat > infrastructure/scripts/deploy.sh << 'EOF'
#!/bin/bash
set -e

ENVIRONMENT=${1:-staging}
echo "Deploying to $ENVIRONMENT environment..."

case $ENVIRONMENT in
  "production")
    echo "ğŸš€ Production deployment"
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
    cd infrastructure/cloudflare/workers
    cp -r ../../../backend/src/* .
    wrangler deploy --env production

    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    cd ../../../frontend
    pnpm build && pnpm export
    wrangler pages deploy out --project-name autoforge-nexus-frontend
    ;;

  "staging")
    echo "ğŸ§ª Staging deployment"
    cd infrastructure/cloudflare/workers
    cp -r ../../../backend/src/* .
    wrangler deploy --env staging

    cd ../../../frontend
    NEXT_PUBLIC_API_URL=$STAGING_WORKERS_URL pnpm build && pnpm export
    wrangler pages deploy out --project-name autoforge-nexus-frontend-staging
    ;;

  *)
    echo "âŒ Unknown environment: $ENVIRONMENT"
    exit 1
    ;;
esac

echo "âœ… Deployment completed successfully!"
EOF

chmod +x infrastructure/scripts/deploy.sh

# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
cat > infrastructure/scripts/rollback.sh << 'EOF'
#!/bin/bash
set -e

ENVIRONMENT=${1:-staging}
VERSION=${2}

if [ -z "$VERSION" ]; then
    echo "âŒ Please specify version to rollback to"
    echo "Usage: ./rollback.sh <environment> <version>"
    exit 1
fi

echo "âª Rolling back $ENVIRONMENT to version $VERSION..."

case $ENVIRONMENT in
  "production")
    wrangler rollback --name autoforge-nexus-api $VERSION
    wrangler pages deployment tail --project-name autoforge-nexus-frontend
    ;;
  "staging")
    wrangler rollback --name autoforge-nexus-api-staging $VERSION
    wrangler pages deployment tail --project-name autoforge-nexus-frontend-staging
    ;;
esac

echo "âœ… Rollback completed!"
EOF

chmod +x infrastructure/scripts/rollback.sh
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- å®Ÿè£…æ¸ˆã¿CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
- ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

---

## ğŸ“ **Step 2.4: ç›£è¦–ãƒ»ãƒ­ã‚°åŸºç›¤æ§‹ç¯‰**

### **Task 2.4.1: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**

**ã‚³ãƒãƒ³ãƒ‰**: `/ai:infrastructure:monitoring --cloudflare --basic-alerts`

**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**:
- **observability-engineer Agent** (ãƒªãƒ¼ãƒ€ãƒ¼)

**ä½•ã‚’ã‚„ã‚‹ã®ã‹**:
- Cloudflare Analyticsè¨­å®š
- åŸºæœ¬çš„ãªã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- ãƒ­ã‚°é›†ç´„è¨­å®š
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š

**ç›®çš„ã¨èƒŒæ™¯**:
- **ç›®çš„**: ã‚µãƒ¼ãƒ“ã‚¹ã®å¥å…¨æ€§ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç›£è¦–ã™ã‚‹åŸºç›¤ã®æ§‹ç¯‰
- **èƒŒæ™¯**: å€‹äººé–‹ç™ºã§ã‚‚æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹ã®å®‰å®šé‹ç”¨ã«ã¯åŸºæœ¬çš„ãªç›£è¦–ãŒå¿…è¦

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# ç›£è¦–è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
mkdir -p infrastructure/monitoring

# Cloudflareç›£è¦–è¨­å®š
cat > infrastructure/monitoring/cloudflare-monitoring.sh << 'EOF'
#!/bin/bash
echo "Setting up Cloudflare monitoring..."

# Workers Analyticsè¨­å®š
wrangler analytics --help

# åŸºæœ¬ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ‰‹å‹•è¨­å®šã‚¬ã‚¤ãƒ‰ï¼‰
cat << 'GUIDE'
=== Cloudflare Monitoring Setup Guide ===

1. Workers Analytics:
   - Go to Cloudflare Dashboard > Workers > autoforge-nexus-api
   - Enable Analytics and Logs
   - Set up custom metrics for API endpoints

2. Pages Analytics:
   - Go to Cloudflare Dashboard > Pages > autoforge-nexus-frontend
   - Enable Web Analytics
   - Configure performance monitoring

3. Basic Alerts (via Dashboard):
   - Error rate > 5%
   - Response time > 1000ms
   - Availability < 99%

4. R2 Analytics:
   - Monitor storage usage
   - Track request patterns

GUIDE

echo "Monitoring setup guide displayed above â˜ï¸"
EOF

chmod +x infrastructure/monitoring/cloudflare-monitoring.sh

# ãƒ­ã‚°è¨­å®š
cat > infrastructure/monitoring/logging-config.json << 'EOF'
{
  "logLevel": "info",
  "structuredLogging": true,
  "outputs": [
    {
      "type": "console",
      "format": "json"
    },
    {
      "type": "cloudflare",
      "format": "json",
      "fields": [
        "timestamp",
        "level",
        "message",
        "requestId",
        "userId",
        "action",
        "duration",
        "error"
      ]
    }
  ],
  "filters": {
    "health": false,
    "static": false
  }
}
EOF

# åŸºæœ¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIå®Ÿè£…
cat > backend/src/monitoring.py << 'EOF'
"""
Basic monitoring and health check implementation
"""
import time
import psutil
from datetime import datetime
from typing import Dict, Any


def get_health_status() -> Dict[str, Any]:
    """ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "version": "0.1.0",
        "service": "autoforge-nexus-backend",
        "uptime": get_uptime(),
        "resources": get_resource_usage()
    }


def get_uptime() -> float:
    """ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ å–å¾—ï¼ˆç§’ï¼‰"""
    return time.time() - psutil.boot_time()


def get_resource_usage() -> Dict[str, Any]:
    """ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³"""
    return {
        "cpu_percent": psutil.cpu_percent(),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_percent": psutil.disk_usage('/').percent
    }


def log_request(request_id: str, endpoint: str, duration: float, status: int):
    """æ§‹é€ åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°"""
    log_data = {
        "timestamp": datetime.utcnow().isoformat(),
        "requestId": request_id,
        "endpoint": endpoint,
        "duration": duration,
        "status": status,
        "level": "info" if status < 400 else "error"
    }
    print(f"REQUEST_LOG: {log_data}")


def log_error(error: Exception, context: Dict[str, Any] = None):
    """ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°"""
    log_data = {
        "timestamp": datetime.utcnow().isoformat(),
        "level": "error",
        "error": str(error),
        "error_type": type(error).__name__,
        "context": context or {}
    }
    print(f"ERROR_LOG: {log_data}")
EOF
```

**æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©**:
- Cloudflareç›£è¦–è¨­å®š
- æ§‹é€ åŒ–ãƒ­ã‚°è¨­å®š
- åŸºæœ¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…
- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚¬ã‚¤ãƒ‰

---

## ğŸ”„ **ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé †åºã¨ä¾å­˜é–¢ä¿‚**

### **ãƒ•ã‚§ãƒ¼ã‚º1: äº‹å‰æº–å‚™**
- **Task 0.1**: ã‚¤ãƒ³ãƒ•ãƒ©ãƒ„ãƒ¼ãƒ«ç¢ºèªï¼ˆä¸¦åˆ—å®Ÿè¡Œä¸å¯ãƒ»æœ€å„ªå…ˆï¼‰

### **ãƒ•ã‚§ãƒ¼ã‚º2: Dockerç’°å¢ƒæ§‹ç¯‰**
- **Task 2.1.1**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã¨DockeråŸºç›¤ä½œæˆ
- **Task 2.1.2**: Dockeré–‹ç™ºç’°å¢ƒæ§‹ç¯‰ï¼ˆTask 2.1.1å®Œäº†å¾Œï¼‰
- **Task 2.1.3**: Dockeræœ¬ç•ªç’°å¢ƒæ§‹ç¯‰ï¼ˆTask 2.1.2å®Œäº†å¾Œãƒ»ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ï¼‰

### **ãƒ•ã‚§ãƒ¼ã‚º3: Cloudflareç’°å¢ƒæ§‹ç¯‰**
- **Task 2.2.1**: Cloudflare Workers Pythonè¨­å®šï¼ˆDockeræ§‹ç¯‰å®Œäº†å¾Œï¼‰
- **Task 2.2.2**: Cloudflare Pagesè¨­å®šï¼ˆTask 2.2.1å®Œäº†å¾Œãƒ»ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ï¼‰
- **Task 2.2.3**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã¨æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆTask 2.2.1å®Œäº†å¾Œãƒ»ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ï¼‰

### **ãƒ•ã‚§ãƒ¼ã‚º4: CI/CDãƒ»ç›£è¦–å®Œæˆ**
- **Task 2.3.1**: GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè£…ï¼ˆCloudflareè¨­å®šå®Œäº†å¾Œï¼‰
- **Task 2.4.1**: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šï¼ˆå…¨ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œãƒ»ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ï¼‰

---

## âœ… **Phase 2 ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **Dockerç’°å¢ƒå®Œäº†ç¢ºèª**
- [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ä½œæˆå®Œäº†ï¼ˆ`tree -L 3 .`ï¼‰
- [ ] Dockeré–‹ç™ºç’°å¢ƒå‹•ä½œç¢ºèªï¼ˆ`docker-compose -f docker-compose.dev.yml up -d`ï¼‰
- [ ] Dockeræœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰ç¢ºèªï¼ˆ`docker-compose -f docker-compose.prod.yml build`ï¼‰
- [ ] ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹é€£æºç¢ºèªï¼ˆbackend, frontend, redis, langfuseï¼‰
- [ ] ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ç¢ºèª
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å‹•ä½œç¢ºèª

### **Cloudflareç’°å¢ƒå®Œäº†ç¢ºèª**
- [ ] Wrangler CLIèªè¨¼ç¢ºèªï¼ˆ`wrangler whoami`ï¼‰
- [ ] Workersè¨­å®šç¢ºèªï¼ˆ`wrangler.toml`ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæ¸ˆã¿ï¼‰
- [ ] Pagesè¨­å®šç¢ºèªï¼ˆbuildãƒ»deployè¨­å®šæ¸ˆã¿ï¼‰
- [ ] R2ãƒã‚±ãƒƒãƒˆä½œæˆç¢ºèª
- [ ] KVãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç¢ºèª
- [ ] ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®šç¢ºèª
- [ ] CORSãƒ»CSPãƒ»HSTSè¨­å®šç¢ºèª
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ç¢ºèª

### **CI/CDå®Œäº†ç¢ºèª**
- [ ] CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè£…ç¢ºèª
- [ ] ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‹•ä½œç¢ºèª
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ç¢ºèª
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è‡ªå‹•åŒ–ç¢ºèª
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œç¢ºèªè‡ªå‹•åŒ–

### **ç›£è¦–ãƒ»ãƒ­ã‚°å®Œäº†ç¢ºèª**
- [ ] Cloudflare Analyticsè¨­å®šç¢ºèª
- [ ] æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›ç¢ºèª
- [ ] åŸºæœ¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIå®Ÿè£…ç¢ºèª
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚¬ã‚¤ãƒ‰ä½œæˆç¢ºèª

### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šå®Œäº†ç¢ºèª**
- [ ] Clerkèªè¨¼MFAå¿…é ˆåŒ–ç¢ºèª
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‹•ä½œç¢ºèª
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šç¢ºèª
- [ ] æš—å·åŒ–éµç®¡ç†ç¢ºèª
- [ ] .gitignoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é™¤å¤–ç¢ºèª
- [ ] é–‹ç™ºç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”Ÿæˆç¢ºèª

### **ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»DevOpsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
- [ ] Dockerç’°å¢ƒæ§‹ç¯‰æ‰‹é †æ›¸ä½œæˆ
- [ ] Cloudflareè¨­å®šæ‰‹é †æ›¸ä½œæˆ
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸ä½œæˆ
- [ ] ç›£è¦–ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ä½œæˆ
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆ
- [ ] ç’°å¢ƒå¤‰æ•°ç®¡ç†ã‚¬ã‚¤ãƒ‰ä½œæˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒ»æ¤œè¨¼ã‚¬ã‚¤ãƒ‰ä½œæˆ

---

## ğŸ“Š **ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒæˆåŠŸæŒ‡æ¨™ï¼ˆPhase 2ï¼‰**

### **Dockerç’°å¢ƒå“è³ªæŒ‡æ¨™**
- **ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚é–“**: 60ç§’ä»¥å†…ï¼ˆå…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å®Œäº†ï¼‰
- **ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¿œç­”**: 3ç§’ä»¥å†…ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´åæ˜ ï¼‰
- **ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨åŠ¹ç‡**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡2GBä»¥ä¸‹ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸç‡**: 100%ï¼ˆå…¨ã‚µãƒ¼ãƒ“ã‚¹æ­£å¸¸å¿œç­”ï¼‰

### **Cloudflareçµ±åˆå“è³ªæŒ‡æ¨™**
- **Workers ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: 30ç§’ä»¥å†…
- **Pages ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: 120ç§’ä»¥å†…
- **ã‚¨ãƒƒã‚¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 100msä»¥ä¸‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¹³å‡ï¼‰
- **CDN ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡**: 85%ä»¥ä¸Š

### **CI/CDè‡ªå‹•åŒ–å“è³ªæŒ‡æ¨™**
- **ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡**: 98%ä»¥ä¸Š
- **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: 5åˆ†ä»¥å†…ï¼ˆãƒ•ãƒ« ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
- **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚é–“**: 2åˆ†ä»¥å†…
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è‡ªå‹•åŒ–**: 100%ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œç¢ºèªï¼‰

### **ç›£è¦–ãƒ»é‹ç”¨å“è³ªæŒ‡æ¨™**
- **ãƒ­ã‚°å¯è¦–æ€§**: æ§‹é€ åŒ–ãƒ­ã‚°100%å¯¾å¿œ
- **ã‚¢ãƒ©ãƒ¼ãƒˆå¿œç­”æ™‚é–“**: 5åˆ†ä»¥å†…ï¼ˆé‡è¦ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
- **ç¨¼åƒæ™‚é–“ç›®æ¨™**: 99.9%ï¼ˆæœˆé–“ï¼‰
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—

---

## ğŸ¯ **Phase 3ã¸ã®ã‚¤ãƒ³ãƒ•ãƒ©åŸºç›¤æº–å‚™å®Œäº†**

Phase 2 ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»DevOpsç’°å¢ƒæ§‹ç¯‰å®Œäº†å¾Œã€ä»¥ä¸‹ã®ç¢ºèªã§Phase 3ã¸é€²ã‚€ï¼š

### **ã‚¤ãƒ³ãƒ•ãƒ©åŸºç›¤ç¢ºèªã‚³ãƒãƒ³ãƒ‰**
```bash
# å…¨ä½“ã‚¤ãƒ³ãƒ•ãƒ©ç¢ºèª
echo "=== Phase 2 Infrastructure Check ==="
echo "Docker: $(docker --version)"
echo "Docker Compose: $(docker-compose --version)"
echo "Wrangler: $(wrangler --version)"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª
echo "=== Project Structure ==="
tree -L 3 .

# Dockerç’°å¢ƒç¢ºèª
echo "=== Docker Environment ==="
docker-compose -f docker-compose.dev.yml config --quiet && echo "âœ… Dev config valid"
docker-compose -f docker-compose.prod.yml config --quiet && echo "âœ… Prod config valid"

# Cloudflareè¨­å®šç¢ºèª
echo "=== Cloudflare Configuration ==="
ls -la infrastructure/cloudflare/workers/wrangler.toml && echo "âœ… Workers config exists"
ls -la infrastructure/cloudflare/pages/pages-config.json && echo "âœ… Pages config exists"

# CI/CDç¢ºèª
echo "=== CI/CD Pipeline ==="
ls -la .github/workflows/cd.yml && echo "âœ… CD workflow exists"
ls -la infrastructure/scripts/deploy.sh && echo "âœ… Deploy script exists"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
echo "=== Security Validation ==="
if [ -f infrastructure/scripts/security-check.sh ]; then
  ./infrastructure/scripts/security-check.sh
else
  echo "âŒ Security check script not found"
fi

# ç›£è¦–è¨­å®šç¢ºèª
echo "=== Monitoring Setup ==="
ls -la infrastructure/monitoring/ && echo "âœ… Monitoring config exists"

echo "Phase 2 Infrastructure Complete! âœ… Ready for Phase 3"
echo "Next: Phase 3 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç’°å¢ƒæ§‹ç¯‰'"
```

**Phase 2 ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»DevOpsç’°å¢ƒæ§‹ç¯‰å®Œäº†ã®ç¢ºèªãŒå–ã‚Œã¾ã—ãŸã‚‰ã€Phase 3ã€Œãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç’°å¢ƒæ§‹ç¯‰ã€ã®è©³ç´°ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’å®Ÿè¡Œã„ãŸã—ã¾ã™ã€‚**