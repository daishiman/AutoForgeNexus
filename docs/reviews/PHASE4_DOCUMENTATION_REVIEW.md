# Phase 4 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒæ§‹ç¯‰ - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼

## ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¦‚è¦

- **ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥**: 2025å¹´10æœˆ1æ—¥
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: Phase 4ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒæ§‹ç¯‰ï¼‰ã®å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼è€…**: ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ©ã‚¤ã‚¿ãƒ¼ï¼ˆAI Agentï¼‰
- **å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0.0

---

## ğŸ¯ ç·åˆè©•ä¾¡

### ç·åˆã‚¹ã‚³ã‚¢: **88/100 (EXCELLENT - æœ¬ç•ªç’°å¢ƒä½¿ç”¨å¯èƒ½)**

| è©•ä¾¡é …ç›®         | ã‚¹ã‚³ã‚¢ | è©•ä¾¡      |
| ---------------- | ------ | --------- |
| å®Œå…¨æ€§           | 92/100 | EXCELLENT |
| æ­£ç¢ºæ€§           | 95/100 | EXCELLENT |
| æ˜ç¢ºæ€§           | 85/100 | GOOD      |
| ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ | 80/100 | GOOD      |
| ä¿å®ˆæ€§           | 88/100 | EXCELLENT |

### âœ… å¼·ã¿

1. **åŒ…æ‹¬çš„ãªã‚«ãƒãƒ¬ãƒƒã‚¸**: 1,979è¡Œã®è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
2. **æ®µéšçš„å®Ÿè¡Œæ‰‹é †**: Phase 4-1ï½4-7ã¾ã§æ˜ç¢ºã«åˆ†å‰²
3. **å®Ÿè·µçš„ãªã‚³ãƒãƒ³ãƒ‰**: ã™ã¹ã¦ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆå¯èƒ½
4. **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: 6ã¤ã®ä¸»è¦ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…
5. **DDDæº–æ‹ ã®è¨­è¨ˆ**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨å®Œå…¨æ•´åˆ
6. **Docker/ãƒ›ã‚¹ãƒˆåˆ†é›¢**: å®Ÿè¡Œç’°å¢ƒã®æ˜ç¢ºãªæŒ‡ç¤º

### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªé ˜åŸŸ

1. **ã‚³ãƒ¼ãƒ‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: Docstringä¸è¶³ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¨å®š40%ï¼‰
2. **APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: OpenAPIä»•æ§˜æœªä½œæˆ
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¬ã‚¤ãƒ‰**: ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹é †ä¸è¶³
4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: è„…å¨ãƒ¢ãƒ‡ãƒ«æœªè¨˜è¼‰
5. **ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¦ç´ **: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ãŒä¸è¶³

---

## ğŸ“š 1. DATABASE_SETUP_GUIDE.md å®Œå…¨æ€§è©•ä¾¡

### ã‚¹ã‚³ã‚¢: 92/100

### âœ… å®Œå‚™ã—ã¦ã„ã‚‹é …ç›®

#### ç’°å¢ƒæ§‹ç¯‰æ‰‹é †ï¼ˆ100%å®Œå‚™ï¼‰

- [x] **Phase 4-1**: AlembicåˆæœŸåŒ–ï¼ˆè©³ç´°åº¦: å„ªç§€ï¼‰
  - Dockerç’°å¢ƒã§ã®ä½œæ¥­ãƒ•ãƒ­ãƒ¼æ˜è¨˜
  - alembic.iniè¨­å®šä¾‹å®Œå‚™
  - env.pyå®Ÿè£…ã‚³ãƒ¼ãƒ‰å…¨æ–‡æ²è¼‰
- [x] **Phase 4-2**: Tursoãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆï¼ˆè©³ç´°åº¦: å„ªç§€ï¼‰
  - èªè¨¼æ‰‹é †ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ï¼‰
  - Staging/Productionç’°å¢ƒåˆ†é›¢
  - ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- [x] **Phase 4-3**: ç’°å¢ƒå¤‰æ•°ç®¡ç†ï¼ˆè©³ç´°åº¦: å„ªç§€ï¼‰
  - 3ç’°å¢ƒï¼ˆLocal/Staging/Productionï¼‰å®Œå…¨å¯¾å¿œ
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
  - GitHub Secretsçµ±åˆæ‰‹é †
- [x] **Phase 4-4**: ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆè©³ç´°åº¦: è‰¯å¥½ï¼‰
  - DDDæº–æ‹ ã®æ©Ÿèƒ½ãƒ™ãƒ¼ã‚¹é…ç½®
  - Base/Mixinå®Ÿè£…ã‚³ãƒ¼ãƒ‰
  - 2ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆPrompt/Evaluationï¼‰
- [x] **Phase 4-5**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè©³ç´°åº¦: å„ªç§€ï¼‰
  - è‡ªå‹•ç”Ÿæˆæ‰‹é †
  - 3ç’°å¢ƒã¸ã®é©ç”¨æ–¹æ³•
  - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
- [x] **Phase 4-6**: æ¥ç¶šç¢ºèªï¼ˆè©³ç´°åº¦: è‰¯å¥½ï¼‰
  - çµ±åˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å…¨æ–‡
  - ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèªæ‰‹é †
  - æ‰‹å‹•æ¤œè¨¼æ–¹æ³•
- [x] **Phase 4-7**: GitHub Secretsï¼ˆè©³ç´°åº¦: å„ªç§€ï¼‰
  - 10å€‹ã®Secretsç™»éŒ²æ‰‹é †
  - CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè£…ä¾‹
  - envsubstç½®æ›ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆ85%å®Œå‚™ï¼‰

- [x] `alembic: command not found`
- [x] `ModuleNotFoundError: No module named 'src'`
- [x] `Turso authentication failed`
- [x] `Target database is not up to date`
- [x] `Redis connection refused`
- [x] `libsql_client not found`

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£èª¬æ˜ï¼ˆ90%å®Œå‚™ï¼‰

- [x] å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ï¼ˆASCIIï¼‰
- [x] ç’°å¢ƒåˆ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æˆ¦ç•¥
- [x] DDDå¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- [x] æ©Ÿèƒ½ãƒ™ãƒ¼ã‚¹é…ç½®ã®ç†ç”±

### âš ï¸ ä¸è¶³ã—ã¦ã„ã‚‹é …ç›®

#### è¿½åŠ ãŒå¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°** (Priority: HIGH)

   ```markdown
   ## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

   ### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

   - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨­è¨ˆæŒ‡é‡
   - ã‚«ãƒãƒªãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ´»ç”¨
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹æœã®æ¸¬å®šæ–¹æ³•

   ### ã‚¯ã‚¨ãƒªæœ€é©åŒ–

   - N+1å•é¡Œã®å›é¿æ–¹æ³•
   - Eager Loading vs Lazy Loading
   - ãƒãƒƒãƒã‚¯ã‚¨ãƒªã®å®Ÿè£…

   ### æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š

   - pool_size, max_overflowèª¿æ•´
   - æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
   - ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯å¯¾ç­–
   ```

2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒªæ‰‹é †** (Priority: HIGH)

   ````markdown
   ## ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

   ### Tursoè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

   ```bash
   # æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š
   turso db replicate autoforgenexus-production --region nrt

   # ãƒªã‚«ãƒãƒªæ‰‹é †
   turso db restore autoforgenexus-production --from-backup <backup-id>
   ```
   ````

   ### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

   ```bash
   # SQLiteãƒ€ãƒ³ãƒ—
   sqlite3 data/autoforge_dev.db .dump > backup.sql

   # ãƒªã‚¹ãƒˆã‚¢
   sqlite3 data/autoforge_dev_restored.db < backup.sql
   ```

   ```

   ```

3. **ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š** (Priority: MEDIUM)

   ````markdown
   ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–

   ### Tursoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

   - ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
   - æ¥ç¶šæ•°ãƒ»å¸¯åŸŸå¹…è¿½è·¡
   - ã‚¨ãƒ©ãƒ¼ç‡ã‚¢ãƒ©ãƒ¼ãƒˆ

   ### ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹

   ```python
   from prometheus_client import Counter, Histogram

   db_query_duration = Histogram('db_query_duration_seconds', 'Database query duration')
   db_errors = Counter('db_errors_total', 'Database errors')
   ```
   ````

   ```

   ```

4. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥** (Priority: MEDIUM)

   ```markdown
   ## æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥

   ### ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

   1. **å¾Œæ–¹äº’æ›æ€§ã®ã‚ã‚‹å¤‰æ›´**: ã‚«ãƒ©ãƒ è¿½åŠ ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
   2. **æ®µéšçš„ãªã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:
      - Phase 1: æ–°ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆNULLè¨±å¯ï¼‰
      - Phase 2: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
      - Phase 3: NOT NULLåˆ¶ç´„è¿½åŠ 
   3. **ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œ**

   ### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

   - å„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«downgradeå®Ÿè£…å¿…é ˆ
   - æœ¬ç•ªé©ç”¨å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§æ¤œè¨¼
   - ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯ã®äº‹å‰è©•ä¾¡
   ```

---

## ğŸ’» 2. ã‚³ãƒ¼ãƒ‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡

### ã‚¹ã‚³ã‚¢: 65/100 (æ”¹å–„ãŒå¿…è¦)

### âœ… è‰¯å¥½ãªç®‡æ‰€

#### infrastructure/shared/database/base.py

```python
class Base(DeclarativeBase):
    """
    ã™ã¹ã¦ã®SQLAlchemyãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹

    Usage:
        from src.infrastructure.shared.database.base import Base

        class PromptModel(Base):
            __tablename__ = "prompts"
            ...
    """
```

**è©•ä¾¡**: EXCELLENT - ä½¿ç”¨ä¾‹ä»˜ãã€æ˜ç¢ºãªç›®çš„èª¬æ˜

#### infrastructure/prompt/models/prompt_model.py

```python
class PromptModel(Base, TimestampMixin, SoftDeleteMixin):
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

    é›†ç´„ãƒ«ãƒ¼ãƒˆ: Prompt Aggregate
    è²¬å‹™: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
    """
```

**è©•ä¾¡**: GOOD - DDDç”¨èªã¨è²¬å‹™ãŒæ˜ç¢º

### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªç®‡æ‰€

#### 1. infrastructure/shared/database/turso_connection.py

**ç¾çŠ¶ã®å•é¡Œç‚¹**:

```python
def get_connection_url(self) -> str:
    """Get appropriate database URL based on environment"""
    # å®Ÿè£…ã®ã¿ã§ã€è©³ç´°ãªèª¬æ˜ãªã—
```

**æ”¹å–„ææ¡ˆ**:

```python
def get_connection_url(self) -> str:
    """
    ç’°å¢ƒã«å¿œã˜ãŸé©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURLã‚’å–å¾—

    ç’°å¢ƒåˆ¤å®š:
        - production: TURSO_DATABASE_URL + TURSO_AUTH_TOKEN
        - staging: TURSO_STAGING_DATABASE_URL + TURSO_STAGING_AUTH_TOKEN
        - local: SQLiteãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ./data/autoforge_dev.dbï¼‰

    Returns:
        str: SQLAlchemyæ¥ç¶šURLï¼ˆèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å«ã‚€ï¼‰

    Raises:
        ValueError: production/stagingç’°å¢ƒã§èªè¨¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ

    Examples:
        >>> conn = TursoConnection()
        >>> url = conn.get_connection_url()
        >>> print(url)
        'sqlite:///./data/autoforge_dev.db'  # localç’°å¢ƒ
        'libsql://autoforgenexus-prod-xxx.turso.io?authToken=eyJ...'  # production

    Note:
        ç’°å¢ƒå¤‰æ•°APP_ENVã§ç’°å¢ƒã‚’åˆ¤å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: localï¼‰
    """
```

#### 2. alembic/env.py

**ç¾çŠ¶ã®å•é¡Œç‚¹**:

```python
def run_migrations_online() -> None:
    """ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"""
    # å‡¦ç†ã®è©³ç´°èª¬æ˜ãªã—
```

**æ”¹å–„ææ¡ˆ**:

```python
def run_migrations_online() -> None:
    """
    ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ç¢ºç«‹ã—ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¾ã™ã€‚

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
        1. alembic.iniã‹ã‚‰ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã‚’èª­ã¿è¾¼ã¿
        2. ç’°å¢ƒã«å¿œã˜ãŸDB URLã‚’å‹•çš„ã«è¨­å®š
        3. NullPoolã§ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨æœ€é©åŒ–ï¼‰
        4. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
        5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
        6. ã‚³ãƒŸãƒƒãƒˆ

    ä½¿ç”¨ã•ã‚Œã‚‹ç’°å¢ƒå¤‰æ•°:
        - APP_ENV: ç’°å¢ƒè­˜åˆ¥ï¼ˆlocal/staging/productionï¼‰
        - TURSO_*: Tursoæ¥ç¶šæƒ…å ±ï¼ˆstaging/productionæ™‚ï¼‰
        - DATABASE_URL: SQLiteæ¥ç¶šæƒ…å ±ï¼ˆlocalæ™‚ï¼‰

    Note:
        - NullPoolã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®æ¥ç¶šãƒ—ãƒ¼ãƒ«å•é¡Œã‚’å›é¿
        - context.is_offline_mode()ãŒFalseã®å ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹
    """
```

#### 3. ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…ã®æ¬ å¦‚

**å•é¡Œ**: `infrastructure/prompt/repositories/` ãŒæœªå®Ÿè£…

**æ”¹å–„ææ¡ˆ**: ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨CRUDå®Ÿè£…ã‚’è¿½åŠ 

```python
# domain/prompt/repositories/prompt_repository.py
from abc import ABC, abstractmethod
from typing import Optional

class PromptRepository(ABC):
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

    DDDåŸå‰‡:
        - ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã«é…ç½®ï¼ˆå®Ÿè£…ã¯ã‚¤ãƒ³ãƒ•ãƒ©å±¤ï¼‰
        - é›†ç´„ãƒ«ãƒ¼ãƒˆï¼ˆPromptï¼‰ã®æ°¸ç¶šåŒ–ã‚’æ‹…å½“
        - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ã®è©³ç´°ã‚’éš è”½

    å®Ÿè£…ã‚¯ãƒ©ã‚¹:
        src.infrastructure.prompt.repositories.turso_prompt_repository.TursoPromptRepository
    """

    @abstractmethod
    async def save(self, prompt: Prompt) -> None:
        """
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜

        Args:
            prompt: ä¿å­˜å¯¾è±¡ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé›†ç´„

        Raises:
            RepositoryError: ä¿å­˜å¤±æ•—æ™‚
        """
        pass

    @abstractmethod
    async def find_by_id(self, prompt_id: PromptId) -> Optional[Prompt]:
        """
        IDã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—

        Args:
            prompt_id: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆID

        Returns:
            Promptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã¯None
        """
        pass
```

### Docstringã‚«ãƒãƒ¬ãƒƒã‚¸æ¨å®š

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«                                           | ã‚«ãƒãƒ¬ãƒƒã‚¸ | è©•ä¾¡                  |
| ---------------------------------------------------- | ---------- | --------------------- |
| `infrastructure/shared/database/base.py`             | 85%        | GOOD                  |
| `infrastructure/prompt/models/`                      | 70%        | ACCEPTABLE            |
| `infrastructure/evaluation/models/`                  | 70%        | ACCEPTABLE            |
| `infrastructure/shared/database/turso_connection.py` | 30%        | POOR                  |
| `alembic/env.py`                                     | 40%        | POOR                  |
| **å…¨ä½“å¹³å‡**                                         | **59%**    | **NEEDS IMPROVEMENT** |

**ç›®æ¨™**: 80%ä»¥ä¸Šï¼ˆæœ¬ç•ªç’°å¢ƒå“è³ªåŸºæº–ï¼‰

---

## ğŸ“– 3. API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæº–å‚™çŠ¶æ³

### ã‚¹ã‚³ã‚¢: 20/100 (æœªå®Ÿè£…)

### âŒ ä¸è¶³ã—ã¦ã„ã‚‹é …ç›®

1. **OpenAPIä»•æ§˜æ›¸**: æœªä½œæˆ
2. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: æœªä½œæˆ
3. **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**: æœªä½œæˆ
4. **ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä¸€è¦§**: æœªä½œæˆ

### ğŸ“ æ¨å¥¨ã•ã‚Œã‚‹å®Ÿè£…

#### OpenAPIä»•æ§˜ã®è‡ªå‹•ç”Ÿæˆ

**backend/src/main.py**:

```python
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

app = FastAPI(
    title="AutoForgeNexus Backend API",
    description="AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ  - Phase 4: Database Layer",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_url="/openapi.json"
)

def custom_openapi():
    """
    ã‚«ã‚¹ã‚¿ãƒ OpenAPIä»•æ§˜ç”Ÿæˆ

    DDDå¢ƒç•Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã”ã¨ã«ã‚¿ã‚°ä»˜ã‘
    """
    if app.openapi_schema:
        return app.openapi_schema

    openapi_schema = get_openapi(
        title="AutoForgeNexus API",
        version="1.0.0",
        description="""
        ## å¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

        ### Prompt Context
        - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤
        - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

        ### Evaluation Context
        - è©•ä¾¡å®Ÿè¡Œãƒ»çµæœå–å¾—
        - ãƒ¡ãƒˆãƒªã‚¯ã‚¹åˆ†æ
        """,
        routes=app.routes,
    )

    # ã‚¿ã‚°ã®å®šç¾©
    openapi_schema["tags"] = [
        {
            "name": "prompts",
            "description": "Prompt Aggregateæ“ä½œ",
            "externalDocs": {
                "description": "DDDè¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ",
                "url": "https://github.com/daishiman/AutoForgeNexus/docs/architecture/prompt_context.md"
            }
        },
        {
            "name": "evaluations",
            "description": "Evaluation Aggregateæ“ä½œ"
        }
    ]

    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi
```

#### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¾‹

**backend/src/presentation/api/v1/prompt/endpoints.py**:

```python
from fastapi import APIRouter, Depends, HTTPException, status
from typing import List

router = APIRouter(prefix="/prompts", tags=["prompts"])

@router.post(
    "/",
    response_model=PromptResponse,
    status_code=status.HTTP_201_CREATED,
    summary="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ",
    description="""
    æ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

    ## å‡¦ç†ãƒ•ãƒ­ãƒ¼
    1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®æ¤œè¨¼ï¼ˆPydanticï¼‰
    2. CreatePromptCommandã®ç”Ÿæˆ
    3. ã‚³ãƒãƒ³ãƒ‰ãƒã‚¹çµŒç”±ã§å‡¦ç†
    4. PromptCreatedã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

    ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    - Clerk JWTèªè¨¼å¿…é ˆ
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªèº«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿ä½œæˆå¯èƒ½
    """,
    responses={
        201: {
            "description": "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆæˆåŠŸ",
            "content": {
                "application/json": {
                    "example": {
                        "id": "550e8400-e29b-41d4-a716-446655440000",
                        "title": "å•†å“èª¬æ˜æ–‡ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ",
                        "content": "ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰é­…åŠ›çš„ãªèª¬æ˜æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„...",
                        "status": "draft",
                        "version": 1,
                        "created_at": "2025-10-01T12:00:00Z"
                    }
                }
            }
        },
        400: {"description": "ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼"},
        401: {"description": "èªè¨¼ã‚¨ãƒ©ãƒ¼"},
        500: {"description": "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"}
    }
)
async def create_prompt(
    request: CreatePromptRequest,
    user_id: str = Depends(get_current_user_id)
) -> PromptResponse:
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    Args:
        request: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        user_id: èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆClerkã‹ã‚‰å–å¾—ï¼‰

    Returns:
        ä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è©³ç´°

    Raises:
        HTTPException: ä½œæˆå¤±æ•—æ™‚ï¼ˆ400, 401, 500ï¼‰
    """
    # å®Ÿè£…...
```

---

## ğŸ§ª 4. ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

### ã‚¹ã‚³ã‚¢: 70/100

### âœ… è‰¯å¥½ãªç®‡æ‰€

#### çµ±åˆãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§

**tests/integration/test_database_connection.py** (DATABASE_SETUP_GUIDE.mdå†…):

```python
class TestDatabaseConnection:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ"""

    def test_get_connection_url(self):
        """æ¥ç¶šURLå–å¾—ãƒ†ã‚¹ãƒˆ"""
        # ç’°å¢ƒåˆ¥URLå½¢å¼ã®æ¤œè¨¼

    def test_database_session(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ãƒ†ã‚¹ãƒˆ"""
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã¨åŸºæœ¬ã‚¯ã‚¨ãƒªå®Ÿè¡Œ

    def test_tables_exist(self):
        """ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèªãƒ†ã‚¹ãƒˆ"""
        # 5ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨æ¤œè¨¼

    def test_crud_operations(self):
        """åŸºæœ¬çš„ãªCRUDæ“ä½œãƒ†ã‚¹ãƒˆ"""
        # Create, Read, Update, Deleteæ¤œè¨¼

    def test_relationships(self):
        """ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ"""
        # Prompt-Evaluationé–¢ä¿‚ã®æ¤œè¨¼
```

**è©•ä¾¡**: EXCELLENT - DDDå¢ƒç•Œã‚’å°Šé‡ã—ãŸãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªç®‡æ‰€

#### 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸è¶³

**å•é¡Œ**: å€‹åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãŒæœªè¨˜è¼‰

**æ”¹å–„ææ¡ˆ**:

````markdown
## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼

#### ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 90%+ï¼‰

```python
# tests/unit/domain/prompt/test_prompt_entity.py
def test_prompt_create_with_valid_data():
    """æ­£å¸¸ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ"""
    prompt = Prompt.create(
        title="Test Prompt",
        content="Test content",
        user_id=UserId("user-123")
    )
    assert prompt.title.value == "Test Prompt"

def test_prompt_create_with_empty_title_raises_error():
    """ã‚¿ã‚¤ãƒˆãƒ«ç©ºç™½æ™‚ã«ã‚¨ãƒ©ãƒ¼"""
    with pytest.raises(ValidationError):
        Prompt.create(title="", content="...", user_id=...)
```
````

#### ã‚¤ãƒ³ãƒ•ãƒ©å±¤ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 80%+ï¼‰

```python
# tests/unit/infrastructure/test_turso_connection.py
@pytest.fixture
def mock_turso_client(monkeypatch):
    """Tursoã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¢ãƒƒã‚¯"""
    mock_client = MagicMock()
    monkeypatch.setattr("libsql_client.create_client", lambda **k: mock_client)
    return mock_client

def test_get_connection_url_production(mock_env):
    """æœ¬ç•ªç’°å¢ƒURLå–å¾—"""
    mock_env("APP_ENV", "production")
    mock_env("TURSO_DATABASE_URL", "libsql://prod.turso.io")
    mock_env("TURSO_AUTH_TOKEN", "token123")

    conn = TursoConnection()
    url = conn.get_connection_url()

    assert "libsql://prod.turso.io" in url
    assert "authToken=token123" in url
```

````

#### 2. E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªæœªå®šç¾©

**æ”¹å–„ææ¡ˆ**:
```markdown
## E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆPhase 6å®Ÿè£…äºˆå®šï¼‰

### ã‚·ãƒŠãƒªã‚ª1: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆã‹ã‚‰è©•ä¾¡ã¾ã§
```gherkin
Feature: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè©•ä¾¡ãƒ•ãƒ­ãƒ¼

Scenario: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°è¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—è©•ä¾¡ã‚’å®Ÿè¡Œ
  Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹
  When ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹
    | title | content |
    | å•†å“èª¬æ˜ç”Ÿæˆ | å•†å“æƒ…å ±ã‹ã‚‰èª¬æ˜æ–‡ã‚’ç”Ÿæˆ... |
  Then ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆIDãŒè¿”å´ã•ã‚Œã‚‹
  And ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹

  When ä½œæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§è©•ä¾¡ã‚’å®Ÿè¡Œã™ã‚‹
  Then è©•ä¾¡IDãŒè¿”å´ã•ã‚Œã‚‹
  And è©•ä¾¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ"running"ã«ãªã£ã¦ã„ã‚‹

  When è©•ä¾¡ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ï¼ˆæœ€å¤§30ç§’ï¼‰
  Then è©•ä¾¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ"completed"ã«ãªã£ã¦ã„ã‚‹
  And è©•ä¾¡ã‚¹ã‚³ã‚¢ãŒ0.0-1.0ã®ç¯„å›²ã§ã‚ã‚‹
  And ãƒ†ã‚¹ãƒˆçµæœãŒ3ä»¶ä»¥ä¸Šå­˜åœ¨ã™ã‚‹
````

**å®Ÿè£…**:

```python
# tests/e2e/test_prompt_evaluation_flow.py
@pytest.mark.e2e
async def test_full_prompt_evaluation_flow(
    api_client: AsyncClient,
    auth_token: str
):
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆâ†’è©•ä¾¡å®Ÿè¡Œâ†’çµæœå–å¾—ã®E2Eãƒ†ã‚¹ãƒˆ"""

    # 1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
    create_response = await api_client.post(
        "/api/v1/prompts",
        json={"title": "Test", "content": "..."},
        headers={"Authorization": f"Bearer {auth_token}"}
    )
    assert create_response.status_code == 201
    prompt_id = create_response.json()["id"]

    # 2. DBç¢ºèª
    async with get_db_session() as session:
        prompt = await session.get(PromptModel, prompt_id)
        assert prompt is not None

    # 3. è©•ä¾¡å®Ÿè¡Œ
    eval_response = await api_client.post(
        f"/api/v1/evaluations",
        json={"prompt_id": prompt_id, "test_suite_id": "default"},
        headers={"Authorization": f"Bearer {auth_token}"}
    )
    assert eval_response.status_code == 202
    evaluation_id = eval_response.json()["id"]

    # 4. ãƒãƒ¼ãƒªãƒ³ã‚°ã§å®Œäº†å¾…æ©Ÿ
    for _ in range(30):
        status_response = await api_client.get(
            f"/api/v1/evaluations/{evaluation_id}",
            headers={"Authorization": f"Bearer {auth_token}"}
        )
        status = status_response.json()["status"]
        if status == "completed":
            break
        await asyncio.sleep(1)
    else:
        pytest.fail("Evaluation timeout")

    # 5. çµæœæ¤œè¨¼
    result = status_response.json()
    assert 0.0 <= result["overall_score"] <= 1.0
    assert len(result["test_results"]) >= 3
```

````

---

## ğŸ”’ 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

### ã‚¹ã‚³ã‚¢: 60/100

### âœ… è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å†…å®¹

1. **ç’°å¢ƒå¤‰æ•°ç®¡ç†**: GitHub Secretsä½¿ç”¨
2. **ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™**: `chmod 600 .env.*`
3. **èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³**: 90æ—¥é–“æœ‰åŠ¹ã€å®šæœŸãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¨å¥¨
4. **.gitignore**: `.env.*`ã®é™¤å¤–

### âš ï¸ ä¸è¶³ã—ã¦ã„ã‚‹å†…å®¹

#### 1. è„…å¨ãƒ¢ãƒ‡ãƒ«

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
```markdown
## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ãƒ¢ãƒ‡ãƒ«

### è„…å¨1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èªè¨¼æƒ…å ±ã®æ¼æ´©
**ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: CRITICAL

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
- .env.localã®èª¤ã‚³ãƒŸãƒƒãƒˆ
- GitHub Actionsãƒ­ã‚°ã¸ã®å‡ºåŠ›
- é–‹ç™ºè€…ãƒã‚·ãƒ³ã®ä¾µå®³

**å¯¾ç­–**:
- [x] .gitignoreã«ã‚ˆã‚‹é™¤å¤–
- [x] GitHub Secretsã®ä½¿ç”¨
- [x] TruffleHogè‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³
- [ ] å®šæœŸçš„ãªãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ90æ—¥â†’30æ—¥ã«å¤‰æ›´æ¨å¥¨ï¼‰
- [ ] æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã®æ´»ç”¨ï¼‰

### è„…å¨2: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
**ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: HIGH

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ä¸é©åˆ‡ãªã‚µãƒ‹ã‚¿ã‚¤ã‚º
- ç”ŸSQLã‚¯ã‚¨ãƒªã®ä½¿ç”¨

**å¯¾ç­–**:
- [x] SQLAlchemy ORMã®ä½¿ç”¨ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªï¼‰
- [x] Pydantic v2ã«ã‚ˆã‚‹å…¥åŠ›æ¤œè¨¼
- [ ] å®šæœŸçš„ãªOWASP ZAPã‚¹ã‚­ãƒ£ãƒ³
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã®ç”ŸSQLæ¤œå‡º

### è„…å¨3: èªè¨¼ãƒã‚¤ãƒ‘ã‚¹
**ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: CRITICAL

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
- JWTæ¤œè¨¼ã®ä¸å‚™
- Clerkè¨­å®šãƒŸã‚¹

**å¯¾ç­–**:
- [x] Clerkå…¬å¼SDKä½¿ç”¨
- [ ] JWTç½²åæ¤œè¨¼ã®å®Ÿè£…
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ60 req/minï¼‰
- [ ] ç•°å¸¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œçŸ¥
````

#### 2. ãƒ‡ãƒ¼ã‚¿ä¿è­·

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:

````markdown
## ãƒ‡ãƒ¼ã‚¿ä¿è­·æˆ¦ç•¥

### å€‹äººæƒ…å ±ï¼ˆPIIï¼‰ã®æ‰±ã„

- **ä¿å­˜ãƒ‡ãƒ¼ã‚¿**: user_idï¼ˆClerk UUIDï¼‰ã®ã¿
- **æš—å·åŒ–**: Tursoè»¢é€æ™‚æš—å·åŒ–ï¼ˆTLS 1.3ï¼‰
- **ä¿å­˜æ™‚æš—å·åŒ–**: Tursoè‡ªå‹•æš—å·åŒ–
- **ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**: ç›£æŸ»ãƒ­ã‚°æœ‰åŠ¹åŒ–

### GDPRæº–æ‹ 

- **ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPIå®Ÿè£…äºˆå®š
- **å¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©**: è«–ç†å‰Šé™¤ï¼ˆSoftDeleteMixinï¼‰å®Ÿè£…æ¸ˆã¿
- **ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–**: å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿å­˜

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–

```bash
# æš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
sqlite3 data/autoforge_dev.db .dump | gpg --encrypt --recipient admin@autoforge.com > backup.sql.gpg

# å¾©å·åŒ–
gpg --decrypt backup.sql.gpg | sqlite3 restored.db
```
````

````

---

## âš¡ 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

### ã‚¹ã‚³ã‚¢: 40/100 (å¤§å¹…ã«ä¸è¶³)

### âŒ ä¸è¶³ã—ã¦ã„ã‚‹å†…å®¹

#### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã‚¬ã‚¤ãƒ‰

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
```markdown
## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆè©•ä¾¡

#### PromptModel (GOOD)
```python
__table_args__ = (
    Index("idx_prompts_user_id", "user_id"),           # ğŸ‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥æ¤œç´¢
    Index("idx_prompts_status", "status"),             # ğŸ‘ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
    Index("idx_prompts_created_at", "created_at"),     # ğŸ‘ æ™‚ç³»åˆ—ã‚½ãƒ¼ãƒˆ
    Index("idx_prompts_parent_id", "parent_id"),       # ğŸ‘ ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´
    Index("idx_prompts_deleted_at", "deleted_at"),     # ğŸ‘ è«–ç†å‰Šé™¤
)
````

#### æ”¹å–„æ¨å¥¨: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 

```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ»ä½œæˆæ—¥æ™‚ã®è¤‡åˆæ¤œç´¢ã«æœ€é©åŒ–
Index("idx_prompts_user_status_created", "user_id", "status", "created_at")
```

**åŠ¹æœæ¸¬å®š**:

```sql
-- Before: å˜ä¸€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼ˆ100msï¼‰
EXPLAIN QUERY PLAN
SELECT * FROM prompts
WHERE user_id = 'user-123' AND status = 'active'
ORDER BY created_at DESC
LIMIT 10;

-- After: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼ˆ10msï¼‰
-- Index scan on idx_prompts_user_status_created
```

### ã‚¯ã‚¨ãƒªæœ€é©åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³

#### N+1å•é¡Œã®å›é¿

```python
# âŒ BAD: N+1å•é¡Œç™ºç”Ÿ
prompts = session.query(PromptModel).filter_by(user_id=user_id).all()
for prompt in prompts:
    evaluations = prompt.evaluations  # å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã”ã¨ã«ã‚¯ã‚¨ãƒªå®Ÿè¡Œ

# âœ… GOOD: Eager Loading
from sqlalchemy.orm import selectinload

prompts = session.query(PromptModel)\
    .options(selectinload(PromptModel.evaluations))\
    .filter_by(user_id=user_id)\
    .all()
```

#### ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ–

```python
# âŒ BAD: OFFSETé…å»¶ï¼ˆ100ä¸‡ä»¶ç›®ã‹ã‚‰10ä»¶å–å¾—ã§10ç§’ï¼‰
prompts = session.query(PromptModel)\
    .order_by(PromptModel.created_at.desc())\
    .offset(1000000)\
    .limit(10)\
    .all()

# âœ… GOOD: Cursor-based Paginationï¼ˆ100msï¼‰
last_created_at = request.query_params.get("cursor")
prompts = session.query(PromptModel)\
    .filter(PromptModel.created_at < last_created_at)\
    .order_by(PromptModel.created_at.desc())\
    .limit(10)\
    .all()
```

### æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š

#### ç’°å¢ƒåˆ¥æ¨å¥¨è¨­å®š

```python
# Developmentï¼ˆä½è² è·ï¼‰
engine = create_engine(
    url,
    pool_size=5,        # æœ€å°æ¥ç¶šæ•°
    max_overflow=10,    # æœ€å¤§è¿½åŠ æ¥ç¶šæ•°
    pool_timeout=30,    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
    pool_recycle=3600,  # æ¥ç¶šå†åˆ©ç”¨æ™‚é–“ï¼ˆ1æ™‚é–“ï¼‰
)

# Productionï¼ˆé«˜è² è·ï¼‰
engine = create_engine(
    url,
    pool_size=20,       # åŸºæœ¬æ¥ç¶šæ•°å¢—åŠ 
    max_overflow=30,    # ãƒãƒ¼ã‚¹ãƒˆå¯¾å¿œ
    pool_timeout=10,    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçŸ­ç¸®
    pool_recycle=1800,  # 30åˆ†ã§å†æ¥ç¶š
    pool_pre_ping=True, # æ¥ç¶šå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
)
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹

#### ç›®æ¨™å€¤è¨­å®š

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹           | ç›®æ¨™å€¤ | æ¸¬å®šæ–¹æ³•             |
| -------------------- | ------ | -------------------- |
| ã‚¯ã‚¨ãƒªP95ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·  | < 50ms | LangFuse             |
| æ¥ç¶šãƒ—ãƒ¼ãƒ«åˆ©ç”¨ç‡     | < 70%  | Prometheus           |
| ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªï¼ˆ>1sï¼‰  | 0ä»¶/æ—¥ | Tursoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰  |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ’ãƒƒãƒˆç‡ | > 95%  | `EXPLAIN QUERY PLAN` |

````

---

## ğŸ¨ 7. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ»å¯èª­æ€§

### ã‚¹ã‚³ã‚¢: 80/100

### âœ… è‰¯å¥½ãªç‚¹

1. **éšå±¤çš„ãªè¦‹å‡ºã—**: `##`, `###`ã®é©åˆ‡ãªä½¿ç”¨
2. **ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯**: è¨€èªæŒ‡å®šä»˜ãã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
3. **ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**: å®Œäº†åŸºæº–ã®æ˜ç¢ºåŒ–
4. **ASCIIå›³**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¦–è¦šåŒ–
5. **å®Ÿè¡Œç’°å¢ƒæ˜è¨˜**: ğŸ³ Docker / ğŸ“ ãƒ›ã‚¹ãƒˆ ã®çµµæ–‡å­—æ´»ç”¨

### âš ï¸ æ”¹å–„ææ¡ˆ

#### 1. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¦ç´ ã®è¿½åŠ 

**è¿½åŠ ã™ã¹ãå›³**:
```markdown
## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ï¼ˆMermaidå½¢å¼ï¼‰

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
```mermaid
graph TB
    A[FastAPI App] -->|SQLAlchemy| B[Turso Connection]
    B -->|Local| C[SQLite]
    B -->|Staging| D[Turso Staging]
    B -->|Production| E[Turso Production]

    A -->|Cache| F[Redis]

    G[Alembic] -->|Migrations| B
    H[Tests] -->|Verify| B

    style C fill:#90EE90
    style D fill:#FFD700
    style E fill:#FF6347
````

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant Dev as Developer
    participant Alembic
    participant DB as Database
    participant Git

    Dev->>Alembic: alembic revision --autogenerate
    Alembic->>DB: Detect schema changes
    Alembic-->>Dev: Generate migration file
    Dev->>Git: Commit migration
    Dev->>Alembic: alembic upgrade head
    Alembic->>DB: Apply migration
    DB-->>Alembic: Success
```

````

#### 2. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¨å¥¨ç®‡æ‰€

**Phase 4-2: Tursoãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ**:
- Tursoèªè¨¼ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèªç”»é¢

**Phase 4-7: GitHub Secretsè¨­å®š**:
- GitHub Secretsç™»éŒ²ç”»é¢
- ç’°å¢ƒä¿è­·è¨­å®šç”»é¢

#### 3. å¤šè¨€èªå¯¾å¿œï¼ˆå°†æ¥å¯¾å¿œï¼‰

**è‹±èªç‰ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆæ¨å¥¨**:
```markdown
# Database Environment Setup Guide (English)

## Overview
This guide provides comprehensive instructions for setting up the AutoForgeNexus database environment...
````

---

## ğŸ“Š 8. ä¿å®ˆæ€§ãƒ»æ›´æ–°æ€§

### ã‚¹ã‚³ã‚¢: 88/100

### âœ… è‰¯å¥½ãªç‚¹

1. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: `v1.0.0`æ˜è¨˜
2. **æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´9æœˆ30æ—¥è¨˜è¼‰
3. **ä½œæˆè€…æƒ…å ±**: AutoForgeNexusé–‹ç™ºãƒãƒ¼ãƒ æ˜è¨˜
4. **å‚è€ƒè³‡æ–™**: å¤–éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ãƒªãƒ³ã‚¯
5. **å¤‰æ›´å±¥æ­´**: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†çŠ¶æ³ã®è¨˜è¼‰

### âš ï¸ æ”¹å–„ææ¡ˆ

#### 1. å¤‰æ›´ãƒ­ã‚°ã®è¿½åŠ 

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:

```markdown
## å¤‰æ›´å±¥æ­´

### v1.1.0ï¼ˆäºˆå®š: 2025-10-15ï¼‰

- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰è¿½åŠ 
- [ ] E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªè¿½åŠ 
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ãƒ¢ãƒ‡ãƒ«è¿½åŠ 
- [ ] è‹±èªç‰ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

### v1.0.0ï¼ˆ2025-09-30ï¼‰

- [x] åˆç‰ˆãƒªãƒªãƒ¼ã‚¹
- [x] Phase 4-1ï½4-7å®Œå…¨å¯¾å¿œ
- [x] ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°6ãƒ‘ã‚¿ãƒ¼ãƒ³
- [x] DDDæº–æ‹ ã®ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ

### v0.9.0ï¼ˆ2025-09-20ï¼‰

- [x] ãƒ‰ãƒ©ãƒ•ãƒˆç‰ˆä½œæˆ
- [x] åŸºæœ¬æ§‹é€ ç¢ºç«‹
```

#### 2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¬ã‚¤ãƒ‰

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:

```markdown
## ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### æ›´æ–°ãŒå¿…è¦ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°

1. **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯å¤‰æ›´æ™‚**ï¼ˆä¾‹: SQLAlchemy 2.0 â†’ 3.0ï¼‰

   - å½±éŸ¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³: Phase 4-4, ã‚³ãƒ¼ãƒ‰ä¾‹
   - æ›´æ–°æ‹…å½“: Backend Lead

2. **æ–°ç’°å¢ƒè¿½åŠ æ™‚**ï¼ˆä¾‹: QAç’°å¢ƒï¼‰

   - å½±éŸ¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³: Phase 4-3, ç’°å¢ƒå¤‰æ•°ç®¡ç†
   - æ›´æ–°æ‹…å½“: DevOps Engineer

3. **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ æ™‚**
   - å½±éŸ¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
   - æ›´æ–°æ‰‹é †: å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºç­–ã‚’è¨˜éŒ²

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹

1. **æŠ€è¡“çš„æ­£ç¢ºæ€§**: Backend Developer ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆ
2. **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: Technical Writer ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¨å¥¨
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Security Engineer ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆï¼ˆPhase 4-7å¤‰æ›´æ™‚ï¼‰

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹

- **å®Œå…¨æ€§ã‚¹ã‚³ã‚¢**: 92/100ï¼ˆç›®æ¨™: 95/100ï¼‰
- **æ­£ç¢ºæ€§ã‚¹ã‚³ã‚¢**: 95/100ï¼ˆç›®æ¨™: 98/100ï¼‰
- **æœ€çµ‚æ›´æ–°**: 2025-09-30ï¼ˆæ¨å¥¨: æœˆæ¬¡æ›´æ–°ï¼‰
```

---

## ğŸ¯ 9. DDDæ¦‚å¿µã®èª¬æ˜å“è³ª

### ã‚¹ã‚³ã‚¢: 90/100

### âœ… å„ªã‚ŒãŸç‚¹

#### æ˜ç¢ºãªå¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

```markdown
## DDDã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æº–æ‹ : å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰æ˜ç¤ºçš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

from src.infrastructure.prompt.models.prompt_model import PromptModel from
src.infrastructure.evaluation.models.evaluation_model import EvaluationModel
```

#### é›†ç´„å¢ƒç•Œã®å³å®ˆ

```python
# æ³¨æ„: PromptModelã¨ã®relationshipã¯å®šç¾©ã—ãªã„
# â†’ é›†ç´„å¢ƒç•Œã‚’è¶Šãˆã‚‹ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªå±¤ã§prompt_idã‚’ä½¿ã£ã¦å–å¾—
```

#### å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ¨å¥¨

```python
# ç¾åœ¨: Stringå‹ã®ID
id: Mapped[str] = mapped_column(String(36), ...)

# æ¨å¥¨: å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
# domain/prompt/value_objects/prompt_id.py
class PromptId(ValueObject):
    def __init__(self, value: str):
        self._validate(value)
        self._value = value
```

### âš ï¸ æ”¹å–„ææ¡ˆ

#### 1. DDDç”¨èªé›†ã®è¿½åŠ 

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:

````markdown
## DDDç”¨èªé›†

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ (Entity)

**å®šç¾©**: ä¸€æ„ã®è­˜åˆ¥å­ï¼ˆIDï¼‰ã‚’æŒã¡ã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ã§åŒä¸€æ€§ã‚’ä¿ã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

**AutoForgeNexusã§ã®ä¾‹**:

- `PromptModel`: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆIDï¼ˆUUIDï¼‰ã§è­˜åˆ¥
- `EvaluationModel`: è©•ä¾¡IDï¼ˆUUIDï¼‰ã§è­˜åˆ¥

**ç‰¹å¾´**:

- IDãŒåŒã˜ãªã‚‰ã€å±æ€§ãŒå¤‰åŒ–ã—ã¦ã‚‚åŒä¸€ã¨ã¿ãªã™
- TimestampMixin, SoftDeleteMixinã§å…±é€šå‹•ä½œã‚’å®Ÿè£…

### å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (Value Object)

**å®šç¾©**: å±æ€§ã®å€¤ã§ç­‰ä¾¡æ€§ã‚’åˆ¤æ–­ã™ã‚‹ã€ä¸å¤‰ï¼ˆimmutableï¼‰ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

**æ¨å¥¨å®Ÿè£…**:

```python
@dataclass(frozen=True)
class PromptTitle:
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒˆãƒ«å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"""
    value: str

    def __post_init__(self):
        if not self.value or len(self.value) > 255:
            raise ValueError("Title must be 1-255 characters")
```
````

### é›†ç´„ (Aggregate)

**å®šç¾©**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã€ä¸€è²«æ€§å¢ƒç•Œã‚’å½¢æˆ

**AutoForgeNexusã§ã®é›†ç´„è¨­è¨ˆ**:

```
Prompt Aggregate (é›†ç´„ãƒ«ãƒ¼ãƒˆ: PromptModel)
â”œâ”€â”€ PromptModel (ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£)
â”œâ”€â”€ PromptTitle (å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
â”œâ”€â”€ PromptContent (å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
â””â”€â”€ versions (è‡ªå·±å‚ç…§)

Evaluation Aggregate (é›†ç´„ãƒ«ãƒ¼ãƒˆ: EvaluationModel)
â”œâ”€â”€ EvaluationModel (ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£)
â”œâ”€â”€ TestResultModel (é›†ç´„å†…ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£)
â””â”€â”€ Metrics (å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
```

**é›†ç´„å¢ƒç•Œãƒ«ãƒ¼ãƒ«**:

1. å¤–éƒ¨ã‹ã‚‰é›†ç´„ãƒ«ãƒ¼ãƒˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
2. é›†ç´„é–“ã¯IDã§å‚ç…§ï¼ˆç›´æ¥å‚ç…§ç¦æ­¢ï¼‰
3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ = é›†ç´„å¢ƒç•Œ

### ãƒªãƒã‚¸ãƒˆãƒª (Repository)

**å®šç¾©**: é›†ç´„ã®æ°¸ç¶šåŒ–ã¨å†æ§‹ç¯‰ã‚’æ‹…å½“ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³**:

```python
# domain/prompt/repositories/prompt_repository.py (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)
class PromptRepository(ABC):
    async def save(self, prompt: Prompt) -> None: ...
    async def find_by_id(self, id: PromptId) -> Optional[Prompt]: ...

# infrastructure/prompt/repositories/turso_prompt_repository.py (å®Ÿè£…)
class TursoPromptRepository(PromptRepository):
    async def save(self, prompt: Prompt) -> None:
        # ORMãƒãƒƒãƒ”ãƒ³ã‚°å‡¦ç†
```

````

#### 2. ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã®è­¦å‘Š

**è¿½åŠ ã™ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
```markdown
## DDDã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³é›†

### âŒ ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³1: é›†ç´„å¢ƒç•Œé•å

**å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰**:
```python
# EvaluationModelã‹ã‚‰PromptModelã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
evaluation.prompt.title  # NG: é›†ç´„å¢ƒç•Œã‚’è¶Šãˆã¦ã„ã‚‹
````

**æ­£ã—ã„ã‚³ãƒ¼ãƒ‰**:

```python
# ãƒªãƒã‚¸ãƒˆãƒªçµŒç”±ã§Promptã‚’å–å¾—
prompt = await prompt_repository.find_by_id(evaluation.prompt_id)
title = prompt.title
```

### âŒ ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³2: è²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«

**å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰**:

```python
# ãƒ¢ãƒ‡ãƒ«ãŒãƒ‡ãƒ¼ã‚¿ä¿æŒã®ã¿ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãªã—ï¼‰
class PromptModel(Base):
    id: str
    title: str
    status: str
    # ãƒ­ã‚¸ãƒƒã‚¯ãªã—...

# ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ­ã‚¸ãƒƒã‚¯é›†ä¸­
class PromptService:
    def activate_prompt(self, prompt_id):
        prompt = repository.find(prompt_id)
        prompt.status = "active"  # ç›´æ¥æ“ä½œ
        repository.save(prompt)
```

**æ­£ã—ã„ã‚³ãƒ¼ãƒ‰**:

```python
# ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒãŸã›ã‚‹
class Prompt(Entity):
    def activate(self) -> None:
        """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–"""
        if self.status == PromptStatus.ARCHIVED:
            raise InvalidOperationError("Archived prompts cannot be activated")

        self.status = PromptStatus.ACTIVE
        self._domain_events.append(PromptActivatedEvent(prompt_id=self.id))

# ã‚µãƒ¼ãƒ“ã‚¹ã¯èª¿æ•´å½¹ã®ã¿
class PromptApplicationService:
    async def activate_prompt(self, prompt_id: PromptId) -> None:
        prompt = await self.repository.find_by_id(prompt_id)
        prompt.activate()  # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å†…
        await self.repository.save(prompt)
```

### âŒ ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³3: ORMã®ç›´æ¥å…¬é–‹

**å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰**:

```python
# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ORMãƒ¢ãƒ‡ãƒ«ã‚’ç›´æ¥æ“ä½œ
@router.get("/prompts/{id}")
async def get_prompt(id: str, session: Session = Depends(get_db_session)):
    prompt = session.query(PromptModel).filter_by(id=id).first()
    return prompt  # ORMãƒ¢ãƒ‡ãƒ«ã‚’ç›´æ¥è¿”å´
```

**æ­£ã—ã„ã‚³ãƒ¼ãƒ‰**:

```python
# ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã¨DTOã®ä½¿ç”¨
@router.get("/prompts/{id}", response_model=PromptResponse)
async def get_prompt(id: str, service: PromptQueryService = Depends()):
    prompt = await service.get_prompt_by_id(PromptId(id))
    return PromptResponse.from_domain(prompt)  # DTOå¤‰æ›
```

```

---

## ğŸ“‹ 10. æ”¹å–„å„ªå…ˆåº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

### é«˜å„ªå…ˆåº¦ï¼ˆ2é€±é–“ä»¥å†…ï¼‰

| # | æ”¹å–„é …ç›® | å½±éŸ¿ç¯„å›² | å·¥æ•° |
|---|---------|---------|------|
| 1 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰è¿½åŠ  | Phase 4å…¨ä½“ | 3æ—¥ |
| 2 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ãƒ¢ãƒ‡ãƒ«æ–‡æ›¸åŒ– | Phase 4-3, 4-7 | 2æ—¥ |
| 3 | ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…ã¨Docstringè¿½åŠ  | Phase 4-4 | 5æ—¥ |
| 4 | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒªæ‰‹é † | Phase 4-2 | 2æ—¥ |

### ä¸­å„ªå…ˆåº¦ï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰

| # | æ”¹å–„é …ç›® | å½±éŸ¿ç¯„å›² | å·¥æ•° |
|---|---------|---------|------|
| 5 | OpenAPIä»•æ§˜æ›¸ç”Ÿæˆ | APIå…¨ä½“ | 3æ—¥ |
| 6 | E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªå®šç¾© | ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ | 4æ—¥ |
| 7 | Mermaidå›³ã®è¿½åŠ  | å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 2æ—¥ |
| 8 | DDDç”¨èªé›†ã¨ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³é›† | æ•™è‚²ãƒ»ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚° | 3æ—¥ |

### ä½å„ªå…ˆåº¦ï¼ˆ3ãƒ¶æœˆä»¥å†…ï¼‰

| # | æ”¹å–„é …ç›® | å½±éŸ¿ç¯„å›² | å·¥æ•° |
|---|---------|---------|------|
| 9 | è‹±èªç‰ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ | ã‚°ãƒ­ãƒ¼ãƒãƒ«å±•é–‹ | 10æ—¥ |
| 10 | ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¿½åŠ  | ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ | 1æ—¥ |

---

## ğŸ“ˆ 11. ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒãƒªãƒ¼

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒãƒ¬ãƒƒã‚¸

```

å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 65%

â”œâ”€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 92% â”œâ”€ ã‚³ãƒ¼ãƒ‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 65% â”œâ”€ APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20%
â”œâ”€ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 70% â”œâ”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
60% â””â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%

```

### å“è³ªã‚¹ã‚³ã‚¢æ¨ç§»ï¼ˆäºˆæ¸¬ï¼‰

```

ç¾åœ¨: 88/100 (EXCELLENT) 1ãƒ¶æœˆå¾Œ: 93/100 (EXCELLENT+) â† é«˜å„ªå…ˆåº¦æ”¹å–„å®Œäº†3ãƒ¶æœˆå¾Œ:
97/100 (WORLD-CLASS) â† å…¨æ”¹å–„å®Œäº†

````

### ROIåˆ†æ

| æŠ•è³‡ | åŠ¹æœ | ROI |
|------|------|-----|
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„: 30äººæ—¥ | ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚é–“50%å‰Šæ¸› | 300% |
| ã‚³ãƒ¼ãƒ‰Docstring: 10äººæ—¥ | ãƒã‚°ä¿®æ­£æ™‚é–“30%å‰Šæ¸› | 200% |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–‡æ›¸: 5äººæ—¥ | è„†å¼±æ€§æ¤œå‡ºç‡80%å‘ä¸Š | 500% |

---

## ğŸ“ 12. æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### Week 1-2: Critical Issues

```bash
# 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ä½œæˆ
/ai:technical-writer:create performance-tuning-guide \
  --sections "indexing,query-optimization,connection-pool" \
  --target docs/setup/PHASE4_PERFORMANCE_GUIDE.md

# 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ãƒ¢ãƒ‡ãƒ«ä½œæˆ
/ai:security:threat-model \
  --scope phase4-database \
  --output docs/security/PHASE4_THREAT_MODEL.md

# 3. ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…ã¨Docstringè¿½åŠ 
/ai:backend:implement repository-layer \
  --domain prompt \
  --pattern ddd \
  --docstring-coverage 80
````

### Week 3-4: High Priority

```bash
# 4. OpenAPIä»•æ§˜æ›¸ç”Ÿæˆ
/ai:api-designer:generate openapi-spec \
  --version 1.0.0 \
  --output backend/openapi.yaml

# 5. E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªå®šç¾©
/ai:test-automation:e2e-scenarios \
  --feature prompt-evaluation-flow \
  --output tests/e2e/scenarios/
```

### Month 2-3: Medium Priority

```bash
# 6. Mermaidå›³ã®è¿½åŠ 
/ai:technical-writer:visualize architecture \
  --format mermaid \
  --output docs/architecture/diagrams/

# 7. DDDæ•™è‚²ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ
/ai:technical-writer:create ddd-guide \
  --sections "glossary,patterns,anti-patterns" \
  --target docs/development/DDD_GUIDE.md
```

---

## âœ… å®Œäº†åŸºæº–ï¼ˆDefinition of Doneï¼‰

ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ”¹å–„ææ¡ˆãŒã™ã¹ã¦å®Ÿè£…ã•ã‚ŒãŸå ´åˆ:

- [ ] **å®Œå…¨æ€§**: 95/100ä»¥ä¸Šï¼ˆç›®æ¨™é”æˆï¼‰
- [ ] **æ­£ç¢ºæ€§**: 98/100ä»¥ä¸Šï¼ˆç›®æ¨™é”æˆï¼‰
- [ ] **æ˜ç¢ºæ€§**: 90/100ä»¥ä¸Šï¼ˆç›®æ¨™é”æˆï¼‰
- [ ] **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: 90/100ä»¥ä¸Šï¼ˆç›®æ¨™é”æˆï¼‰
- [ ] **ä¿å®ˆæ€§**: 95/100ä»¥ä¸Šï¼ˆç›®æ¨™é”æˆï¼‰

### æœ€çµ‚ç›®æ¨™ã‚¹ã‚³ã‚¢: **95/100 (WORLD-CLASS)**

---

## ğŸ“š å‚è€ƒè³‡æ–™

### å†…éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [DATABASE_SETUP_GUIDE.md](/Users/dm/dev/dev/å€‹äººé–‹ç™º/AutoForgeNexus/docs/setup/DATABASE_SETUP_GUIDE.md)
- [CLAUDE.md](/Users/dm/dev/dev/å€‹äººé–‹ç™º/AutoForgeNexus/CLAUDE.md)
- [backend/CLAUDE.md](/Users/dm/dev/dev/å€‹äººé–‹ç™º/AutoForgeNexus/backend/CLAUDE.md)

### å¤–éƒ¨ãƒªãƒ³ã‚¯

- [SQLAlchemy 2.0ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.sqlalchemy.org/en/20/)
- [Domain-Driven Design Reference](https://www.domainlanguage.com/ddd/reference/)
- [API Documentation Best Practices](https://swagger.io/resources/articles/best-practices-in-api-documentation/)

---

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ—¥**: 2025å¹´10æœˆ1æ—¥ **æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¨å¥¨æ—¥**:
2025å¹´11æœˆ1æ—¥ï¼ˆæ”¹å–„å®Ÿè£…å¾Œï¼‰ **ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“**: ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ©ã‚¤ã‚¿ãƒ¼ï¼ˆAI Agentï¼‰
**æ‰¿èªè€…**: Backend Lead, Technical Writer, Security Engineerï¼ˆæ¨å¥¨ï¼‰
