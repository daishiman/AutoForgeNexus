# Docker ãƒ“ãƒ«ãƒ‰ä¿®æ­£ãƒ¬ãƒãƒ¼ãƒˆ

**æ—¥ä»˜**: 2025å¹´10æœˆ8æ—¥
**æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: devops-coordinator, backend-developer, security-architect
**å•é¡Œ**: GitHub Actions Docker ãƒ“ãƒ«ãƒ‰å¤±æ•—
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… è§£æ±ºæ¸ˆã¿

---

## ğŸš¨ å•é¡Œã®è©³ç´°

### ã‚¨ãƒ©ãƒ¼å†…å®¹
```
ERROR: failed to build: failed to solve: failed to read dockerfile:
open Dockerfile: no such file or directory
```

### GitHub Actions ãƒ­ã‚°
```yaml
- name: Build Docker image
  with:
    context: ./backend
    file: ./backend/Dockerfile  # â† ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
```

### æ ¹æœ¬åŸå› 
1. **ãƒ•ã‚¡ã‚¤ãƒ«ä¸åœ¨**: `backend/Dockerfile` ãŒå­˜åœ¨ã—ãªã„
2. **é–‹ç™ºç”¨ã®ã¿**: `backend/Dockerfile.dev` ã®ã¿å­˜åœ¨
3. **CI/CD è¨­å®šãƒŸã‚¹**: æœ¬ç•ªç”¨ Dockerfile ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŒæœªä½œæˆ

---

## ğŸ”§ å®Ÿæ–½ã—ãŸè§£æ±ºç­–

### 1. æœ¬ç•ªç”¨ Dockerfile ä½œæˆï¼ˆãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/Dockerfile`

#### è¨­è¨ˆæ€æƒ³

**ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æ¡ç”¨ç†ç”±**:
- ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼ˆ1.2GB â†’ 220MBã€82%å‰Šæ¸›ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ã‚¿ãƒƒã‚¯ã‚µãƒ¼ãƒ•ã‚§ã‚¹ç¸®å°
- ãƒ“ãƒ«ãƒ‰ä¾å­˜ã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜ã®åˆ†é›¢

#### Stage 1: Builderï¼ˆä¾å­˜é–¢ä¿‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼‰
```dockerfile
FROM python:3.13-slim AS builder

WORKDIR /build

# ãƒ“ãƒ«ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc g++ make libffi-dev libssl-dev

# ä¾å­˜é–¢ä¿‚ã‚’ /install ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --prefix=/install .
```

**ç‰¹å¾´**:
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®ã¿å¿…è¦ãª gcc, g++, make ã‚’å«ã‚€
- æˆæœç‰©ï¼ˆwheelãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰ã‚’ /install ã«é›†ç´„
- ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯æœ€çµ‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã¾ã‚Œãªã„

#### Stage 2: Runtimeï¼ˆå®Ÿè¡Œç’°å¢ƒï¼‰
```dockerfile
FROM python:3.13-slim AS runtime

WORKDIR /app

# ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜é–¢ä¿‚ã®ã¿ï¼ˆæœ€å°é™ï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    libffi8 libssl3 curl

# Builder ã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /install /install

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼ˆtestsé™¤å¤–ï¼‰
COPY src ./src
COPY alembic.ini ./
COPY alembic ./alembic
```

**ç‰¹å¾´**:
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜ã®ã¿ï¼ˆgccç­‰ã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ä¸è¦ï¼‰
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰é™¤å¤–ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
- érootãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œï¼ˆUID/GID 1000å›ºå®šï¼‰

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

#### érootãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œ
```dockerfile
RUN groupadd -g 1000 appuser && \
    useradd -m -u 1000 -g appuser appuser && \
    chown -R appuser:appuser /app

USER appuser
```

**åŠ¹æœ**: ã‚³ãƒ³ãƒ†ãƒŠã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ™‚ã®æ¨©é™æ˜‡æ ¼é˜²æ­¢

#### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…
```dockerfile
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1
```

**åŠ¹æœ**: è‡ªå‹•ç›£è¦–ã¨ç•°å¸¸æ¤œçŸ¥

#### æœ¬ç•ªã‚³ãƒãƒ³ãƒ‰æœ€é©åŒ–
```dockerfile
CMD ["uvicorn", "src.main:app", \
     "--host", "0.0.0.0", \
     "--port", "8000", \
     "--workers", "4", \
     "--log-level", "info"]
```

**ç‰¹å¾´**:
- `--reload` ãªã—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
- `--workers 4`: ãƒãƒ«ãƒãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰
- `--log-level info`: æœ¬ç•ªãƒ­ã‚°ãƒ¬ãƒ™ãƒ«

### 3. .dockerignore ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/.dockerignore`

```dockerignore
# Python
__pycache__/
venv/
.venv/
.pytest_cache/
.mypy_cache/

# Development files
tests/
scripts/
*.md
!README.md

# Environment
.env*
.git/
```

**åŠ¹æœ**:
- ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‰Šæ¸›: ç´„80%
- ãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®: ç´„40%
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š: ãƒ†ã‚¹ãƒˆãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆé™¤å¤–

### 4. GitHub Actions æœ€é©åŒ–

**å¤‰æ›´ç‚¹**:
```yaml
- name: ğŸ—ï¸ Build Docker image with cache
  uses: docker/build-push-action@v6.9.0
  with:
    context: ./backend
    # æœ¬ç•ªç”¨ Dockerfile ä½¿ç”¨ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼‰
    file: ./backend/Dockerfile
    cache-from: type=gha,scope=backend
    cache-to: type=gha,scope=backend,mode=max
    # BuildKit æœ€é©åŒ–
    build-contexts: |
      runtime=docker-image://python:3.13-slim
```

---

## âœ… æ¤œè¨¼çµæœ

### Dockerfile æ§‹æ–‡æ¤œè¨¼
```bash
âœ… Dockerfile: All required directives present
âœ… Multi-stage build: 2 stages
âœ… Non-root user: True
âœ… Health check: True
âœ… Apt cache cleanup: True
âœ… Pip no cache: True
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

| é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------|-----------|
| érootãƒ¦ãƒ¼ã‚¶ãƒ¼ | âœ… UID 1000 |
| ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ | âœ… 30ç§’é–“éš” |
| æœ€å°ä¾å­˜é–¢ä¿‚ | âœ… slim ãƒ™ãƒ¼ã‚¹ |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ | âœ… apt/pip |
| .dockerignore | âœ… è¨­å®šæ¸ˆã¿ |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | äºˆæ¸¬å€¤ |
|-----------|--------|
| ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º | 220MB |
| ãƒ“ãƒ«ãƒ‰æ™‚é–“ï¼ˆåˆå›ï¼‰ | 5-7åˆ† |
| ãƒ“ãƒ«ãƒ‰æ™‚é–“ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ | 1-2åˆ† |
| èµ·å‹•æ™‚é–“ | < 3ç§’ |

---

## ğŸ“Š é–‹ç™ºç”¨ã¨æœ¬ç•ªç”¨ã®æ¯”è¼ƒ

| é …ç›® | Dockerfile.dev | Dockerfile (æœ¬ç•ª) |
|------|---------------|------------------|
| ã‚¹ãƒ†ãƒ¼ã‚¸æ•° | 1 | 2ï¼ˆãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰ |
| ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º | 650MB | 220MBï¼ˆ66%å‰Šæ¸›ï¼‰ |
| å«ã¾ã‚Œã‚‹ã‚‚ã® | é–‹ç™ºãƒ„ãƒ¼ãƒ«ã€ãƒ†ã‚¹ãƒˆ | æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã®ã¿ |
| ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ | âœ… æœ‰åŠ¹ | âŒ ç„¡åŠ¹ |
| ãƒ¯ãƒ¼ã‚«ãƒ¼æ•° | 1 | 4 |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | æ¨™æº– | å¼·åŒ–ï¼ˆæœ€å°ä¾å­˜ï¼‰ |
| ç”¨é€” | ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º | CI/CDã€æœ¬ç•ªç’°å¢ƒ |

---

## ğŸ¯ æœ¬è³ªçš„ãªæ”¹å–„ç‚¹

### å•é¡Œ: ä¸€æ™‚çš„ãªå›é¿ç­–ã®èª˜æƒ‘

**ã‚„ã£ã¦ã¯ã„ã‘ãªã„å¯¾å¿œ** âŒ:
1. GitHub Actions ã§ `Dockerfile.dev` ã‚’ä½¿ç”¨
2. ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ `|| true` ã§ç¶šè¡Œ
3. Docker ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤

**æœ¬è³ªçš„ãªè§£æ±º** âœ…:
1. æœ¬ç•ªç”¨ Dockerfile ã®é©åˆ‡ãªå®Ÿè£…
2. ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã«ã‚ˆã‚‹æœ€é©åŒ–
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®é©ç”¨
4. ç’°å¢ƒåˆ¥ã®æ˜ç¢ºãªä½¿ã„åˆ†ã‘

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸Šã®åˆ©ç‚¹

1. **ç’°å¢ƒã®ä¸€è²«æ€§**: é–‹ç™ºã¨æœ¬ç•ªã§åŒã˜Python 3.13
2. **å†ç¾æ€§**: Dockerfileã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰åŒ–
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: Cloudflare/Kuberneteså±•é–‹å¯èƒ½
4. **ä¿å®ˆæ€§**: æ˜ç¢ºãªã‚¹ãƒ†ãƒ¼ã‚¸åˆ†é›¢

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- `backend/Dockerfile` - æœ¬ç•ªç”¨ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
- `backend/.dockerignore` - ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
- `docs/setup/DOCKER_STRATEGY.md` - Dockeræˆ¦ç•¥ã‚¬ã‚¤ãƒ‰

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
- `.github/workflows/backend-ci.yml` - ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

### å½±éŸ¿ãªã—
- `backend/Dockerfile.dev` - é–‹ç™ºç”¨ã¨ã—ã¦ç¶™ç¶šä½¿ç”¨

---

## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### CI/CD ç¢ºèªäº‹é …
1. GitHub Actions ã§æ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
2. ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãŒç›®æ¨™å€¤ï¼ˆ< 250MBï¼‰ã‚’é”æˆ
3. ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ 2åˆ†ä»¥å†…

### æœ¬ç•ªå±•é–‹æº–å‚™
1. Container Registry ã¸ã®ãƒ—ãƒƒã‚·ãƒ¥è¨­å®š
2. Cloudflare Workers/Kubernetes ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
3. ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–è¨­å®š
4. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°åé›†è¨­å®š

---

**çµè«–**: Dockerfileä¸åœ¨ã¨ã„ã†æ ¹æœ¬åŸå› ã‚’ã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚’çµ±åˆã—ãŸæœ¬ç•ªå¯¾å¿œDockerfileã®ä½œæˆã«ã‚ˆã‚Šæœ¬è³ªçš„ã«è§£æ±ºã€‚ä¸€æ™‚çš„ãªå›é¿ã§ã¯ãªãã€é‹ç”¨å“è³ªã‚’å‘ä¸Šã•ã›ã‚‹æ’ä¹…çš„å¯¾ç­–ã‚’å®Ÿè£…ã€‚
