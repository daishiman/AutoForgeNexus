name: Deploy - Security Hardened

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'next.config.js'
      - 'tailwind.config.ts'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç·Šæ€¥æ™‚ã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šæœ€å°æ¨©é™ã®åŽŸå‰‡
permissions:
  contents: read
  actions: read
  deployments: write
  id-token: write # Cloudflare OIDCèªè¨¼ç”¨
  checks: read

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šæœ¬ç•ªç’°å¢ƒã®å®‰å…¨æ€§ç¢ºä¿
concurrency:
  group: deploy-${{ github.ref }}-${{ inputs.environment || 'production' }}
  cancel-in-progress: false # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸­æ–­ç¦æ­¢

# ç’°å¢ƒå¤‰æ•°ï¼šã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'
  CLOUDFLARE_PROJECT_NAME: 'autoforge-nexus-frontend'
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šæœ¬ç•ªç’°å¢ƒè¨­å®š
  NODE_ENV: production
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # äº‹å‰æ¤œè¨¼ï¼šãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯
  pre-deploy-validation:
    name: ðŸ›¡ï¸ Pre-Deploy Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should-deploy: ${{ steps.validation.outputs.deploy-approved }}
      environment: ${{ steps.env-check.outputs.target-env }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 2
          persist-credentials: false

      - name: Environment determination
        id: env-check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target-env=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "target-env=production" >> $GITHUB_OUTPUT
          fi

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šç ´å£Šçš„å¤‰æ›´æ¤œå‡º
      - name: Detect breaking changes
        run: |
          echo "::group::ç ´å£Šçš„å¤‰æ›´æ¤œå‡º"

          # package.jsonã®ä¸»è¦ä¾å­˜é–¢ä¿‚å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          if git diff HEAD^ HEAD -- package.json | grep -E '^\+.*"(react|next|@clerk)' > /dev/null; then
            echo "::warning::ä¸»è¦ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            git diff HEAD^ HEAD -- package.json | grep -E '^\+.*"(react|next|@clerk)'
          fi

          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          if git diff HEAD^ HEAD --name-only | grep -E '(next\.config\.js|middleware\.ts|tailwind\.config\.ts)' > /dev/null; then
            echo "::notice::è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            git diff HEAD^ HEAD --name-only | grep -E '(next\.config\.js|middleware\.ts|tailwind\.config\.ts)'
          fi

          echo "::endgroup::"

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šç§˜å¯†æƒ…å ±æ¼æ´©ãƒã‚§ãƒƒã‚¯
      - name: Secret leak detection
        run: |
          echo "::group::ç§˜å¯†æƒ…å ±æ¼æ´©æ¤œå‡º"

          # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒŸãƒƒãƒˆæ¤œå‡º
          if git diff HEAD^ HEAD --name-only | grep -E '\.(env|key|pem|p12)' > /dev/null; then
            echo "::error::ç§˜å¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™"
            git diff HEAD^ HEAD --name-only | grep -E '\.(env|key|pem|p12)'
            exit 1
          fi

          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
          if git diff HEAD^ HEAD | grep -iE '(api_key|secret|password|token).*=.*[a-zA-Z0-9]{20,}' > /dev/null; then
            echo "::warning::ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹ç§˜å¯†æƒ…å ±ã‚’æ¤œå‡º"
          fi

          echo "::endgroup::"

      - name: Validation result
        id: validation
        run: |
          # ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã®è­¦å‘Š
          if [ "${{ inputs.skip_tests }}" = "true" ]; then
            echo "::warning::ãƒ†ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼ˆç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰"
            echo "deploy-approved=true" >> $GITHUB_OUTPUT
          else
            echo "deploy-approved=true" >> $GITHUB_OUTPUT
          fi

  # é«˜é€Ÿå“è³ªãƒã‚§ãƒƒã‚¯ï¼šãƒ‡ãƒ—ãƒ­ã‚¤å°‚ç”¨
  quality-gate:
    name: ðŸš€ Quality Gate (Deploy)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-deploy-validation
    if: needs.pre-deploy-validation.outputs.should-deploy == 'true' && inputs.skip_tests != true

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # é«˜é€Ÿå“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
      - name: Fast quality checks
        run: |
          echo "::group::ä¸¦åˆ—å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"

          # TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦åˆ—ï¼‰
          pnpm type-check &
          TYPE_PID=$!

          # ESLintï¼ˆä¸¦åˆ—ï¼‰
          pnpm lint &
          LINT_PID=$!

          # å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰
          pnpm test --passWithNoTests --silent &
          TEST_PID=$!

          # çµæžœå¾…æ©Ÿ
          wait $TYPE_PID || { echo "::error::TypeScriptåž‹ãƒã‚§ãƒƒã‚¯å¤±æ•—"; exit 1; }
          wait $LINT_PID || { echo "::error::ESLintæ¤œè¨¼å¤±æ•—"; exit 1; }
          wait $TEST_PID || { echo "::error::å˜ä½“ãƒ†ã‚¹ãƒˆå¤±æ•—"; exit 1; }

          echo "::notice::å…¨å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "::endgroup::"

  # æœ¬ç•ªãƒ“ãƒ«ãƒ‰ï¼šæœ€é©åŒ–ã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰
  production-build:
    name: ðŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [pre-deploy-validation, quality-gate]
    if: always() && needs.pre-deploy-validation.outputs.should-deploy == 'true' && (needs.quality-gate.result == 'success' || inputs.skip_tests == true)

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰ï¼ˆæœ€å¤§æœ€é©åŒ–ï¼‰
      - name: Build for production
        run: |
          echo "::group::æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰é–‹å§‹"
          pnpm build
          echo "::endgroup::"
        env:
          # æœ¬ç•ªç’°å¢ƒå¤‰æ•°ï¼ˆãƒžã‚¹ã‚­ãƒ³ã‚°æ¸ˆã¿ï¼‰
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šã‚½ãƒ¼ã‚¹ãƒžãƒƒãƒ—ç„¡åŠ¹åŒ–
          GENERATE_SOURCEMAP: false

      # é™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCloudflare Pagesæœ€é©åŒ–ï¼‰
      - name: Static export
        run: |
          echo "::group::é™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ"
          pnpm export
          echo "::endgroup::"

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
      - name: Generate security headers
        run: |
          cat > out/_headers << 'EOF'
          /*
            X-Frame-Options: DENY
            X-Content-Type-Options: nosniff
            X-XSS-Protection: 1; mode=block
            Referrer-Policy: strict-origin-when-cross-origin
            Permissions-Policy: camera=(), microphone=(), geolocation=()
            Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
            Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' *.clerk.dev; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data: *.cloudflare.com; font-src 'self'; connect-src 'self' *.clerk.dev *.turso.io;

          /_next/static/*
            Cache-Control: public, max-age=31536000, immutable

          /api/*
            Cache-Control: no-store, must-revalidate
          EOF

          echo "::notice::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šå®Œäº†"

      # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®åœ§ç¸®
      - name: Compress build artifacts
        run: |
          echo "::group::ãƒ“ãƒ«ãƒ‰æˆæžœç‰©åœ§ç¸®"
          cd out
          tar -czf ../build-artifacts.tar.gz .
          cd ..
          ls -lh build-artifacts.tar.gz
          echo "::endgroup::"

      # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: build-artifacts-${{ github.sha }}
          path: build-artifacts.tar.gz
          retention-days: 30

  # Cloudflare Pages ãƒ‡ãƒ—ãƒ­ã‚¤
  cloudflare-deploy:
    name: â˜ï¸ Cloudflare Pages Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-deploy-validation, production-build]
    environment:
      name: ${{ needs.pre-deploy-validation.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            api.cloudflare.com:443
            github.com:443

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: build-artifacts-${{ github.sha }}

      - name: Extract build artifacts
        run: |
          mkdir -p out
          tar -xzf build-artifacts.tar.gz -C out

      # Cloudflare Pagesãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚»ã‚­ãƒ¥ã‚¢èªè¨¼ï¼‰
      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@f0a1cd58cd66095dee69bfa18fa5efd1dde93bca # v1.5.0
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.CLOUDFLARE_PROJECT_NAME }}
          directory: out
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šæœ¬ç•ªç’°å¢ƒã®ã¿GitHubãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
          gitHubToken: ${{ github.ref == 'refs/heads/main' && secrets.GITHUB_TOKEN || '' }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®æ¤œè¨¼
      - name: Deployment verification
        run: |
          echo "::group::ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼"
          DEPLOY_URL="${{ steps.deploy.outputs.url }}"

          if [ -n "$DEPLOY_URL" ]; then
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤URL: $DEPLOY_URL"
            echo "::notice::ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
            if curl -s --max-time 30 "$DEPLOY_URL/api/health" > /dev/null; then
              echo "::notice::ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            else
              echo "::warning::ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã¾ãŸã¯å¿œç­”ãªã—"
            fi
          else
            echo "::error::ãƒ‡ãƒ—ãƒ­ã‚¤URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          echo "::endgroup::"

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ†ã‚¹ãƒˆï¼šæœ¬ç•ªç’°å¢ƒæ¤œè¨¼
  post-deploy-verification:
    name: ðŸ§ª Post-Deploy Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: cloudflare-deploy
    if: success()

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            *.pages.dev:443
            *.cloudflare.com:443

      # æœ¬ç•ªç’°å¢ƒã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
      - name: Production smoke tests
        run: |
          echo "::group::æœ¬ç•ªç’°å¢ƒã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ"
          DEPLOY_URL="${{ needs.cloudflare-deploy.outputs.url || 'https://autoforge-nexus.pages.dev' }}"

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
          echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼..."
          HEADERS=$(curl -sI "$DEPLOY_URL")

          if echo "$HEADERS" | grep -i "x-frame-options.*deny" > /dev/null; then
            echo "âœ… X-Frame-Options: DENY è¨­å®šæ¸ˆã¿"
          else
            echo "âŒ X-Frame-Options ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          fi

          if echo "$HEADERS" | grep -i "strict-transport-security" > /dev/null; then
            echo "âœ… HSTS ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šæ¸ˆã¿"
          else
            echo "âŒ HSTS ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          fi

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãƒã‚§ãƒƒã‚¯
          echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š..."
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$DEPLOY_URL")
          echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${RESPONSE_TIME}ç§’"

          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "::warning::ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ3ç§’ã‚’è¶…ãˆã¦ã„ã¾ã™"
          else
            echo "::notice::ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã¯è¨±å®¹ç¯„å›²å†…ã§ã™"
          fi

          echo "::endgroup::"

  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥
  deployment-notification:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deploy-validation, cloudflare-deploy, post-deploy-verification]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "### ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| äº‹å‰æ¤œè¨¼ | ${{ needs.pre-deploy-validation.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ å¤±æ•—' }} | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ãƒ»ç ´å£Šçš„å¤‰æ›´æ¤œå‡º |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflareãƒ‡ãƒ—ãƒ­ã‚¤ | ${{ needs.cloudflare-deploy.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} | Pagesé…ä¿¡ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼ | ${{ needs.post-deploy-verification.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ å¤±æ•—' }} | ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¸¬å®š |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç’°å¢ƒ**: ${{ needs.pre-deploy-validation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          # å¤±æ•—æ™‚ã®è­¦å‘Š
          if [ "${{ needs.cloudflare-deploy.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**" >> $GITHUB_STEP_SUMMARY
          fi