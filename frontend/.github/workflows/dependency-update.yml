name: Dependency Update - Automated Security

on:
  schedule:
    # æ¯é€±ç«æ›œæ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«ä¾å­˜é–¢ä¿‚æ›´æ–°
    - cron: '0 17 * * 2'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'æ›´æ–°ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch    # ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿
          - minor    # ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§
          - major    # ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§ï¼ˆæ³¨æ„ï¼‰
      include_dev_deps:
        description: 'é–‹ç™ºä¾å­˜é–¢ä¿‚ã‚‚æ›´æ–°'
        required: false
        default: true
        type: boolean
      auto_merge:
        description: 'è‡ªå‹•ãƒãƒ¼ã‚¸ï¼ˆãƒ‘ãƒƒãƒæ›´æ–°ã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šä¾å­˜é–¢ä¿‚æ›´æ–°å°‚ç”¨æ¨©é™
permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: read
  security-events: read

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šä¾å­˜é–¢ä¿‚æ›´æ–°ã¯å˜ä¸€å®Ÿè¡Œ
concurrency:
  group: dependency-update
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'
  # æ›´æ–°æˆ¦ç•¥è¨­å®š
  UPDATE_TYPE: ${{ inputs.update_type || 'patch' }}
  INCLUDE_DEV_DEPS: ${{ inputs.include_dev_deps || true }}

jobs:
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ¤œå‡º
  security-update-detection:
    name: ğŸ” Security Update Detection
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      has-security-updates: ${{ steps.detect.outputs.security-updates-found }}
      critical-count: ${{ steps.detect.outputs.critical-count }}
      security-packages: ${{ steps.detect.outputs.security-packages }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            registry.npmjs.org:443

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install current dependencies
        run: pnpm install --frozen-lockfile

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®æ¤œå‡º
      - name: Detect security vulnerabilities
        id: detect
        run: |
          echo "::group::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º"

          # npm auditã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’æ¤œå‡º
          pnpm audit --json > audit-current.json || true

          # è„†å¼±æ€§æ•°ã‚«ã‚¦ãƒ³ãƒˆ
          if [ -f audit-current.json ]; then
            CRITICAL=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "critical") | .key' audit-current.json 2>/dev/null | wc -l || echo "0")
            HIGH=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high") | .key' audit-current.json 2>/dev/null | wc -l || echo "0")
            MODERATE=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "moderate") | .key' audit-current.json 2>/dev/null | wc -l || echo "0")

            echo "ç¾åœ¨ã®è„†å¼±æ€§:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            echo "- Moderate: $MODERATE"

            # å‡ºåŠ›è¨­å®š
            echo "critical-count=$CRITICAL" >> $GITHUB_OUTPUT

            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "security-updates-found=true" >> $GITHUB_OUTPUT

              # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
              SECURITY_PACKAGES=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "critical" or .value.severity == "high") | .key' audit-current.json 2>/dev/null | tr '\n' ',' | sed 's/,$//')
              echo "security-packages=$SECURITY_PACKAGES" >> $GITHUB_OUTPUT
            else
              echo "security-updates-found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "security-updates-found=false" >> $GITHUB_OUTPUT
            echo "critical-count=0" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

  # ä¾å­˜é–¢ä¿‚æ›´æ–°å®Ÿè¡Œ
  dependency-update:
    name: ğŸ“¦ Dependency Update Execution
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: security-update-detection

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Create update branch
        run: |
          BRANCH_NAME="chore/dependency-update-$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      # ç¾åœ¨ã®ä¾å­˜é–¢ä¿‚çŠ¶æ…‹ä¿å­˜
      - name: Save current state
        run: |
          cp package.json package.json.backup
          cp pnpm-lock.yaml pnpm-lock.yaml.backup

      # ä¾å­˜é–¢ä¿‚æ›´æ–°å®Ÿè¡Œ
      - name: Update dependencies
        run: |
          echo "::group::ä¾å­˜é–¢ä¿‚æ›´æ–°å®Ÿè¡Œ"

          case "${{ env.UPDATE_TYPE }}" in
            "patch")
              echo "ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ä¸­..."
              pnpm update --latest --depth 1
              ;;
            "minor")
              echo "ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ä¸­..."
              pnpm update --latest
              ;;
            "major")
              echo "âš ï¸ ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã¯æ…é‡ã«..."
              # ãƒ¡ã‚¸ãƒ£ãƒ¼æ›´æ–°ã¯æ‰‹å‹•ç¢ºèªæ¨å¥¨
              pnpm update --latest --interactive
              ;;
          esac

          # é–‹ç™ºä¾å­˜é–¢ä¿‚æ›´æ–°
          if [ "${{ env.INCLUDE_DEV_DEPS }}" = "true" ]; then
            echo "é–‹ç™ºä¾å­˜é–¢ä¿‚æ›´æ–°ä¸­..."
            pnpm update --dev --latest
          fi

          echo "::endgroup::"

      # æ›´æ–°å¾Œã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
      - name: Post-update security verification
        run: |
          echo "::group::æ›´æ–°å¾Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼"

          # æ–°ã—ã„ä¾å­˜é–¢ä¿‚ã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
          pnpm install
          pnpm audit --json > audit-updated.json || true

          if [ -f audit-updated.json ]; then
            CRITICAL_NEW=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "critical") | .key' audit-updated.json 2>/dev/null | wc -l || echo "0")
            HIGH_NEW=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high") | .key' audit-updated.json 2>/dev/null | wc -l || echo "0")

            echo "æ›´æ–°å¾Œã®è„†å¼±æ€§:"
            echo "- Critical: $CRITICAL_NEW"
            echo "- High: $HIGH_NEW"

            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„ç¢ºèª
            CRITICAL_BEFORE="${{ needs.security-update-detection.outputs.critical-count }}"
            if [ "$CRITICAL_NEW" -lt "$CRITICAL_BEFORE" ]; then
              echo "::notice::Criticalè„†å¼±æ€§ãŒ${CRITICAL_BEFORE}ä»¶ã‹ã‚‰${CRITICAL_NEW}ä»¶ã«æ”¹å–„ã•ã‚Œã¾ã—ãŸ"
            elif [ "$CRITICAL_NEW" -gt "$CRITICAL_BEFORE" ]; then
              echo "::error::Criticalè„†å¼±æ€§ãŒå¢—åŠ ã—ã¾ã—ãŸ (${CRITICAL_BEFORE} â†’ ${CRITICAL_NEW})"
              exit 1
            fi
          fi

          echo "::endgroup::"

      # æ›´æ–°å†…å®¹ã®åˆ†æ
      - name: Analyze update changes
        run: |
          echo "::group::æ›´æ–°å†…å®¹åˆ†æ"

          # å¤‰æ›´ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è©³ç´°
          echo "## ğŸ“¦ æ›´æ–°ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸" > update-summary.md
          echo "" >> update-summary.md

          # package.jsonã®å·®åˆ†ç¢ºèª
          if ! diff -u package.json.backup package.json > package-diff.txt; then
            echo "### æœ¬ç•ªä¾å­˜é–¢ä¿‚" >> update-summary.md
            echo "\`\`\`diff" >> update-summary.md
            grep -E '^\+.*".*":' package-diff.txt | sed 's/^\+//' >> update-summary.md || true
            echo "\`\`\`" >> update-summary.md
            echo "" >> update-summary.md
          fi

          # ä¸»è¦ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯
          MAJOR_PACKAGES=("react" "next" "@clerk/nextjs" "tailwindcss")
          echo "### ğŸ” ä¸»è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°çŠ¶æ³" >> update-summary.md
          echo "" >> update-summary.md

          for pkg in "${MAJOR_PACKAGES[@]}"; do
            OLD_VERSION=$(jq -r ".dependencies[\"$pkg\"] // .devDependencies[\"$pkg\"] // \"ãªã—\"" package.json.backup)
            NEW_VERSION=$(jq -r ".dependencies[\"$pkg\"] // .devDependencies[\"$pkg\"] // \"ãªã—\"" package.json)

            if [ "$OLD_VERSION" != "$NEW_VERSION" ] && [ "$OLD_VERSION" != "ãªã—" ]; then
              echo "- **$pkg**: $OLD_VERSION â†’ $NEW_VERSION" >> update-summary.md
            fi
          done

          echo "" >> update-summary.md

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„æƒ…å ±
          if [ "${{ needs.security-update-detection.outputs.has-security-updates }}" = "true" ]; then
            echo "### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„" >> update-summary.md
            echo "- ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ä¿®æ­£:" >> update-summary.md
            echo "- ${{ needs.security-update-detection.outputs.security-packages }}" >> update-summary.md
            echo "" >> update-summary.md
          fi

          cat update-summary.md

          echo "::endgroup::"

      # å“è³ªãƒã‚§ãƒƒã‚¯
      - name: Quality verification
        run: |
          echo "::group::å“è³ªæ¤œè¨¼"

          # TypeScriptå‹ãƒã‚§ãƒƒã‚¯
          echo "TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          if ! pnpm type-check; then
            echo "::error::TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          # Lintå®Ÿè¡Œ
          echo "ESLintå®Ÿè¡Œä¸­..."
          if ! pnpm lint; then
            echo "::warning::ESLintã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆç¶™ç¶šï¼‰"
          fi

          # åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          echo "å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          if ! pnpm test --passWithNoTests; then
            echo "::error::å˜ä½“ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "::notice::å“è³ªæ¤œè¨¼å®Œäº†"
          echo "::endgroup::"

      # ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
      - name: Build verification
        run: |
          echo "::group::ãƒ“ãƒ«ãƒ‰æ¤œè¨¼"

          if ! pnpm build; then
            echo "::error::ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "::notice::ãƒ“ãƒ«ãƒ‰æ¤œè¨¼å®Œäº†"
          echo "::endgroup::"

      # å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆ
      - name: Commit dependency updates
        run: |
          echo "::group::å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆ"

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet package.json pnpm-lock.yaml; then
            echo "ä¾å­˜é–¢ä¿‚ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            # æ›´æ–°å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git add package.json pnpm-lock.yaml

            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
            COMMIT_MSG="chore(deps): ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–° (${{ env.UPDATE_TYPE }})"

            if [ "${{ needs.security-update-detection.outputs.has-security-updates }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG - ğŸ›¡ï¸ Criticalè„†å¼±æ€§ä¿®æ­£"
            fi

            git commit -m "$COMMIT_MSG

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin "$BRANCH_NAME"
            echo "CHANGES_COMMITTED=true" >> $GITHUB_ENV
          fi

          echo "::endgroup::"

      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
      - name: Create Pull Request
        if: env.CHANGES_COMMITTED == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const updateSummary = fs.readFileSync('update-summary.md', 'utf8');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ä¾å­˜é–¢ä¿‚æ›´æ–° (${{ env.UPDATE_TYPE }}) - ${{ needs.security-update-detection.outputs.has-security-updates == 'true' && 'ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£å«ã‚€' || 'å®šæœŸæ›´æ–°' }}`,
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## ğŸ”„ ä¾å­˜é–¢ä¿‚è‡ªå‹•æ›´æ–°

            ã“ã®PRã¯ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸã€‚

            ${updateSummary}

            ## âœ… å®Ÿè¡Œæ¸ˆã¿æ¤œè¨¼

            - [x] TypeScriptå‹ãƒã‚§ãƒƒã‚¯
            - [x] ESLintæ¤œè¨¼
            - [x] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            - [x] æœ¬ç•ªãƒ“ãƒ«ãƒ‰æ¤œè¨¼
            - [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯

            ## ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ

            - [ ] ä¸»è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã‹ç¢ºèª
            - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„åŠ¹æœã®ç¢ºèª
            - [ ] å‹•ä½œç¢ºèªï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

            ## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

            ${${{ inputs.auto_merge == true && env.UPDATE_TYPE == 'patch' }} ? 'âœ… **è‡ªå‹•ãƒãƒ¼ã‚¸æœ‰åŠ¹** - ãƒ‘ãƒƒãƒæ›´æ–°ã®ãŸã‚è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™' : 'âš ï¸ **æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆ** - ãƒã‚¤ãƒŠãƒ¼/ãƒ¡ã‚¸ãƒ£ãƒ¼æ›´æ–°ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„'}

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
            `,
              draft: false
            });

            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã®å ´åˆã¯å„ªå…ˆãƒ©ãƒ™ãƒ«
            const labels = ['dependencies', 'automated'];
            if ('${{ needs.security-update-detection.outputs.has-security-updates }}' === 'true') {
              labels.push('security', 'priority');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: labels
            });

            console.log(`PRä½œæˆå®Œäº†: ${pr.html_url}`);
            return pr.number;

  # è‡ªå‹•ãƒãƒ¼ã‚¸ï¼ˆãƒ‘ãƒƒãƒæ›´æ–°ã®ã¿ï¼‰
  auto-merge:
    name: ğŸ¤– Auto Merge (Patch Only)
    runs-on: ubuntu-latest
    needs: [security-update-detection, dependency-update]
    if: inputs.auto_merge == true && inputs.update_type == 'patch' && needs.dependency-update.result == 'success'

    steps:
      - name: Auto merge patch updates
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // æœ€æ–°ã®PRã‚’æ¤œç´¢
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:chore/dependency-update-${new Date().toISOString().slice(0,10).replace(/-/g,'')}`,
              state: 'open'
            });

            if (prs.length > 0) {
              const pr = prs[0];

              // CIæˆåŠŸã‚’å¾…æ©Ÿ
              console.log('CIå®Œäº†ã‚’å¾…æ©Ÿä¸­...');
              await new Promise(resolve => setTimeout(resolve, 30000)); // 30ç§’å¾…æ©Ÿ

              // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              const allPassed = checks.check_runs.every(check =>
                check.status === 'completed' && check.conclusion === 'success'
              );

              if (allPassed) {
                // è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  commit_title: `chore(deps): ä¾å­˜é–¢ä¿‚ãƒ‘ãƒƒãƒæ›´æ–°è‡ªå‹•ãƒãƒ¼ã‚¸`,
                  commit_message: `ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒæ›´æ–°ã®è‡ªå‹•ãƒãƒ¼ã‚¸\n\nğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)`,
                  merge_method: 'squash'
                });

                console.log(`âœ… PR #${pr.number} ãŒè‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸ`);
              } else {
                console.log('âŒ CIãŒå¤±æ•—ã—ãŸãŸã‚è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
              }
            }

  # æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ
  update-report:
    name: ğŸ“Š Update Report
    runs-on: ubuntu-latest
    needs: [security-update-detection, dependency-update, auto-merge]
    if: always()

    steps:
      - name: Generate update report
        run: |
          echo "### ğŸ“¦ ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**æ›´æ–°ã‚¿ã‚¤ãƒ—**: ${{ env.UPDATE_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "**é–‹ç™ºä¾å­˜é–¢ä¿‚**: ${{ env.INCLUDE_DEV_DEPS == 'true' && 'å«ã‚€' || 'é™¤å¤–' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.security-update-detection.outputs.has-security-updates }}" = "true" ]; then
            echo "- **Criticalè„†å¼±æ€§**: ${{ needs.security-update-detection.outputs.critical-count }}ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- **å½±éŸ¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: ${{ needs.security-update-detection.outputs.security-packages }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¿®æ­£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ needs.dependency-update.result == 'success' && 'âœ… ä¿®æ­£æ¸ˆã¿' || 'âŒ ä¿®æ­£å¤±æ•—' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œãªã—**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“‹ æ›´æ–°çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ®µéš | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| è„†å¼±æ€§æ¤œå‡º | ${{ needs.security-update-detection.result == 'success' && 'âœ… å®Œäº†' || 'âŒ å¤±æ•—' }} | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®ç‰¹å®š |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾å­˜é–¢ä¿‚æ›´æ–° | ${{ needs.dependency-update.result == 'success' && 'âœ… å®Œäº†' || 'âŒ å¤±æ•—' }} | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°ãƒ»æ¤œè¨¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| è‡ªå‹•ãƒãƒ¼ã‚¸ | ${{ needs.auto-merge.result == 'success' && 'âœ… å®Ÿè¡Œ' || needs.auto-merge.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ å¤±æ•—' }} | ãƒ‘ãƒƒãƒæ›´æ–°ã®è‡ªå‹•é©ç”¨ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ¬¡å›å®Ÿè¡Œäºˆå®š
          echo "**æ¬¡å›è‡ªå‹•æ›´æ–°**: æ¯é€±ç«æ›œæ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰" >> $GITHUB_STEP_SUMMARY