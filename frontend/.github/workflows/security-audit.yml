name: Security Audit - OWASP & Compliance

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œ
    - cron: '0 18 * * 1'
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/security-audit.yml'
  pull_request:
    branches: [main]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      audit_level:
        description: 'ç›£æŸ»ãƒ¬ãƒ™ãƒ«'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - basic
          - comprehensive
          - critical-only
      include_license_check:
        description: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ»ã‚’å«ã‚ã‚‹'
        required: false
        default: true
        type: boolean

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šæœ€å°æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  actions: read
  issues: write # è„†å¼±æ€§Issueè‡ªå‹•ä½œæˆç”¨
  pull-requests: write

# ç’°å¢ƒå¤‰æ•°ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒŠè¨­å®š
  TRIVY_SEVERITY: 'CRITICAL,HIGH,MEDIUM'
  SNYK_SEVERITY_THRESHOLD: 'medium'

jobs:
  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  dependency-vulnerability-scan:
    name: ğŸ” Dependency Vulnerability Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        scanner: [trivy, snyk, npm-audit]
      fail-fast: false

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            registry.npmjs.org:443
            api.snyk.io:443
            *.githubusercontent.com:443

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Trivyè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      - name: Trivy vulnerability scan
        if: matrix.scanner == 'trivy'
        uses: aquasecurity/trivy-action@7c2007bcb556501da015201bcba5aa14069b74e2 # v0.23.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: false

      - name: Upload Trivy results
        if: matrix.scanner == 'trivy'
        uses: github/codeql-action/upload-sarif@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        with:
          sarif_file: 'trivy-results.sarif'

      # Snykè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      - name: Snyk vulnerability scan
        if: matrix.scanner == 'snyk'
        uses: snyk/actions/node@b98d498629f1c368650479d5233ed5f57f8a9edc # v0.4.0
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --json-file-output=snyk-results.json

      - name: Upload Snyk results
        if: matrix.scanner == 'snyk' && always()
        uses: github/codeql-action/upload-sarif@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        with:
          sarif_file: snyk-results.sarif

      # npm auditè©³ç´°åˆ†æ
      - name: npm audit comprehensive scan
        if: matrix.scanner == 'npm-audit'
        run: |
          echo "::group::npm auditåŒ…æ‹¬çš„åˆ†æ"

          # è©³ç´°ç›£æŸ»å®Ÿè¡Œ
          pnpm audit --json > npm-audit-results.json || true

          # çµæœåˆ†æ
          if [ -f npm-audit-results.json ]; then
            # é‡è¦åº¦åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
            CRITICAL=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "critical") | .key' npm-audit-results.json 2>/dev/null | wc -l || echo "0")
            HIGH=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high") | .key' npm-audit-results.json 2>/dev/null | wc -l || echo "0")
            MODERATE=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "moderate") | .key' npm-audit-results.json 2>/dev/null | wc -l || echo "0")

            echo "è„†å¼±æ€§ã‚µãƒãƒªãƒ¼:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            echo "- Moderate: $MODERATE"

            # Criticalè„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—
            if [ "$CRITICAL" -gt 0 ]; then
              echo "::error::Criticalè„†å¼±æ€§ãŒ$CRITICALä»¶æ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              exit 1
            fi

            # Highè„†å¼±æ€§ã®è­¦å‘Š
            if [ "$HIGH" -gt 0 ]; then
              echo "::warning::Highè„†å¼±æ€§ãŒ$HIGHä»¶æ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi
          fi

          echo "::endgroup::"

      # ç›£æŸ»çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: security-scan-${{ matrix.scanner }}-${{ github.run_id }}
          path: |
            *-results.json
            *-results.sarif
          retention-days: 90

  # ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ
  code-security-analysis:
    name: ğŸ“Š Code Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ESLintã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
      - name: ESLint security analysis
        run: |
          echo "::group::ESLintã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ"

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹åŒ–ã®ESLintå®Ÿè¡Œ
          pnpm lint --ext .ts,.tsx,.js,.jsx \
            --format @microsoft/eslint-formatter-sarif \
            --output-file eslint-security.sarif \
            src/ || true

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼æŠ½å‡º
          if [ -f eslint-security.sarif ]; then
            echo "ESLintã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æå®Œäº†"
          fi

          echo "::endgroup::"

      - name: Upload ESLint security results
        if: always()
        uses: github/codeql-action/upload-sarif@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        with:
          sarif_file: eslint-security.sarif

      # ç§˜å¯†æƒ…å ±æ¼æ´©æ¤œå‡ºï¼ˆTruffleHogï¼‰
      - name: Secret leak detection
        run: |
          echo "::group::ç§˜å¯†æƒ…å ±æ¼æ´©æ¤œå‡º"

          # ä¸€èˆ¬çš„ãªç§˜å¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢
          SECRET_PATTERNS=(
            "api[_-]?key.*=.*['\"][a-zA-Z0-9]{20,}['\"]"
            "secret.*=.*['\"][a-zA-Z0-9]{20,}['\"]"
            "password.*=.*['\"][a-zA-Z0-9]{8,}['\"]"
            "token.*=.*['\"][a-zA-Z0-9]{20,}['\"]"
            "private[_-]?key.*=.*['\"].*['\"]"
          )

          echo "ç§˜å¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢ä¸­..."
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" src/ 2>/dev/null; then
              echo "::error::æ½œåœ¨çš„ãªç§˜å¯†æƒ…å ±ã‚’æ¤œå‡º: $pattern"
              SECRETS_FOUND=true
            fi
          done

          # AWS/GCPã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
          if grep -r -E "(AKIA[0-9A-Z]{16}|AIza[0-9A-Za-z-_]{35})" src/ 2>/dev/null; then
            echo "::error::AWSã¾ãŸã¯GCPã‚­ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
            SECRETS_FOUND=true
          fi

          if [ "$SECRETS_FOUND" = "true" ]; then
            echo "::warning::ã‚³ãƒ¼ãƒ‰å†…ã«ç§˜å¯†æƒ…å ±ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚"
          else
            echo "::notice::ç§˜å¯†æƒ…å ±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

          echo "::endgroup::"

  # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ»
  license-compliance-audit:
    name: ğŸ“‹ License Compliance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: inputs.include_license_check != false

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ»
      - name: License compliance check
        run: |
          echo "::group::ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ»"

          # è¨±å¯ã•ã‚ŒãŸãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸€è¦§
          ALLOWED_LICENSES=(
            "MIT"
            "BSD-2-Clause"
            "BSD-3-Clause"
            "Apache-2.0"
            "ISC"
            "0BSD"
            "Unlicense"
          )

          echo "ä¾å­˜é–¢ä¿‚ãƒ©ã‚¤ã‚»ãƒ³ã‚¹åˆ†æä¸­..."
          pnpm licenses list --json > licenses.json

          # ç¦æ­¢ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
          FORBIDDEN_LICENSES=(
            "GPL-2.0"
            "GPL-3.0"
            "AGPL"
            "LGPL"
            "SSPL"
            "BUSL"
          )

          echo "ç¦æ­¢ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯..."
          for license in "${FORBIDDEN_LICENSES[@]}"; do
            if grep -i "$license" licenses.json 2>/dev/null; then
              echo "::error::ç¦æ­¢ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ¤œå‡º: $license"
              FORBIDDEN_FOUND=true
            fi
          done

          if [ "$FORBIDDEN_FOUND" = "true" ]; then
            echo "::error::ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸æ˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
          if grep -i "unknown\|unlicensed\|null" licenses.json 2>/dev/null; then
            echo "::warning::ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸æ˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ã¾ã™"
          fi

          echo "::notice::ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ»å®Œäº†"
          echo "::endgroup::"

      - name: Upload license report
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: license-report-${{ github.run_id }}
          path: licenses.json
          retention-days: 365

  # è¨­å®šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  configuration-security-audit:
    name: âš™ï¸ Configuration Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      # Next.jsè¨­å®šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      - name: Next.js configuration security
        run: |
          echo "::group::Next.jsè¨­å®šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»"

          if [ -f next.config.js ]; then
            echo "Next.jsè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

            # ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šã®ç¢ºèª
            if grep -q "headers.*X-Frame-Options\|headers.*X-Content-Type-Options" next.config.js; then
              echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šæ¸ˆã¿"
            else
              echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            fi

            # å±é™ºãªè¨­å®šã®æ¤œå‡º
            if grep -q "dangerouslyAllowBuildTimeOptimizations\|experimentalUnsafe" next.config.js; then
              echo "::warning::å®Ÿé¨“çš„ã¾ãŸã¯å±é™ºãªè¨­å®šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi

            # é–‹ç™ºå°‚ç”¨è¨­å®šã®æœ¬ç•ªç’°å¢ƒãƒã‚§ãƒƒã‚¯
            if grep -q "webpack.*mode.*development" next.config.js; then
              echo "::warning::é–‹ç™ºãƒ¢ãƒ¼ãƒ‰è¨­å®šãŒæœ¬ç•ªè¨­å®šã«å«ã¾ã‚Œã¦ã„ã¾ã™"
            fi
          fi

          echo "::endgroup::"

      # TypeScriptè¨­å®šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      - name: TypeScript configuration security
        run: |
          echo "::group::TypeScriptè¨­å®šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»"

          if [ -f tsconfig.json ]; then
            echo "TypeScriptè¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

            # strict modeç¢ºèª
            if grep -q '"strict".*true' tsconfig.json; then
              echo "âœ… Strictãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹"
            else
              echo "âš ï¸ Strictãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™"
            fi

            # å±é™ºãªè¨­å®šç¢ºèª
            if grep -q '"skipLibCheck".*true\|"suppressImplicitAnyIndexErrors".*true' tsconfig.json; then
              echo "::warning::å‹ãƒã‚§ãƒƒã‚¯ãŒç·©å’Œã•ã‚Œã¦ã„ã¾ã™"
            fi
          fi

          echo "::endgroup::"

      # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸.jsonè¨­å®šç›£æŸ»
      - name: Package.json security audit
        run: |
          echo "::group::package.jsonè¨­å®šç›£æŸ»"

          if [ -f package.json ]; then
            # scriptså†…ã®å±é™ºãªã‚³ãƒãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯
            if grep -q '"postinstall"\|"preinstall"' package.json; then
              echo "::warning::pre/postinstallã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            fi

            # é–‹ç™ºä¾å­˜é–¢ä¿‚ã®æœ¬ç•ªå«æœ‰ãƒã‚§ãƒƒã‚¯
            if jq -r '.dependencies | keys[]' package.json | grep -E "(nodemon|webpack-dev|@types/)" 2>/dev/null; then
              echo "::warning::é–‹ç™ºç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæœ¬ç•ªä¾å­˜é–¢ä¿‚ã«å«ã¾ã‚Œã¦ã„ã¾ã™"
            fi

            echo "âœ… package.jsonç›£æŸ»å®Œäº†"
          fi

          echo "::endgroup::"

  # è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ
  security-report-integration:
    name: ğŸ“ˆ Security Report Integration
    runs-on: ubuntu-latest
    needs: [dependency-vulnerability-scan, code-security-analysis, license-compliance-audit, configuration-security-audit]
    if: always()

    steps:
      - name: Download all scan results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: scan-results

      # åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      - name: Generate comprehensive security report
        run: |
          echo "### ğŸ”’ åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç›£æŸ»å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ç›£æŸ»ãƒ¬ãƒ™ãƒ«**: ${{ inputs.audit_level || 'comprehensive' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ç›£æŸ»çµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚«ãƒ†ã‚´ãƒª | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ | ${{ needs.dependency-vulnerability-scan.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | Trivy + Snyk + npm audit |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | ${{ needs.code-security-analysis.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | ESLint + ç§˜å¯†æƒ…å ±æ¤œå‡º |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ» | ${{ needs.license-compliance-audit.result == 'success' && 'âœ… åˆæ ¼' || needs.license-compliance-audit.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ è¦å¯¾å¿œ' }} | ç¦æ­¢ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ + ä¸æ˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ |" >> $GITHUB_STEP_SUMMARY
          echo "| è¨­å®šç›£æŸ» | ${{ needs.configuration-security-audit.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | Next.js + TypeScript + package.json |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          echo "## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.dependency-vulnerability-scan.result }}" != "success" ]; then
            echo "- ğŸ”´ **ä¾å­˜é–¢ä¿‚è„†å¼±æ€§**: æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.code-security-analysis.result }}" != "success" ]; then
            echo "- ğŸ”´ **ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ESLintã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç§˜å¯†æƒ…å ±ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.license-compliance-audit.result }}" != "success" ] && [ "${{ needs.license-compliance-audit.result }}" != "skipped" ]; then
            echo "- ğŸ”´ **ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é•å**: ç¦æ­¢ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç½®æ›ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.configuration-security-audit.result }}" != "success" ]; then
            echo "- ğŸ”´ **è¨­å®šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’å¼·åŒ–ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ¬¡å›ç›£æŸ»**: æ¯é€±æœˆæ›œæ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«è‡ªå‹•å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY

      # é‡è¦ãªè„†å¼±æ€§ã§Issueè‡ªå‹•ä½œæˆ
      - name: Create security issue
        if: needs.dependency-vulnerability-scan.result == 'failure'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Critical Security Vulnerabilities Detected',
              body: `## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º

              ã“ã®Issueã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

              **æ¤œå‡ºæ—¥æ™‚**: ${new Date().toISOString()}
              **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${context.workflow}
              **å®Ÿè¡ŒID**: ${context.runId}

              ## å¯¾å¿œãŒå¿…è¦ãªé …ç›®

              - [ ] ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã®ä¿®æ­£
              - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ç¢ºèª
              - [ ] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

              ## å‚è€ƒãƒªãƒ³ã‚¯

              - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](${context.payload.repository.html_url}/actions/runs/${context.runId})
              - [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª](${context.payload.repository.html_url}/security/advisories)

              ## æœŸé™

              **Criticalè„†å¼±æ€§**: 72æ™‚é–“ä»¥å†…
              **Highè„†å¼±æ€§**: 1é€±é–“ä»¥å†…
              `,
              labels: ['security', 'vulnerability', 'critical']
            });