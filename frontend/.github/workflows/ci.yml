name: CI/CD - Security Hardened

on:
  push:
    branches: [main, develop, feature/*, hotfix/*]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'next.config.js'
      - 'tailwind.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
    - cron: '0 17 * * *'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šæ¨©é™ã‚’æœ€å°é™ã«åˆ¶é™
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write # OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ç”¨

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šãƒªã‚½ãƒ¼ã‚¹ç«¶åˆã¨ã‚³ã‚¹ãƒˆæœ€é©åŒ–
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

# ç’°å¢ƒå¤‰æ•°ï¼šã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šæœ¬ç•ªç’°å¢ƒã§ã®ãƒ‡ãƒãƒƒã‚°ç„¡åŠ¹åŒ–
  NODE_ENV: production
  # OWASPæ¨å¥¨ï¼šCSPå¼·åˆ¶
  NEXT_PUBLIC_CSP_ENFORCE: 'true'
  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆDDosæ”»æ’ƒå¯¾ç­–ï¼‰
  GITHUB_ACTIONS_TIMEOUT: 30

jobs:
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼šä¾å­˜é–¢ä¿‚è„†å¼±æ€§æ¤œå‡º
  security-scan:
    name: ğŸ”’ Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name != 'schedule' || github.repository_owner == 'daishiman'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            registry.npmjs.org:443
            objects.githubusercontent.com:443
            codeload.github.com:443

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šå®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pnpm install --frozen-lockfile --prefer-offline
        env:
          # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
          npm_config_audit: true
          npm_config_fund: false

      # Trivy: åŒ…æ‹¬çš„è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠ
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@7c2007bcb556501da015201bcba5aa14069b74e2 # v0.23.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # npm audit: Node.jsä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
      - name: Run npm security audit
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œ
          pnpm audit --audit-level moderate --json > audit-results.json || true

          # çµæœè©•ä¾¡
          if [ -s audit-results.json ]; then
            echo "::warning::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            cat audit-results.json
          fi

      # License compliance check
      - name: License compliance check
        run: |
          pnpm licenses list --depth 0 > licenses.txt
          echo "::notice::ä¾å­˜é–¢ä¿‚ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’licenses.txtã«å‡ºåŠ›ã—ã¾ã—ãŸ"

  # å“è³ªãƒã‚§ãƒƒã‚¯ï¼šå‹å®‰å…¨æ€§ãƒ»Lintingãƒ»ãƒ†ã‚¹ãƒˆ
  quality-check:
    name: ğŸ” Code Quality & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: security-scan

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # TypeScriptå‹ãƒã‚§ãƒƒã‚¯ï¼ˆstrict modeï¼‰
      - name: TypeScript type check
        run: |
          echo "::group::TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          pnpm type-check
          echo "::endgroup::"

      # ESLintï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å«ã‚€ï¼‰
      - name: ESLint analysis
        run: |
          echo "::group::ESLintå®Ÿè¡Œ"
          pnpm lint --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif || true
          echo "::endgroup::"

      - name: Upload ESLint results
        uses: github/codeql-action/upload-sarif@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        if: always()
        with:
          sarif_file: eslint-results.sarif

      # Jestå˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸75%å¿…é ˆï¼‰
      - name: Run unit tests
        run: |
          echo "::group::Jestå˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          pnpm test --coverage --coverageReporters=text-lcov --coverageReporters=json-summary
          echo "::endgroup::"
        env:
          CI: true

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¤œè¨¼
      - name: Validate test coverage
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < 75" | bc -l) )); then
            echo "::error::ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ75%æœªæº€ã§ã™ï¼ˆç¾åœ¨: ${COVERAGE}%ï¼‰"
            exit 1
          fi

          echo "::notice::ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼ˆ${COVERAGE}%ï¼‰"

  # ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼šæœ¬ç•ªç’°å¢ƒæº–å‚™çŠ¶æ³ç¢ºèª
  build-verification:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality-check

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Next.jsæœ¬ç•ªãƒ“ãƒ«ãƒ‰ï¼ˆTurbopackï¼‰
      - name: Build application
        run: |
          echo "::group::Next.jsæœ¬ç•ªãƒ“ãƒ«ãƒ‰ï¼ˆTurbopackï¼‰"
          pnpm build
          echo "::endgroup::"
        env:
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šãƒ“ãƒ«ãƒ‰æ™‚ã®ç’°å¢ƒå¤‰æ•°åˆ¶å¾¡
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      # é™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCloudflare Pagesç”¨ï¼‰
      - name: Static export
        run: |
          echo "::group::é™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ"
          pnpm export
          echo "::endgroup::"

      # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ
      - name: Bundle size analysis
        run: |
          echo "::group::ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ"

          # ä¸»è¦ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºç¢ºèª
          if [ -d "out/_next/static" ]; then
            find out/_next/static -name "*.js" -type f -exec ls -lh {} \; | sort -k5 -hr | head -10

            # åˆè¨ˆã‚µã‚¤ã‚ºè¨ˆç®—
            TOTAL_SIZE=$(find out/_next/static -name "*.js" -type f -exec stat -f%z {} \; | awk '{sum+=$1} END {print sum}')
            TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))

            echo "ç·ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º: ${TOTAL_SIZE_KB}KB"

            # 200KBåˆ¶é™ãƒã‚§ãƒƒã‚¯
            if [ $TOTAL_SIZE_KB -gt 200 ]; then
              echo "::warning::ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒ200KBã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆ${TOTAL_SIZE_KB}KBï¼‰"
            else
              echo "::notice::ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºè¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼ˆ${TOTAL_SIZE_KB}KBï¼‰"
            fi
          fi
          echo "::endgroup::"

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        if: failure()
        with:
          name: build-output-${{ github.run_id }}
          path: |
            out/
            .next/
            build-logs.txt
          retention-days: 3

  # E2Eãƒ†ã‚¹ãƒˆï¼šPlaywrightè‡ªå‹•åŒ–
  e2e-testing:
    name: ğŸ­ E2E Testing (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-verification
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build application
        run: pnpm build

      - name: Start development server
        run: |
          pnpm start &
          sleep 10
        env:
          PORT: 3000

      # Playwright E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run Playwright tests
        run: |
          echo "::group::Playwright E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          pnpm test:e2e
          echo "::endgroup::"
        env:
          # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ï¼ˆãƒã‚¹ã‚­ãƒ³ã‚°æ¸ˆã¿ï¼‰
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      # ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Playwright report
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        if: always()
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ
  security-report:
    name: ğŸ“Š Security Report Summary
    runs-on: ubuntu-latest
    needs: [security-scan, quality-check, build-verification]
    if: always()

    steps:
      - name: Security assessment summary
        run: |
          echo "### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.security-scan.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | Trivy + npm audit |" >> $GITHUB_STEP_SUMMARY
          echo "| å“è³ªãƒã‚§ãƒƒã‚¯ | ${{ needs.quality-check.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | TypeScript + ESLint + Jest |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ | ${{ needs.build-verification.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | æœ¬ç•ªãƒ“ãƒ«ãƒ‰ + ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY