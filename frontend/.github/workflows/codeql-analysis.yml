name: CodeQL Security Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'src/**/*.js'
      - 'src/**/*.jsx'
  schedule:
    # æ¯Žæ—¥åˆå‰4æ™‚ï¼ˆJSTï¼‰ã«CodeQLåˆ†æžå®Ÿè¡Œ
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      language:
        description: 'åˆ†æžè¨€èªž'
        required: true
        default: 'typescript'
        type: choice
        options:
          - typescript
          - javascript
      analysis_depth:
        description: 'åˆ†æžæ·±åº¦'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - deep

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šCodeQLåˆ†æžå°‚ç”¨æ¨©é™
permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: read

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šãƒªã‚½ãƒ¼ã‚¹æœ€é©åŒ–
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  codeql-analyze:
    name: ðŸ” CodeQL Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        # TypeScript/JavaScriptã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æž
        language: ['typescript']
        include:
          - language: typescript
            queries: security-extended

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            registry.npmjs.org:443
            uploads.github.com:443
            objects.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 2
          persist-credentials: false

      # Node.jsç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ“ãƒ«ãƒ‰ç”¨ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ï¼‰
      - name: Install dependencies
        run: |
          # ã‚»ã‚­ãƒ¥ã‚¢ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pnpm install --frozen-lockfile --prefer-offline
        env:
          # npm auditæœ‰åŠ¹åŒ–
          npm_config_audit: true
          npm_config_fund: false

      # CodeQLåˆæœŸåŒ–
      - name: Initialize CodeQL
        uses: github/codeql-action/init@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        with:
          languages: ${{ matrix.language }}
          queries: >
            security-extended,
            security-and-quality
          config: |
            name: "AutoForgeNexus CodeQL Config"
            queries:
              - name: security-extended
                uses: security-extended
              - name: security-and-quality
                uses: security-and-quality
            paths-ignore:
              - "**/node_modules/**"
              - "**/*.test.ts"
              - "**/*.test.tsx"
              - "**/tests/**"
              - "**/*.config.js"
              - "**/*.config.ts"
            paths:
              - "src/**"

      # TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Šï¼‰
      - name: TypeScript compilation check
        run: |
          echo "::group::TypeScriptåž‹ãƒã‚§ãƒƒã‚¯"
          pnpm type-check
          echo "::endgroup::"

      # Next.jsãƒ“ãƒ«ãƒ‰ï¼ˆã‚³ãƒ¼ãƒ‰è§£æžç”¨ï¼‰
      - name: Build application for analysis
        run: |
          echo "::group::åˆ†æžç”¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ"
          pnpm build
          echo "::endgroup::"
        env:
          # åˆ†æžç”¨ç’°å¢ƒè¨­å®š
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          # ã‚½ãƒ¼ã‚¹ãƒžãƒƒãƒ—ç”Ÿæˆï¼ˆè©³ç´°åˆ†æžç”¨ï¼‰
          GENERATE_SOURCEMAP: true

      # CodeQLåˆ†æžå®Ÿè¡Œ
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@4fa2a7953630fd2f3fb380f21be14ede0169dd4f # v3.25.12
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          output: codeql-results
          # è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          format: 'sarif-latest'

  # ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
  custom-security-rules:
    name: ðŸ›¡ï¸ Custom Security Rules
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      # ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢
      - name: Custom security pattern analysis
        run: |
          echo "::group::ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æž"

          # å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
          SECURITY_ISSUES=()

          # 1. XSSè„†å¼±æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³
          echo "XSSè„†å¼±æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯..."
          if grep -r -n "dangerouslySetInnerHTML" src/ 2>/dev/null; then
            echo "::warning::dangerouslySetInnerHTMLã®ä½¿ç”¨ã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("XSS")
          fi

          # 2. SQL Injectionå¯èƒ½æ€§
          echo "SQL Injectionå¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯..."
          if grep -r -n -E "(query|execute).*\+.*user|user.*\+.*(query|execute)" src/ 2>/dev/null; then
            echo "::warning::SQL Injectionå¯èƒ½æ€§ã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("SQLi")
          fi

          # 3. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±
          echo "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ãƒã‚§ãƒƒã‚¯..."
          if grep -r -n -E "(password|secret|key).*=.*['\"][a-zA-Z0-9]{8,}['\"]" src/ 2>/dev/null; then
            echo "::error::ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("HARDCODED_CREDS")
          fi

          # 4. å®‰å…¨ã§ãªã„ãƒ©ãƒ³ãƒ€ãƒ å€¤ç”Ÿæˆ
          echo "å®‰å…¨ã§ãªã„ãƒ©ãƒ³ãƒ€ãƒ å€¤ç”Ÿæˆãƒã‚§ãƒƒã‚¯..."
          if grep -r -n "Math.random()" src/ 2>/dev/null; then
            echo "::warning::æš—å·å­¦çš„ã«å®‰å…¨ã§ãªã„Math.random()ã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("WEAK_RANDOM")
          fi

          # 5. eval()ã®ä½¿ç”¨
          echo "eval()ä½¿ç”¨ãƒã‚§ãƒƒã‚¯..."
          if grep -r -n -E "\beval\(" src/ 2>/dev/null; then
            echo "::error::å±é™ºãªeval()ã®ä½¿ç”¨ã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("EVAL_USAGE")
          fi

          # 6. å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®éžã‚»ã‚­ãƒ¥ã‚¢èª­ã¿è¾¼ã¿
          echo "éžã‚»ã‚­ãƒ¥ã‚¢å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯..."
          if grep -r -n "http://" src/ 2>/dev/null | grep -v "localhost"; then
            echo "::warning::éžHTTPSã®å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("INSECURE_HTTP")
          fi

          # 7. ä¸é©åˆ‡ãªCORSè¨­å®š
          echo "CORSè¨­å®šãƒã‚§ãƒƒã‚¯..."
          if grep -r -n "Access-Control-Allow-Origin.*\*" src/ 2>/dev/null; then
            echo "::warning::éŽåº¦ã«ç·©ã„CORSè¨­å®šã‚’æ¤œå‡º"
            SECURITY_ISSUES+=("LOOSE_CORS")
          fi

          # 8. console.log()ã«ç§˜å¯†æƒ…å ±
          echo "ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ç§˜å¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯..."
          if grep -r -n -E "console\.(log|debug|info).*(\btoken\b|\bpassword\b|\bsecret\b|\bkey\b)" src/ 2>/dev/null; then
            echo "::warning::consoleå‡ºåŠ›ã«ç§˜å¯†æƒ…å ±ã®å¯èƒ½æ€§"
            SECURITY_ISSUES+=("CONSOLE_SECRETS")
          fi

          # çµæžœã‚µãƒžãƒªãƒ¼
          if [ ${#SECURITY_ISSUES[@]} -eq 0 ]; then
            echo "::notice::ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          else
            echo "::warning::æ¤œå‡ºã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: ${SECURITY_ISSUES[*]}"
          fi

          echo "::endgroup::"

  # OWASP ZAPå‹•çš„åˆ†æžï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  owasp-zap-scan:
    name: ðŸ•·ï¸ OWASP ZAP Dynamic Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Build and start application
        run: |
          pnpm install --frozen-lockfile
          pnpm build
          pnpm start &
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¾…æ©Ÿ
          sleep 30
        env:
          NODE_ENV: production
          PORT: 3000

      # OWASP ZAPãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ìŠ¤ìº”
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@c906f739897208ce2b4d6e65d0d6b9b48b31e3be # v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -d -T 60'

      # ZAPçµæžœã®å‡¦ç†
      - name: Process ZAP results
        if: always()
        run: |
          if [ -f report_html.html ]; then
            echo "::notice::OWASP ZAPåˆ†æžå®Œäº†"
          else
            echo "::warning::OWASP ZAPåˆ†æžçµæžœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Upload ZAP results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: zap-report-${{ github.run_id }}
          path: |
            report_html.html
            report_json.json
          retention-days: 30

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æžãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ
  security-analysis-report:
    name: ðŸ“Š Security Analysis Report
    runs-on: ubuntu-latest
    needs: [codeql-analyze, custom-security-rules, owasp-zap-scan]
    if: always()

    steps:
      - name: Generate comprehensive security report
        run: |
          echo "### ðŸ” åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æžãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æžå®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ›¡ï¸ åˆ†æžçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æžãƒ„ãƒ¼ãƒ« | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQLé™çš„åˆ†æž | ${{ needs.codeql-analyze.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ»å“è³ªå•é¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ« | ${{ needs.custom-security-rules.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ è¦å¯¾å¿œ' }} | XSSãƒ»SQLiãƒ»èªè¨¼æƒ…å ±æ¼æ´© |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP ZAPå‹•çš„ | ${{ needs.owasp-zap-scan.result == 'success' && 'âœ… åˆæ ¼' || needs.owasp-zap-scan.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ è¦å¯¾å¿œ' }} | å®Ÿè¡Œæ™‚è„†å¼±æ€§ãƒ»è¨­å®šå•é¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŽ¨å¥¨äº‹é …
          echo "## ðŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŽ¨å¥¨äº‹é …" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.codeql-analyze.result }}" != "success" ]; then
            echo "### ðŸ”´ CodeQLåˆ†æžã§å•é¡Œæ¤œå‡º" >> $GITHUB_STEP_SUMMARY
            echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
            echo "- [Security ã‚¿ãƒ–](${{ github.server_url }}/${{ github.repository }}/security)ã§è©³ç´°ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.custom-security-rules.result }}" != "success" ]; then
            echo "### ðŸ”´ ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§å•é¡Œæ¤œå‡º" >> $GITHUB_STEP_SUMMARY
            echo "- XSS/SQLiå¯¾ç­–ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # ç¶™ç¶šçš„æ”¹å–„
          echo "## ðŸ”„ ç¶™ç¶šçš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®šæœŸåˆ†æž**: æ¯Žæ—¥åˆå‰4æ™‚ã«è‡ªå‹•å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- **PRãƒã‚§ãƒƒã‚¯**: ã™ã¹ã¦ã®PRã§è‡ªå‹•åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¾å­˜é–¢ä¿‚ç›£è¦–**: æ¯Žé€±ç«æ›œæ—¥ã«è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- **OWASP ZAP**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã§å‹•çš„åˆ†æž" >> $GITHUB_STEP_SUMMARY

      # é‡è¦ãªè„†å¼±æ€§ã§ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
      - name: Critical security alert
        if: needs.codeql-analyze.result == 'failure'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Critical Security Vulnerabilities - CodeQL Analysis',
              body: `## ðŸš¨ é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

              CodeQLåˆ†æžã«ã‚ˆã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®é‡è¦ãªå•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚

              ## ðŸ“Š åˆ†æžè©³ç´°

              - **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toISOString()}
              - **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`
              - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}

              ## ðŸ” ç¢ºèªç®‡æ‰€

              - [Security ã‚¿ãƒ–](${context.payload.repository.html_url}/security) ã§CodeQLåˆ†æžçµæžœã‚’ç¢ºèª
              - [Actions](${context.payload.repository.html_url}/actions/runs/${context.runId}) ã§è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª

              ## âš¡ ç·Šæ€¥å¯¾å¿œãŒå¿…è¦

              - [ ] **Critical**: 24æ™‚é–“ä»¥å†…ã«å¯¾å¿œ
              - [ ] **High**: 72æ™‚é–“ä»¥å†…ã«å¯¾å¿œ
              - [ ] **Medium**: 1é€±é–“ä»¥å†…ã«å¯¾å¿œ

              ## ðŸ“‹ å¯¾å¿œæ‰‹é †

              1. Security ã‚¿ãƒ–ã§è„†å¼±æ€§è©³ç´°ã‚’ç¢ºèª
              2. å½±éŸ¿ç¯„å›²ã¨æ”»æ’ƒå¯èƒ½æ€§ã‚’è©•ä¾¡
              3. ä¿®æ­£ãƒ‘ãƒƒãƒã‚’ä½œæˆãƒ»ãƒ†ã‚¹ãƒˆ
              4. ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ãŸã¯å®šæœŸãƒªãƒªãƒ¼ã‚¹ã§å¯¾å¿œ

              ---
              ðŸ¤– è‡ªå‹•ç”Ÿæˆã‚¢ãƒ©ãƒ¼ãƒˆ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ å³åº§å¯¾å¿œå¿…é ˆ
              `,
              labels: ['security', 'critical', 'codeql', 'vulnerability']
            });

            // ãƒãƒ¼ãƒ é€šçŸ¥ï¼ˆSlack/Discordç­‰ã¨ã®é€£æºç”¨ï¼‰
            console.log('ðŸš¨ Critical security vulnerabilities detected - immediate attention required');

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¿½è·¡
      - name: Security metrics tracking
        run: |
          echo "## ðŸ“ˆ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ | ãƒˆãƒ¬ãƒ³ãƒ‰ |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-----|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æž | ${{ needs.codeql-analyze.result == 'success' && '0' || '1+' }} issues | ${{ needs.codeql-analyze.result == 'success' && 'ðŸ“ˆ æ”¹å–„' || 'ðŸ“‰ è¦æ³¨æ„' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ« | ${{ needs.custom-security-rules.result == 'success' && '0' || '1+' }} warnings | ${{ needs.custom-security-rules.result == 'success' && 'ðŸ“ˆ è‰¯å¥½' || 'ðŸ“‰ è¦æ”¹å–„' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å‹•çš„åˆ†æž | ${{ needs.owasp-zap-scan.result == 'success' && 'å®Ÿè¡Œæ¸ˆã¿' || needs.owasp-zap-scan.result == 'skipped' && 'ã‚¹ã‚­ãƒƒãƒ—' || 'è¦ç¢ºèª' }} | å®šæœŸå®Ÿè¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢**: ${{ needs.codeql-analyze.result == 'success' && needs.custom-security-rules.result == 'success' && 'A+' || 'B è¦æ”¹å–„' }}" >> $GITHUB_STEP_SUMMARY