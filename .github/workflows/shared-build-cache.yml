name: "å…±æœ‰ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥"
# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã¨ç®¡ç†ç”¨ã®å†åˆ©ç”¨å¯èƒ½ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  workflow_call:
    inputs:
      build-type:
        description: "ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ— (frontend|backend|docker)"
        required: true
        type: string
      working-directory:
        description: "ãƒ“ãƒ«ãƒ‰æ“ä½œç”¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
        required: true
        type: string
      build-command:
        description: "ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰"
        required: true
        type: string
      artifact-paths:
        description: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æˆæœç‰©ã®ãƒ‘ã‚¹ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰"
        required: true
        type: string
      cache-key-inputs:
        description: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼è¨ˆç®—ã«å«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«"
        required: false
        default: ""
        type: string
      environment-vars:
        description: "ãƒ“ãƒ«ãƒ‰ç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆJSONå½¢å¼ï¼‰"
        required: false
        default: "{}"
        type: string

jobs:
  build-with-cache:
    name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ããƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-build.outputs.cache-hit }}
      build-cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ”‘ ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
        id: cache-key
        run: |
          # ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã€ä¾å­˜é–¢ä¿‚ã€è¨­å®šã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã‚ã‚‹
          if [ -n "${{ inputs.cache-key-inputs }}" ]; then
            SOURCES_HASH=$(find ${{ inputs.working-directory }} -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.py" -o -name "*.json" -o -name "*.toml" -o -name "*.lock" | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          else
            SOURCES_HASH=$(find ${{ inputs.working-directory }} -type f -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.py" | head -100 | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          fi

          CACHE_KEY="${{ inputs.build-type }}-build-${{ runner.os }}-${SOURCES_HASH}-${{ github.sha }}"
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼: ${CACHE_KEY}"

      - name: ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        id: cache-build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ inputs.artifact-paths }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ inputs.build-type }}-build-${{ runner.os }}-

      - name: ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        if: steps.cache-build.outputs.cache-hit != 'true'
        working-directory: ${{ inputs.working-directory }}
        run: ${{ inputs.build-command }}

      - name: ğŸ“¤ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: ${{ inputs.build-type }}-build-${{ github.run_id }}
          path: ${{ inputs.artifact-paths }}
          retention-days: 7
