name: "å…±æœ‰ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥"
# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã¨ç®¡ç†ç”¨ã®å†åˆ©ç”¨å¯èƒ½ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  workflow_call:
    inputs:
      build-type:
        description: "ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ— (frontend|backend|docker)"
        required: true
        type: string
      working-directory:
        description: "ãƒ“ãƒ«ãƒ‰æ“ä½œç”¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
        required: true
        type: string
      build-command:
        description: "ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰"
        required: true
        type: string
      artifact-paths:
        description: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æˆæœç‰©ã®ãƒ‘ã‚¹ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰"
        required: true
        type: string
      cache-key-inputs:
        description: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼è¨ˆç®—ã«å«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«"
        required: false
        default: ""
        type: string
      environment-vars:
        description: "ãƒ“ãƒ«ãƒ‰ç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆJSONå½¢å¼ï¼‰"
        required: false
        default: "{}"
        type: string

jobs:
  setup-build-environment:
    name: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    if: inputs.build-type == 'frontend'

    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: '${{ inputs.working-directory }}/pnpm-lock.yaml'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile
        timeout-minutes: 5

      - name: ğŸ” Pre-flight environment validation
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "::notice::ğŸ” ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’æ¤œè¨¼ä¸­..."
          for cmd in node npm pnpm; do
            command -v $cmd &> /dev/null || { echo "::error::âŒ $cmd ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; exit 1; }
            echo "::notice::âœ… $cmd: $($cmd --version)"
          done
          echo "::notice::âœ… ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ"

  build-with-cache:
    name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ããƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: setup-build-environment
    if: always() && (needs.setup-build-environment.result == 'success' || inputs.build-type != 'frontend')
    outputs:
      cache-hit: ${{ steps.cache-build.outputs.cache-hit }}
      build-cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ“¦ Restore Node.js & pnpm (frontend builds only)
        if: inputs.build-type == 'frontend'
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: ğŸŸ¢ Restore Node.js environment (frontend builds only)
        if: inputs.build-type == 'frontend'
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: '${{ inputs.working-directory }}/pnpm-lock.yaml'

      - name: ğŸ“¦ Restore dependencies from cache (frontend builds only)
        if: inputs.build-type == 'frontend'
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile --prefer-offline
        timeout-minutes: 2

      - name: ğŸ”‘ ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
        id: cache-key
        run: |
          # ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã€ä¾å­˜é–¢ä¿‚ã€è¨­å®šã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã‚ã‚‹
          if [ -n "${{ inputs.cache-key-inputs }}" ]; then
            SOURCES_HASH=$(find ${{ inputs.working-directory }} -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.py" -o -name "*.json" -o -name "*.toml" -o -name "*.lock" | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          else
            SOURCES_HASH=$(find ${{ inputs.working-directory }} -type f -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.py" | head -100 | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          fi

          CACHE_KEY="${{ inputs.build-type }}-build-${{ runner.os }}-${SOURCES_HASH}-${{ github.sha }}"
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼: ${CACHE_KEY}"

      - name: ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        id: cache-build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ inputs.artifact-paths }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ inputs.build-type }}-build-${{ runner.os }}-

      - name: ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        if: steps.cache-build.outputs.cache-hit != 'true'
        working-directory: ${{ inputs.working-directory }}
        run: ${{ inputs.build-command }}

      - name: ğŸ“¤ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: ${{ inputs.build-type }}-build-${{ github.run_id }}
          path: ${{ inputs.artifact-paths }}
          retention-days: 7
