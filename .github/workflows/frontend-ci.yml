name: Frontend CI/CD Pipeline - Optimized

on:
  push:
    branches: [main, develop, "feature/autoforge-*"]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-ci.yml"
      - "package.json"
      - "pnpm-workspace.yaml"
  pull_request:
    branches: [main, develop]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-ci.yml"

# Global optimization settings
concurrency:
  group: frontend-ci-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read
  checks: write

env:
  NODE_VERSION: "22"
  PNPM_VERSION: "9"

jobs:
  # ========== Phaseæ¤œè¨¼ã‚¸ãƒ§ãƒ–ï¼ˆPhase 3è¿½åŠ ï¼‰ ==========
  validate-phase:
    name: ğŸ“‹ Phaseæ¤œè¨¼
    runs-on: ubuntu-latest
    outputs:
      phase: ${{ steps.check.outputs.phase }}
      frontend-ready: ${{ steps.check.outputs.frontend-ready }}
      run-quality-checks: ${{ steps.check.outputs.run-quality-checks }}
      run-tests: ${{ steps.check.outputs.run-tests }}
      run-build: ${{ steps.check.outputs.run-build }}
      run-performance: ${{ steps.check.outputs.run-performance }}

    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ” PhaseçŠ¶æ…‹ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒæº–å‚™ãƒã‚§ãƒƒã‚¯
        id: check
        run: |
          # Phaseç’°å¢ƒå¤‰æ•°ç¢ºèªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
          PHASE="${{ vars.CURRENT_PHASE || '3' }}"
          echo "phase=${PHASE}" >> $GITHUB_OUTPUT
          echo "::notice::ğŸ“Š ç¾åœ¨ã®Phase: ${PHASE}"

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒãƒã‚§ãƒƒã‚¯
          if [ -f "frontend/package.json" ] && [ -f "frontend/pnpm-lock.yaml" ]; then
            echo "frontend-ready=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒã‚’æ¤œå‡ºã—ã¾ã—ãŸ (Phase ${PHASE})"
          else
            echo "frontend-ready=false" >> $GITHUB_OUTPUT
            echo "::warning::âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒãŒæœªæº–å‚™ã§ã™ (Phase 5+ãŒå¿…è¦)"
            echo "::warning::ğŸ“‹ å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«: frontend/package.json, frontend/pnpm-lock.yaml"
          fi

          # Phaseåˆ¥å®Ÿè¡Œåˆ¶å¾¡ãƒ•ãƒ©ã‚°è¨­å®š
          if [ "$PHASE" -ge 3 ]; then
            echo "run-quality-checks=true" >> $GITHUB_OUTPUT
            echo "run-build=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ… Phase ${PHASE}: å“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒ“ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–"
          else
            echo "run-quality-checks=false" >> $GITHUB_OUTPUT
            echo "run-build=false" >> $GITHUB_OUTPUT
            echo "::notice::â­ï¸ Phase ${PHASE}: å“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ— (Phase 3+ãŒå¿…è¦)"
          fi

          if [ "$PHASE" -ge 5 ]; then
            echo "run-tests=true" >> $GITHUB_OUTPUT
            echo "run-performance=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ… Phase ${PHASE}: ãƒ†ã‚¹ãƒˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£æŸ»ã‚’æœ‰åŠ¹åŒ–"
          else
            echo "run-tests=false" >> $GITHUB_OUTPUT
            echo "run-performance=false" >> $GITHUB_OUTPUT
            echo "::notice::â­ï¸ Phase ${PHASE}: ãƒ†ã‚¹ãƒˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£æŸ»ã‚’ã‚¹ã‚­ãƒƒãƒ— (Phase 5+ãŒå¿…è¦)"
          fi

      - name: ğŸ“Š Phaseæ¤œè¨¼ã‚µãƒãƒªãƒ¼ä½œæˆ
        run: |
          echo "## ğŸ“‹ Phaseæ¤œè¨¼ã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | çŠ¶æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ç¾åœ¨ã®Phase** | Phase ${{ steps.check.outputs.phase }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒ** | ${{ steps.check.outputs.frontend-ready == 'true' && 'âœ… æº–å‚™å®Œäº†' || 'âŒ æœªæº–å‚™ (Phase 5+ãŒå¿…è¦)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **å“è³ªãƒã‚§ãƒƒã‚¯** | ${{ steps.check.outputs.run-quality-checks == 'true' && 'âœ… æœ‰åŠ¹' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ãƒ“ãƒ«ãƒ‰** | ${{ steps.check.outputs.run-build == 'true' && 'âœ… æœ‰åŠ¹' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ãƒ†ã‚¹ãƒˆ** | ${{ steps.check.outputs.run-tests == 'true' && 'âœ… æœ‰åŠ¹' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (Phase 5+ãŒå¿…è¦)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£æŸ»** | ${{ steps.check.outputs.run-performance == 'true' && 'âœ… æœ‰åŠ¹' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (Phase 5+ãŒå¿…è¦)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dockerãƒ“ãƒ«ãƒ‰** | ${{ steps.check.outputs.phase >= 5 && 'âœ… æœ‰åŠ¹ (Phase 5+)' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (Phase 5+ãŒå¿…è¦)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“š Phaseå®šç¾©" >> $GITHUB_STEP_SUMMARY
          echo "- **Phase 1-2**: ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰CI/CDã‚¹ã‚­ãƒƒãƒ—ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **Phase 3-4**: åŸºæœ¬æ¤œè¨¼ï¼ˆlintã€å‹ãƒã‚§ãƒƒã‚¯ã€ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ã®ã¿ã€Dockerãƒ“ãƒ«ãƒ‰ãªã—ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **Phase 5+**: å®Œå…¨ãªCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£æŸ»ãƒ»Dockerãƒ“ãƒ«ãƒ‰æœ‰åŠ¹ï¼‰" >> $GITHUB_STEP_SUMMARY

  # Shared setup for all jobs
  setup-environment:
    name: ğŸ”§ Setup Environment
    needs: validate-phase
    if: |
      needs.validate-phase.outputs.frontend-ready == 'true' &&
      needs.validate-phase.outputs.run-quality-checks == 'true'
    uses: ./.github/workflows/shared-setup-node.yml
    with:
      node-version: "22"
      pnpm-version: "9"
      working-directory: "./frontend"
      cache-key-suffix: "-frontend"
      install-playwright: true

  # Parallel quality checks with matrix strategy
  quality-checks:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    needs: [validate-phase, setup-environment]
    if: |
      !failure() &&
      needs.validate-phase.outputs.frontend-ready == 'true' &&
      needs.validate-phase.outputs.run-quality-checks == 'true'
    strategy:
      fail-fast: false
      matrix:
        check-type: [lint, type-check]
        include:
          - check-type: lint
            command: "pnpm lint && pnpm prettier --check ."
            name: "ESLint + Prettier"
          - check-type: type-check
            command: "pnpm type-check"
            name: "TypeScript Type Check"

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2  # v2 = å…¬å¼æ¨å¥¨å®‰å®šç‰ˆ
        with:
          version: 9
          run_install: false

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "./frontend/pnpm-lock.yaml"

      - name: ğŸ“¦ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ’¾ Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('./frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ” Pre-flight environment validation
        run: |
          echo "::notice::ğŸ” Validating CI environment..."
          for cmd in node npm pnpm; do
            command -v $cmd &> /dev/null || { echo "::error::âŒ $cmd NOT FOUND"; exit 1; }
            echo "::notice::âœ… $cmd: $($cmd --version)"
          done
          echo "::notice::âœ… Environment validated"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::notice::Installing frontend dependencies (pnpm cache enabled)"
          pnpm install --frozen-lockfile
        timeout-minutes: 5

      - name: ğŸ¯ Run ${{ matrix.name }}
        run: ${{ matrix.command }}
        timeout-minutes: 5
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

  # Parallel test execution with matrix
  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: [validate-phase, setup-environment]
    if: |
      !failure() &&
      needs.validate-phase.outputs.frontend-ready == 'true' &&
      needs.validate-phase.outputs.run-tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, e2e]
        include:
          - test-type: unit
            command: "pnpm test:ci --coverage"
            coverage-flag: "unit"
            artifacts: "coverage/"
          - test-type: e2e
            command: "pnpm build && pnpm test:e2e:ci"
            coverage-flag: "e2e"
            artifacts: "playwright-report/ test-results/"

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2  # v2 = å…¬å¼æ¨å¥¨å®‰å®šç‰ˆ
        with:
          version: 9
          run_install: false

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "./frontend/pnpm-lock.yaml"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::notice::Installing frontend dependencies for ${{ matrix.test-type }} tests"
          pnpm install --frozen-lockfile
        timeout-minutes: 5

      - name: ğŸ’¾ Cache Playwright browsers
        if: matrix.test-type == 'e2e'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ğŸ­ Install Playwright browsers
        if: matrix.test-type == 'e2e'
        run: pnpm exec playwright install --with-deps chromium

      - name: ğŸ§ª Run ${{ matrix.test-type }} tests
        run: ${{ matrix.command }}
        timeout-minutes: ${{ matrix.test-type == 'e2e' && 20 || 10 }}
        env:
          CI: true
          NODE_ENV: test

      - name: ğŸ“Š Verify coverage threshold
        if: matrix.test-type == 'unit'
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤æ¤œè¨¼ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 75%ï¼‰
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            THRESHOLD=75

            echo "::notice::ğŸ“Š Coverage: ${COVERAGE}% (Threshold: ${THRESHOLD}%)"

            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "::error::âŒ Coverage ${COVERAGE}% below threshold ${THRESHOLD}%"
              exit 1
            fi

            echo "::notice::âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
          else
            echo "::warning::âš ï¸ Coverage report not found, skipping threshold check"
          fi

      - name: ğŸ“Š Upload coverage to Codecov
        if: matrix.test-type == 'unit' && always()
        uses: codecov/codecov-action@4fe8c5f003fae66aa5ebb77cfd3e7bfbbda0b6b0 # v3.1.5
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend-${{ matrix.coverage-flag }}
          name: frontend-${{ matrix.test-type }}-coverage

      - name: ğŸ“ Upload test artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        if: always()
        with:
          name: frontend-${{ matrix.test-type }}-results-${{ github.run_id }}
          path: frontend/${{ matrix.artifacts }}
          retention-days: 7

  # Production build with caching
  production-build:
    name: ğŸ—ï¸ Production Build
    uses: ./.github/workflows/shared-build-cache.yml
    needs: [validate-phase, quality-checks]
    if: |
      !failure() &&
      needs.validate-phase.outputs.frontend-ready == 'true' &&
      needs.validate-phase.outputs.run-build == 'true'
    with:
      build-type: "frontend"
      working-directory: "./frontend"
      build-command: "pnpm build"
      artifact-paths: |
        frontend/.next/
        frontend/out/
        frontend/build-stats.json
      environment-vars: '{"NODE_ENV": "production", "NEXT_TELEMETRY_DISABLED": "1"}'

  # Performance and optimization audits
  performance-audit:
    name: âš¡ Performance Audit
    runs-on: ubuntu-latest
    needs: [validate-phase, setup-environment, production-build]
    if: |
      !failure() &&
      needs.validate-phase.outputs.frontend-ready == 'true' &&
      needs.validate-phase.outputs.run-performance == 'true' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2  # v2 = å…¬å¼æ¨å¥¨å®‰å®šç‰ˆ
        with:
          version: 9
          run_install: false

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: frontend-build-${{ github.run_id }}
          path: frontend/

      - name: ğŸš€ Start server for Lighthouse
        run: |
          pnpm start &
          sleep 10
          curl -f http://localhost:3000 || exit 1

      - name: ğŸ—ï¸ Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@03becbfc543944dd6e7534f7ff768abb8a296826 # v11.4.0
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
          configPath: "./lighthouse.ci.json"

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "## ğŸ“Š Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -f .next/analyze/bundle-sizes.json ]; then
            echo "Build size analysis completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Bundle analysis not available" >> $GITHUB_STEP_SUMMARY
          fi

  # Note: Docker build removed - Cloudflare Pages uses static deployment
  # Frontend deployed via: wrangler pages deploy frontend/out
  # No Docker container needed in production environment

  # Deployment preparation
  deployment-prep:
    name: ğŸ“¦ Deployment Preparation
    runs-on: ubuntu-latest
    needs: [validate-phase, production-build, test-suite, docker-build]
    if: |
      !failure() &&
      needs.validate-phase.outputs.frontend-ready == 'true' &&
      needs.validate-phase.outputs.run-build == 'true' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: frontend-build-${{ github.run_id }}
          path: frontend/

      - name: ğŸ“¦ Package for Cloudflare Pages
        run: |
          # Prepare optimized deployment package
          cd frontend
          tar -czf ../frontend-cloudflare-${{ github.sha }}.tar.gz \
            --exclude='node_modules' \
            --exclude='.next/cache' \
            out/

      - name: ğŸ“¤ Upload deployment package
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: frontend-deployment-${{ github.run_id }}
          path: frontend-cloudflare-${{ github.sha }}.tar.gz
          retention-days: 30

  # Comprehensive status check
  ci-status:
    name: ğŸ“Š CI Status
    runs-on: ubuntu-latest
    needs:
      [
        validate-phase,
        setup-environment,
        quality-checks,
        test-suite,
        production-build,
        docker-build,
      ]
    if: always()

    steps:
      - name: ğŸ“‹ Calculate overall status
        id: status
        run: |
          # Check if any critical jobs failed
          CRITICAL_JOBS=("setup-environment" "quality-checks" "production-build")
          FAILED_JOBS=""
          for job in "${CRITICAL_JOBS[@]}"; do
            if [[ "${{ toJSON(needs) }}" =~ "$job".*"failure" ]]; then
              FAILED_JOBS="$FAILED_JOBS $job"
            fi
          done
          if [ -z "$FAILED_JOBS" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All critical checks passed! ğŸ‰" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Critical jobs failed:$FAILED_JOBS âŒ" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Create status summary
        run: |
          echo "## ğŸ” Frontend CI/CD Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Setup | ${{ needs.setup-environment.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality-checks.result == 'success' && 'âœ…' || needs.quality-checks.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.test-suite.result == 'success' && 'âœ…' || needs.test-suite.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production Build | ${{ needs.production-build.result == 'success' && 'âœ…' || needs.production-build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ…' || needs.docker-build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Optimizations Applied**:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase-aware execution (smart job skipping based on implementation status)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Shared environment setup (eliminates 9 dependency duplications)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel quality checks with matrix strategy" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel test execution (unit + E2E)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Shared build cache workflow" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker layer caching optimization (Phase 5+)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Artifact-based dependency sharing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Phase 3-4 Mode**: Early quality validation (lint, type-check, build verification, Docker build skipped)" >> $GITHUB_STEP_SUMMARY
          echo "**Phase 5+ Mode**: Full CI/CD pipeline (tests, performance audit, Docker build, deployment)" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Success
        if: steps.status.outputs.status == 'success'
        run: |
          echo "${{ steps.status.outputs.message }}"
          exit 0

      - name: âŒ Failure
        if: steps.status.outputs.status == 'failure'
        run: |
          echo "${{ steps.status.outputs.message }}"
          exit 1
