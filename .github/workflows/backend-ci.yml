name: Backend CI/CD Pipeline - Optimized

on:
  push:
    branches: [main, develop, 'feature/autoforge-*']
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
      - 'requirements*.txt'
      - 'pyproject.toml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'

# Global optimization settings
concurrency:
  group: backend-ci-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  PYTHON_VERSION: '3.13'

jobs:
  # Shared setup for all jobs
  setup-environment:
    name: üîß Setup Environment
    uses: ./.github/workflows/shared-setup-python.yml
    with:
      python-version: '3.13'
      working-directory: './backend'
      cache-key-suffix: '-backend'
      install-dev-deps: true

  # Parallel quality checks with matrix strategy
  quality-checks:
    name: üîç Quality Checks
    runs-on: ubuntu-latest
    needs: setup-environment

    # ÊòéÁ§∫ÁöÑ„Å™Ê®©ÈôêÂÆöÁæ©ÔºàÊé®Â•®Á∑©ÂíåÁ≠ñ4ÂØæÂøúÔºâ
    permissions:
      contents: read        # „É™„Éù„Ç∏„Éà„É™Ë™≠„ÅøÂèñ„Çä
      statuses: write       # „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÅ„Çß„ÉÉ„ÇØÊõ¥Êñ∞

    strategy:
      fail-fast: false
      matrix:
        check-type: [lint, format, type-check, security]
        include:
          - check-type: lint
            command: 'ruff check src/ tests/ --output-format=github'
            name: 'Ruff Linting'
          - check-type: format
            command: 'black --check src/ tests/'
            name: 'Black Formatting'
          - check-type: type-check
            command: 'mypy src/ --strict'
            name: 'Type Checking'
          - check-type: security
            command: |
              echo "üîç Running Bandit security scan..."
              bandit -r src/ -f json -o bandit-report.json

              echo "üìä Verifying Bandit report..."
              if [ ! -f bandit-report.json ]; then
                echo "‚ùå ERROR: bandit-report.json not generated"
                exit 1
              fi

              echo "üîß Converting Bandit results to GitHub Annotations..."
              SCRIPT_PATH="${GITHUB_WORKSPACE}/.github/scripts/convert-bandit-to-github-annotations.py"

              if [ ! -f "$SCRIPT_PATH" ]; then
                echo "‚ùå ERROR: Script not found at: $SCRIPT_PATH"
                echo "Available files in .github/scripts/:"
                ls -la "${GITHUB_WORKSPACE}/.github/scripts/" || echo "Directory not found"
                exit 1
              fi

              python3 "$SCRIPT_PATH" bandit-report.json || true  # „Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂïèÈ°å„ÇíË≠¶Âëä„Å®„Åó„Å¶Êâ±„ÅÜ

              echo "üõ°Ô∏è Running Safety dependency check..."
              safety check --json || echo "‚ö†Ô∏è Safety check completed with warnings"
            name: 'Security Scan'

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: üêç Setup Python  # ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì• Restore cached dependencies
        id: cache-deps
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pip
            ./backend/venv
          key: python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-${{ hashFiles('backend/pyproject.toml', 'backend/requirements*.txt') }}
          restore-keys: |
            python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-

      - name: "üîß Fallback: Recreate venv if cache miss"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: |
          echo "‚ö†Ô∏è Cache miss detected - rebuilding Python environment"
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f pyproject.toml ]; then
            pip install -e .[dev]
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
            [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt
          fi
          echo "‚úÖ venv recreated successfully"

      - name: ‚úÖ Verify venv restoration
        working-directory: ./backend
        run: |
          if [ ! -d venv ]; then
            echo "‚ùå ERROR: venv directory not found after cache restoration"
            echo "Expected path: $(pwd)/venv"
            echo "Cache hit: ${{ steps.cache-deps.outputs.cache-hit }}"
            ls -la . || true
            exit 1
          fi
          if [ ! -f venv/bin/activate ]; then
            echo "‚ùå ERROR: venv/bin/activate not found"
            ls -la venv/bin/ || true
            exit 1
          fi

          # PythonÂÆüË°åÂèØËÉΩÊÄßÊ§úË®ºÔºàLOW-2025-001ÂØæÂøúÔºâ
          if [ ! -x venv/bin/python ]; then
            echo "‚ùå ERROR: venv/bin/python is not executable"
            ls -lh venv/bin/python || true
            exit 1
          fi

          # venvÂÆåÂÖ®ÊÄßÊ§úË®º
          source venv/bin/activate
          python --version || { echo "‚ùå ERROR: Python execution failed"; exit 1; }
          pip --version || { echo "‚ùå ERROR: pip not available"; exit 1; }
          pip check || { echo "‚ö†Ô∏è Dependency conflicts detected"; pip check; }
          echo "‚úÖ venv verified: $(ls -lh venv/bin/activate)"
          echo "‚úÖ Python executable: $(python --version)"
          echo "‚úÖ Pip version: $(pip --version)"

      - name: üîê Verify cache integrity
        if: steps.cache-deps.outputs.cache-hit == 'true'
        working-directory: ./backend
        run: |
          source venv/bin/activate

          # „Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÊ§úË®ºÔºàMED-2025-001ÂØæÂøúÔºâ
          pip list --format=freeze | sort > /tmp/installed.txt
          INSTALLED_HASH=$(sha256sum /tmp/installed.txt | cut -d' ' -f1)
          INSTALLED_COUNT=$(wc -l < /tmp/installed.txt)

          # ÊúüÂæÖ„Åï„Çå„Çã„Éë„ÉÉ„Ç±„Éº„Ç∏Êï∞„ÅÆÊ¶ÇÁÆóÔºàpyproject.toml„Éô„Éº„ÇπÔºâ
          EXPECTED_COUNT=$(grep -E '^\s*"[a-zA-Z0-9_-]+' pyproject.toml | grep -c '==' || echo "0")

          echo "üìä Cache Integrity Report:"
          echo "  - Installed packages: ${INSTALLED_COUNT}"
          echo "  - Expected packages (approx): ${EXPECTED_COUNT}"
          echo "  - Package list hash: ${INSTALLED_HASH}"

          # ÊúÄÂ∞èÈôê„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏Êï∞„ÉÅ„Çß„ÉÉ„ÇØÔºàFastAPI, pytest, ruff, mypyÁ≠âÔºâ
          MIN_PACKAGES=30
          if [ "$INSTALLED_COUNT" -lt "$MIN_PACKAGES" ]; then
            echo "‚ö†Ô∏è WARNING: Package count too low (expected: >=${MIN_PACKAGES}, installed: $INSTALLED_COUNT)"
            echo "This may indicate cache corruption. Rebuilding cache..."
            exit 1  # „Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñ„Åó„Å¶ÂÜç„Éì„É´„Éâ
          fi

          # ÈáçË¶Å„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          REQUIRED_PACKAGES="fastapi pytest ruff mypy black"
          for pkg in $REQUIRED_PACKAGES; do
            if ! pip show "$pkg" > /dev/null 2>&1; then
              echo "‚ùå ERROR: Required package '$pkg' not found in venv"
              echo "Cache may be corrupted. Rebuilding..."
              exit 1
            fi
          done

          echo "‚úÖ Cache integrity verified (hash: ${INSTALLED_HASH})"

      - name: üéØ Run ${{ matrix.name }}
        working-directory: ./backend
        run: |
          source venv/bin/activate

          # Verify required tools are installed
          case "${{ matrix.check-type }}" in
            format)
              black --version || { echo "‚ùå Black not found in venv"; exit 1; }
              ;;
            type-check)
              mypy --version || { echo "‚ùå mypy not found in venv"; exit 1; }
              ;;
            security)
              bandit --version || { echo "‚ùå Bandit not found in venv"; exit 1; }
              safety --version || { echo "‚ùå Safety not found in venv"; exit 1; }
              ;;
          esac

          # Run the check
          ${{ matrix.command }}

  # Parallel test execution with matrix
  test-suite:
    name: üß™ Test Suite
    runs-on: ubuntu-latest
    needs: setup-environment

    # ÊòéÁ§∫ÁöÑ„Å™Ê®©ÈôêÂÆöÁæ©ÔºàÊé®Â•®Á∑©ÂíåÁ≠ñ4ÂØæÂøúÔºâ
    permissions:
      contents: read        # „É™„Éù„Ç∏„Éà„É™Ë™≠„ÅøÂèñ„Çä
      pull-requests: write  # Codecov„Ç≥„É°„É≥„ÉàÊäïÁ®ø
      statuses: write       # „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÅ„Çß„ÉÉ„ÇØÊõ¥Êñ∞

    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, domain]
        include:
          - test-type: unit
            path: 'tests/unit/'
            coverage-flag: 'unit'
            cov-fail-under: 80  # Phase 3: „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÂü∫Áõ§ÂÆå‰∫ÜÊôÇ„ÅÆÁõÆÊ®ô
            cov-scope: 'src'    # ÂÖ®„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Çí„Ç´„Éê„É¨„ÉÉ„Ç∏ÂØæË±°
          - test-type: integration
            path: 'tests/integration/'
            coverage-flag: 'integration'
            cov-fail-under: 0   # Phase 4Êú™ÂÆüË£Ö„ÅÆ„Åü„ÇÅÂÖ®„ÉÜ„Çπ„Éà„Çπ„Ç≠„ÉÉ„ÉóÊôÇ„ÅØ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ„Å™„Åó
            cov-scope: 'src'    # ÂÖ®„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Çí„Ç´„Éê„É¨„ÉÉ„Ç∏ÂØæË±°
          - test-type: domain
            path: 'tests/unit/domain/'
            coverage-flag: 'domain'
            cov-fail-under: 85  # domainÂ±§„ÅÆ„Åø„ÅßÁèæÂÆüÁöÑ„Å™ÁõÆÊ®ô
            cov-scope: 'src/domain'  # domainÂ±§„ÅÆ„Åø„Çí„Ç´„Éê„É¨„ÉÉ„Ç∏ÂØæË±°

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: üêç Setup Python  # ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì• Restore cached dependencies
        id: cache-deps
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pip
            ./backend/venv
          key: python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-${{ hashFiles('backend/pyproject.toml', 'backend/requirements*.txt') }}
          restore-keys: |
            python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-

      - name: "üîß Fallback: Recreate venv if cache miss"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: |
          echo "‚ö†Ô∏è Cache miss detected - rebuilding Python environment"
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f pyproject.toml ]; then
            pip install -e .[dev]
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
            [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt
          fi
          echo "‚úÖ venv recreated successfully"

      - name: ‚úÖ Verify venv restoration
        working-directory: ./backend
        run: |
          if [ ! -d venv ]; then
            echo "‚ùå ERROR: venv directory not found after cache restoration"
            echo "Expected path: $(pwd)/venv"
            echo "Cache hit: ${{ steps.cache-deps.outputs.cache-hit }}"
            ls -la . || true
            exit 1
          fi
          if [ ! -f venv/bin/activate ]; then
            echo "‚ùå ERROR: venv/bin/activate not found"
            ls -la venv/bin/ || true
            exit 1
          fi

          # PythonÂÆüË°åÂèØËÉΩÊÄßÊ§úË®ºÔºàLOW-2025-001ÂØæÂøúÔºâ
          if [ ! -x venv/bin/python ]; then
            echo "‚ùå ERROR: venv/bin/python is not executable"
            ls -lh venv/bin/python || true
            exit 1
          fi

          # venvÂÆåÂÖ®ÊÄßÊ§úË®º
          source venv/bin/activate
          python --version || { echo "‚ùå ERROR: Python execution failed"; exit 1; }
          pip --version || { echo "‚ùå ERROR: pip not available"; exit 1; }
          pip check || { echo "‚ö†Ô∏è Dependency conflicts detected"; pip check; }
          echo "‚úÖ venv verified: $(ls -lh venv/bin/activate)"
          echo "‚úÖ Python executable: $(python --version)"
          echo "‚úÖ Pip version: $(pip --version)"

      - name: üîê Verify cache integrity
        if: steps.cache-deps.outputs.cache-hit == 'true'
        working-directory: ./backend
        run: |
          source venv/bin/activate

          # „Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÊ§úË®ºÔºàMED-2025-001ÂØæÂøúÔºâ
          pip list --format=freeze | sort > /tmp/installed.txt
          INSTALLED_HASH=$(sha256sum /tmp/installed.txt | cut -d' ' -f1)
          INSTALLED_COUNT=$(wc -l < /tmp/installed.txt)

          # ÊúüÂæÖ„Åï„Çå„Çã„Éë„ÉÉ„Ç±„Éº„Ç∏Êï∞„ÅÆÊ¶ÇÁÆóÔºàpyproject.toml„Éô„Éº„ÇπÔºâ
          EXPECTED_COUNT=$(grep -E '^\s*"[a-zA-Z0-9_-]+' pyproject.toml | grep -c '==' || echo "0")

          echo "üìä Cache Integrity Report:"
          echo "  - Installed packages: ${INSTALLED_COUNT}"
          echo "  - Expected packages (approx): ${EXPECTED_COUNT}"
          echo "  - Package list hash: ${INSTALLED_HASH}"

          # ÊúÄÂ∞èÈôê„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏Êï∞„ÉÅ„Çß„ÉÉ„ÇØÔºàFastAPI, pytest, ruff, mypyÁ≠âÔºâ
          MIN_PACKAGES=30
          if [ "$INSTALLED_COUNT" -lt "$MIN_PACKAGES" ]; then
            echo "‚ö†Ô∏è WARNING: Package count too low (expected: >=${MIN_PACKAGES}, installed: $INSTALLED_COUNT)"
            echo "This may indicate cache corruption. Rebuilding cache..."
            exit 1  # „Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñ„Åó„Å¶ÂÜç„Éì„É´„Éâ
          fi

          # ÈáçË¶Å„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          REQUIRED_PACKAGES="fastapi pytest"
          for pkg in $REQUIRED_PACKAGES; do
            if ! pip show "$pkg" > /dev/null 2>&1; then
              echo "‚ùå ERROR: Required package '$pkg' not found in venv"
              echo "Cache may be corrupted. Rebuilding..."
              exit 1
            fi
          done

          echo "‚úÖ Cache integrity verified (hash: ${INSTALLED_HASH})"

      - name: üß™ Run ${{ matrix.test-type }} tests
        working-directory: ./backend
        run: |
          source venv/bin/activate
          pytest ${{ matrix.path }} \
            --cov=${{ matrix.cov-scope }} \
            --cov-report=xml:coverage-${{ matrix.test-type }}.xml \
            --cov-report=html:htmlcov-${{ matrix.test-type }} \
            --cov-report=term \
            --cov-fail-under=${{ matrix.cov-fail-under }} \
            --tb=short \
            -v

      - name: üìä Upload coverage to Codecov
        uses: codecov/codecov-action@4fe8c5f003fae66aa5ebb77cfd3e7bfbbda0b6b0 # v3.1.5
        with:
          file: ./backend/coverage-${{ matrix.test-type }}.xml
          flags: backend-${{ matrix.coverage-flag }}
          name: backend-${{ matrix.test-type }}-coverage

      - name: üìÅ Upload coverage artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        if: always()
        with:
          name: backend-${{ matrix.test-type }}-coverage-${{ github.run_id }}
          path: backend/htmlcov-${{ matrix.test-type }}/
          retention-days: 7

  # Docker build with optimized caching
  docker-build:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: ${{ !failure() }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db # v3.6.1

      - name: üèóÔ∏è Build Docker image with cache
        uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75 # v6.9.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: autoforgenexus-backend:${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,scope=backend,mode=max
          build-args: |
            PYTHON_VERSION=${{ env.PYTHON_VERSION }}

  # API specification and build artifacts
  build-artifacts:
    name: üîß Build Artifacts
    runs-on: ubuntu-latest
    needs: setup-environment

    # ÊòéÁ§∫ÁöÑ„Å™Ê®©ÈôêÂÆöÁæ©ÔºàÊé®Â•®Á∑©ÂíåÁ≠ñ4ÂØæÂøúÔºâ
    permissions:
      contents: read        # „É™„Éù„Ç∏„Éà„É™Ë™≠„ÅøÂèñ„Çä
      actions: write        # „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: üêç Setup Python  # ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì• Restore cached dependencies
        id: cache-deps
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pip
            ./backend/venv
          key: python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-${{ hashFiles('backend/pyproject.toml', 'backend/requirements*.txt') }}
          restore-keys: |
            python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-

      - name: "üîß Fallback: Recreate venv if cache miss"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: |
          echo "‚ö†Ô∏è Cache miss detected - rebuilding Python environment"
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f pyproject.toml ]; then
            pip install -e .[dev]
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
            [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt
          fi
          echo "‚úÖ venv recreated successfully"

      - name: ‚úÖ Verify venv restoration
        working-directory: ./backend
        run: |
          if [ ! -d venv ]; then
            echo "‚ùå ERROR: venv directory not found after cache restoration"
            echo "Expected path: $(pwd)/venv"
            echo "Cache hit: ${{ steps.cache-deps.outputs.cache-hit }}"
            ls -la . || true
            exit 1
          fi
          if [ ! -f venv/bin/activate ]; then
            echo "‚ùå ERROR: venv/bin/activate not found"
            ls -la venv/bin/ || true
            exit 1
          fi

          # PythonÂÆüË°åÂèØËÉΩÊÄßÊ§úË®ºÔºàLOW-2025-001ÂØæÂøúÔºâ
          if [ ! -x venv/bin/python ]; then
            echo "‚ùå ERROR: venv/bin/python is not executable"
            ls -lh venv/bin/python || true
            exit 1
          fi

          # venvÂÆåÂÖ®ÊÄßÊ§úË®º
          source venv/bin/activate
          python --version || { echo "‚ùå ERROR: Python execution failed"; exit 1; }
          pip --version || { echo "‚ùå ERROR: pip not available"; exit 1; }
          pip check || { echo "‚ö†Ô∏è Dependency conflicts detected"; pip check; }
          echo "‚úÖ venv verified: $(ls -lh venv/bin/activate)"
          echo "‚úÖ Python executable: $(python --version)"
          echo "‚úÖ Pip version: $(pip --version)"

      - name: üîê Verify cache integrity
        if: steps.cache-deps.outputs.cache-hit == 'true'
        working-directory: ./backend
        run: |
          source venv/bin/activate

          # „Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÊ§úË®ºÔºàMED-2025-001ÂØæÂøúÔºâ
          pip list --format=freeze | sort > /tmp/installed.txt
          INSTALLED_HASH=$(sha256sum /tmp/installed.txt | cut -d' ' -f1)
          INSTALLED_COUNT=$(wc -l < /tmp/installed.txt)

          echo "üìä Cache Integrity Report:"
          echo "  - Installed packages: ${INSTALLED_COUNT}"
          echo "  - Package list hash: ${INSTALLED_HASH}"

          # ÊúÄÂ∞èÈôê„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏Êï∞„ÉÅ„Çß„ÉÉ„ÇØ
          MIN_PACKAGES=30
          if [ "$INSTALLED_COUNT" -lt "$MIN_PACKAGES" ]; then
            echo "‚ö†Ô∏è WARNING: Package count too low (expected: >=${MIN_PACKAGES}, installed: $INSTALLED_COUNT)"
            echo "This may indicate cache corruption. Rebuilding cache..."
            exit 1
          fi

          # FastAPIÂ≠òÂú®Á¢∫Ë™çÔºàOpenAPIÁîüÊàê„Å´ÂøÖÈ†àÔºâ
          if ! pip show fastapi > /dev/null 2>&1; then
            echo "‚ùå ERROR: FastAPI not found in venv"
            echo "Cache may be corrupted. Rebuilding..."
            exit 1
          fi

          echo "‚úÖ Cache integrity verified (hash: ${INSTALLED_HASH})"

      - name: üìÑ Generate OpenAPI specification
        working-directory: ./backend
        run: |
          source venv/bin/activate
          python -c "
          from src.main import app
          import json
          with open('openapi.json', 'w') as f:
              json.dump(app.openapi(), f, indent=2)
          " || echo "OpenAPI generation skipped - FastAPI app not ready"

      - name: üì¶ Package for deployment
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        run: |
          cd ..
          tar -czf backend-${{ github.sha }}.tar.gz \
            --exclude='backend/venv' \
            --exclude='backend/__pycache__' \
            --exclude='backend/.pytest_cache' \
            backend/

      - name: üì§ Upload artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: backend-artifacts-${{ github.run_id }}
          path: |
            backend/openapi.json
            backend-${{ github.sha }}.tar.gz
          retention-days: 30

  # Performance testing (optional, runs only on main/develop)
  performance-test:
    name: ‚ö° Performance Test
    runs-on: ubuntu-latest
    needs: [setup-environment, test-suite]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: üêç Setup Python  # ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì• Restore cached dependencies
        id: cache-deps
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pip
            ./backend/venv
          key: python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-${{ hashFiles('backend/pyproject.toml', 'backend/requirements*.txt') }}
          restore-keys: |
            python-${{ env.PYTHON_VERSION }}-${{ runner.os }}-

      - name: "üîß Fallback: Recreate venv if cache miss"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: |
          echo "‚ö†Ô∏è Cache miss detected - rebuilding Python environment"
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f pyproject.toml ]; then
            pip install -e .[dev]
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
            [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt
          fi
          echo "‚úÖ venv recreated successfully"

      - name: ‚úÖ Verify venv restoration
        working-directory: ./backend
        run: |
          if [ ! -d venv ]; then
            echo "‚ùå ERROR: venv directory not found after cache restoration"
            echo "Expected path: $(pwd)/venv"
            echo "Cache hit: ${{ steps.cache-deps.outputs.cache-hit }}"
            ls -la . || true
            exit 1
          fi
          if [ ! -f venv/bin/activate ]; then
            echo "‚ùå ERROR: venv/bin/activate not found"
            ls -la venv/bin/ || true
            exit 1
          fi

          # venvÂÆåÂÖ®ÊÄßÊ§úË®º
          source venv/bin/activate
          python --version
          pip --version
          pip check || { echo "‚ö†Ô∏è Dependency conflicts detected"; pip check; }
          echo "‚úÖ venv verified and validated"

      - name: üöÄ Run performance tests
        working-directory: ./backend
        run: |
          source venv/bin/activate
          if [ -f tests/performance/locustfile.py ]; then
            pip install locust
            echo "Performance tests would run here"
            # locust -f tests/performance/locustfile.py --headless -u 10 -r 2 -t 30s --host=http://localhost:8000
          else
            echo "‚ö†Ô∏è Performance tests not yet implemented"
          fi

  # Comprehensive status check
  ci-status:
    name: üìä CI Status
    runs-on: ubuntu-latest
    needs: [setup-environment, quality-checks, test-suite, docker-build, build-artifacts]
    if: always()

    steps:
      - name: üìã Calculate overall status
        id: status
        run: |
          # Check if any critical jobs failed
          CRITICAL_JOBS=("setup-environment" "quality-checks" "test-suite")
          FAILED_JOBS=""

          for job in "${CRITICAL_JOBS[@]}"; do
            if [[ "${{ toJSON(needs) }}" =~ "$job".*"failure" ]]; then
              FAILED_JOBS="$FAILED_JOBS $job"
            fi
          done

          if [ -z "$FAILED_JOBS" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All critical checks passed! üéâ" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Critical jobs failed:$FAILED_JOBS ‚ùå" >> $GITHUB_OUTPUT
          fi

      - name: üìä Create status summary
        run: |
          echo "## üîç Backend CI/CD Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Setup | ${{ needs.setup-environment.result == 'success' && '‚úÖ' || '‚ùå' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality-checks.result == 'success' && '‚úÖ' || '‚ùå' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.test-suite.result == 'success' && '‚úÖ' || '‚ùå' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && '‚úÖ' || '‚ùå' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Artifacts | ${{ needs.build-artifacts.result == 'success' && '‚úÖ' || '‚ùå' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Optimizations Applied**:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Shared environment setup (eliminates 7 dependency duplications)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Parallel quality checks with matrix strategy" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Parallel test execution (unit/integration/domain)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Docker layer caching optimization" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Artifact-based dependency sharing" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Success
        if: steps.status.outputs.status == 'success'
        run: |
          echo "${{ steps.status.outputs.message }}"
          exit 0

      - name: ‚ùå Failure
        if: steps.status.outputs.status == 'failure'
        run: |
          echo "${{ steps.status.outputs.message }}"
          exit 1
