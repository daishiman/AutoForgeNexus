name: PR Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  # PR validation
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Validate PR title format
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.pull_request.title;

            // ã‚¿ã‚¤ãƒˆãƒ«ã®æ­£è¦åŒ–ï¼ˆç©ºç™½ã¯äº‹å‰ã«pr-title-fix.ymlã§ä¿®æ­£æ¸ˆã¿ï¼‰
            const normalizedTitle = title.trim().replace(/\s+/g, ' ');

            // Conventional Commitså½¢å¼ã®æ¤œè¨¼ï¼ˆã‚ˆã‚Šå³å¯†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            const conventionalCommitRegex = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?: .+$/;

            // ã‚¿ã‚¤ãƒˆãƒ«ã®åŸºæœ¬æ¤œè¨¼
            const validations = {
              hasCorrectFormat: conventionalCommitRegex.test(normalizedTitle),
              hasDescription: normalizedTitle.split(':')[1]?.trim().length > 0,
              isNotTooLong: normalizedTitle.length <= 72,
              startsWithLowercase: /^[a-z]/.test(normalizedTitle)
            };

            // æ¤œè¨¼çµæœã®é›†è¨ˆ
            const validationErrors = [];

            if (!validations.hasCorrectFormat) {
              validationErrors.push('Conventional Commitså½¢å¼ã«å¾“ã£ã¦ã„ã¾ã›ã‚“');
            }

            if (!validations.hasDescription) {
              validationErrors.push('èª¬æ˜æ–‡ãŒç©ºã¾ãŸã¯ä¸è¶³ã—ã¦ã„ã¾ã™');
            }

            if (!validations.isNotTooLong) {
              validationErrors.push(`ã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ã™ãã¾ã™ï¼ˆ${normalizedTitle.length}æ–‡å­—ã€æ¨å¥¨: 72æ–‡å­—ä»¥å†…ï¼‰`);
            }

            if (!validations.startsWithLowercase) {
              validationErrors.push('ã‚¿ã‚¤ãƒ—ã¯å°æ–‡å­—ã§å§‹ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
            }

            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
            if (validationErrors.length > 0) {
              const errorMessage = `âŒ **PRã‚¿ã‚¤ãƒˆãƒ«ã®æ¤œè¨¼ã‚¨ãƒ©ãƒ¼**\n\n` +
                `**ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«**: \`${normalizedTitle}\`\n\n` +
                `**æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ**:\n` +
                validationErrors.map(err => `- ${err}`).join('\n') + '\n\n' +
                `**æ­£ã—ã„å½¢å¼**: \`<type>[(scope)]: <description>\`\n\n` +
                `**åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¤ãƒ—**:\n` +
                `- \`feat\`: æ–°æ©Ÿèƒ½\n` +
                `- \`fix\`: ãƒã‚°ä¿®æ­£\n` +
                `- \`docs\`: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´\n` +
                `- \`style\`: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å¤‰æ›´\n` +
                `- \`refactor\`: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°\n` +
                `- \`perf\`: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„\n` +
                `- \`test\`: ãƒ†ã‚¹ãƒˆã®è¿½åŠ ãƒ»ä¿®æ­£\n` +
                `- \`build\`: ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã®å¤‰æ›´\n` +
                `- \`ci\`: CIè¨­å®šã®å¤‰æ›´\n` +
                `- \`chore\`: ãã®ä»–ã®å¤‰æ›´\n` +
                `- \`revert\`: ã‚³ãƒŸãƒƒãƒˆã®å–ã‚Šæ¶ˆã—\n\n` +
                `**ã‚¿ã‚¤ãƒˆãƒ«ä¾‹**:\n` +
                `- \`feat: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã®è¿½åŠ \`\n` +
                `- \`fix(auth): ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£\`\n` +
                `- \`docs: APIä»•æ§˜æ›¸ã®æ›´æ–°\`\n\n` +
                `è©³ç´°ã¯[CONTRIBUTING.md](../blob/main/CONTRIBUTING.md)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: errorMessage
              });

              core.setFailed(`PRã‚¿ã‚¤ãƒˆãƒ«ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ${validationErrors.join(', ')}`);
              return;
            }

            // ã™ã¹ã¦ã®æ¤œè¨¼ã‚’ãƒ‘ã‚¹
            console.log(`âœ… PR title is valid: '${normalizedTitle}'`);

      - name: ğŸ“ Validate PR title format (backup check)
        if: success()
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # ã‚¿ã‚¤ãƒˆãƒ«ã®ç©ºç™½ã‚’è¨±å®¹ã™ã‚‹è¨­å®š
          requireScope: false
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨±å¯ï¼ˆConventional Commitså½¢å¼ã®ã¿æ¤œè¨¼ï¼‰
          subjectPattern: ^.*$
          subjectPatternError: |
            PRã‚¿ã‚¤ãƒˆãƒ«ã¯ "type: description" å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            ä¾‹: "feat: æ–°æ©Ÿèƒ½è¿½åŠ ", "fix: ãƒã‚°ä¿®æ­£"

      - name: ğŸ“Š Check PR size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: "size/xs"
          xs_max_size: "10"
          s_label: "size/s"
          s_max_size: "100"
          m_label: "size/m"
          m_max_size: "500"
          l_label: "size/l"
          l_max_size: "1000"
          xl_label: "size/xl"

      - name: ğŸ·ï¸ Auto-label PR
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: false
          dot: true

  # Code quality check
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š SonarCloud Scan
        # SONAR_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if: ${{ format('{0}', env.SONAR_TOKEN) != '' }}
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # SonarCloudè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          args: >
            -Dsonar.projectKey=daishiman_AutoForgeNexus
            -Dsonar.organization=daishiman
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info
            -Dsonar.sources=backend/src,frontend/src
            -Dsonar.tests=backend/tests,frontend/tests
            -Dsonar.exclusions=**/__pycache__/**,**/node_modules/**,**/dist/**,**/build/**

      - name: âš ï¸ SonarCloud Skipped
        # SONAR_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®è­¦å‘Š
        if: ${{ format('{0}', env.SONAR_TOKEN) == '' }}
        run: |
          echo "âš ï¸ SonarCloud scan skipped: SONAR_TOKEN not configured"
          echo "To enable SonarCloud analysis:"
          echo "1. Create a SonarCloud account at https://sonarcloud.io"
          echo "2. Generate a token"
          echo "3. Add SONAR_TOKEN to GitHub repository secrets"

      - name: ğŸ” Check for conflicts
        run: |
          # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æ¤œç´¢ï¼ˆä¾å­˜é–¢ä¿‚ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’é™¤å¤–ï¼‰
          # å¯¾è±¡: backend/src/, frontend/src/ ã®ã¿ï¼ˆæœ€ã‚‚é‡è¦ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼‰
          CONFLICT_COUNT=0

          # backend/src ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¤œç´¢
          if [ -d "backend/src" ]; then
            BACKEND_CONFLICTS=$(grep -r "<<<<<<< HEAD" backend/src/ 2>/dev/null || true)
            if [ -n "$BACKEND_CONFLICTS" ]; then
              echo "âŒ Merge conflicts in backend/src:"
              echo "$BACKEND_CONFLICTS"
              CONFLICT_COUNT=$((CONFLICT_COUNT + 1))
            fi
          fi

          # frontend/src ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¤œç´¢
          if [ -d "frontend/src" ]; then
            FRONTEND_CONFLICTS=$(grep -r "<<<<<<< HEAD" frontend/src/ 2>/dev/null || true)
            if [ -n "$FRONTEND_CONFLICTS" ]; then
              echo "âŒ Merge conflicts in frontend/src:"
              echo "$FRONTEND_CONFLICTS"
              CONFLICT_COUNT=$((CONFLICT_COUNT + 1))
            fi
          fi

          if [ $CONFLICT_COUNT -gt 0 ]; then
            exit 1
          fi

          echo "âœ… No merge conflicts found in source code"
          echo "   Checked: backend/src/, frontend/src/"

      - name: ğŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: >-
            --only-verified
            --exclude-paths=.trufflehog_regex_ignore
            --fail
            --no-update
            --github-actions

  # Claude Code Review (AI Review)
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¤– Prepare Claude Review Context
        id: prepare
        run: |
          # Get changed files count (avoid octal escape sequences in template strings)
          FILE_COUNT=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ“ Post Claude Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // å®‰å…¨ãªPRç•ªå·å–å¾—ï¼ˆOptional chaining + å‹æ¤œè¨¼ï¼‰
            const prNumber = context.payload?.pull_request?.number;

            // Early validation
            if (!prNumber || typeof prNumber !== 'number') {
              core.info('â„¹ï¸ PR context not available, skipping review comment');
              core.debug(`Event: ${context.eventName}, Payload keys: ${Object.keys(context.payload).join(', ')}`);
              return;
            }

            const fileCount = parseInt('${{ steps.prepare.outputs.file_count }}', 10) || 0;

            // Markdownã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆå®‰å…¨ãªå¤‰æ•°ä½¿ç”¨ï¼‰
            const comment = [
              '## ğŸ¤– Claude Code ãƒ¬ãƒ“ãƒ¥ãƒ¼',
              '',
              '### ğŸ“Š PR ã‚µãƒãƒªãƒ¼',
              `- **PRç•ªå·**: #${prNumber}`,
              `- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${fileCount}`,
              '- **ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ³**: è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹æ¸ˆã¿',
              '',
              '### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
              '',
              '#### ã‚³ãƒ¼ãƒ‰å“è³ª',
              '- [ ] SOLIDåŸå‰‡ã¸ã®æº–æ‹ ',
              '- [ ] DRYåŸå‰‡ã®éµå®ˆ',
              '- [ ] é©åˆ‡ãªæŠ½è±¡åŒ–ãƒ¬ãƒ™ãƒ«',
              '- [ ] ä¸€è²«æ€§ã®ã‚ã‚‹å‘½åè¦å‰‡',
              '',
              '#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£',
              '- [ ] ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„APIã‚­ãƒ¼ã®éœ²å‡ºãªã—',
              '- [ ] å…¥åŠ›å€¤æ¤œè¨¼ã®å®Ÿè£…',
              '- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–',
              '- [ ] XSSå¯¾ç­–ã®å®Ÿè£…',
              '',
              '#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹',
              '- [ ] O(nÂ²)ä»¥ä¸Šã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãªã—',
              '- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–',
              '- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã—',
              '- [ ] async/awaitã®é©åˆ‡ãªä½¿ç”¨',
              '',
              '#### ãƒ†ã‚¹ãƒˆ',
              '- [ ] æ–°æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆè¿½åŠ ',
              '- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ã‚«ãƒãƒ¼',
              '- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™é”æˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: 80%ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 75%ï¼‰',
              '',
              '#### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',
              '- [ ] è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ',
              '- [ ] APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°',
              '- [ ] å¿…è¦ã«å¿œã˜ãŸREADMEæ›´æ–°',
              '',
              '### ğŸ’¡ æ¨å¥¨äº‹é …',
              'è‡ªå‹•åˆ†æã«åŸºã¥ãæ¨å¥¨äº‹é …:',
              '1. ãƒãƒ¼ã‚¸å‰ã«ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª',
              '2. å¤‰æ›´ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«æ²¿ã£ã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼',
              '3. æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’è€ƒæ…®',
              '',
              '### ğŸ“Œ æ³¨æ„',
              'è©³ç´°ãªåˆ†æãŒå¿…è¦ãªå ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:',
              '```bash',
              `/ai:quality:analyze --pr ${prNumber}`,
              '```',
              '',
              '---',
              '*Claude Code ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  v1.0 ã«ã‚ˆã‚Šç”Ÿæˆ*'
            ].join('\n');

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãAPIå‘¼ã³å‡ºã—
            try {
              const result = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              core.info(`âœ… Review comment posted to PR #${prNumber}`);
              core.info(`Comment URL: ${result.data.html_url}`);
            } catch (error) {
              // ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆæ©Ÿå¯†æƒ…å ±é™¤å¤–ï¼‰
              const errorType = error.name || 'UnknownError';
              const errorStatus = error.status || 'N/A';

              // æ©Ÿå¯†æƒ…å ±ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
              const sanitizedMessage = (error.message || '')
                .replace(/token[=:][\w-]+/gi, 'token=[REDACTED]')
                .replace(/key[=:][\w-]+/gi, 'key=[REDACTED]')
                .replace(/https?:\/\/[^\s]+/gi, '[URL_REDACTED]');

              core.warning(`âš ï¸ Failed to post review comment: ${errorType} (${errorStatus})`);
              core.debug(`Sanitized details: ${sanitizedMessage}`);

              // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ç‰¹åˆ¥å‡¦ç†
              if (errorStatus === 403 || errorStatus === 429) {
                core.warning('GitHub API rate limit may be exceeded');
              }

              // ã‚¸ãƒ§ãƒ–ã¯å¤±æ•—ã•ã›ãªã„ï¼ˆä»–ã®ãƒã‚§ãƒƒã‚¯ç¶™ç¶šï¼‰
            }

  # Test coverage report
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ğŸ“Š Generate coverage comment
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Final status
  pr-status:
    name: PR Status Check
    needs: [validate-pr, code-quality, claude-review, coverage-report]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: âœ… All checks passed
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: |
          echo "âœ… All PR checks passed!"
          echo "Ready for manual review and merge."

      - name: âŒ Some checks failed
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo "âŒ Some PR checks failed!"
          echo "Please fix the issues before merging."
          exit 1
