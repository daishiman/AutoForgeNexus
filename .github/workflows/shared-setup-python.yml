name: "å…±æœ‰Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
# ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãPythonç’°å¢ƒã®å†åˆ©ç”¨å¯èƒ½ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  workflow_call:
    inputs:
      python-version:
        description: "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³"
        required: false
        default: "3.13"
        type: string
      working-directory:
        description: "Pythonæ“ä½œç”¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
        required: false
        default: "./backend"
        type: string
      cache-key-suffix:
        description: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®è¿½åŠ ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹"
        required: false
        default: ""
        type: string
      install-dev-deps:
        description: "é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        required: false
        default: true
        type: boolean

jobs:
  setup-python:
    name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      python-cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false

      - name: ğŸ Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: ğŸ”‘ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
        id: cache-key
        run: |
          cd ${{ inputs.working-directory }}
          # pyproject.tomlæ–¹å¼
          if [ -f pyproject.toml ]; then
            DEPS_HASH=$(sha256sum pyproject.toml | cut -d' ' -f1)
          # requirements.txtæ–¹å¼
          elif [ -f requirements.txt ]; then
            DEPS_HASH=$(sha256sum requirements*.txt 2>/dev/null | sha256sum | cut -d' ' -f1)
          else
            DEPS_HASH="no-deps-$(date +%s)"
          fi
          CACHE_KEY="python-${{ inputs.python-version }}-${{ runner.os }}-${DEPS_HASH}${{ inputs.cache-key-suffix }}"
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼: ${CACHE_KEY}"

      - name: ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        id: cache-deps
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pip
            ${{ inputs.working-directory }}/venv
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            python-${{ inputs.python-version }}-${{ runner.os }}-

      - name: ğŸ“¦ ä»®æƒ³ç’°å¢ƒã®ä½œæˆ
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          source venv/bin/activate
          # pyproject.tomlæ–¹å¼ï¼ˆæ¨å¥¨ï¼‰
          if [ -f pyproject.toml ]; then
            if [ "${{ inputs.install-dev-deps }}" == "true" ]; then
              pip install -e .[dev]
            else
              pip install -e .
            fi
          # requirements.txtæ–¹å¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
            if [ "${{ inputs.install-dev-deps }}" == "true" ] && [ -f requirements-dev.txt ]; then
              pip install -r requirements-dev.txt
            fi
          else
            echo "âŒ No dependency file found (pyproject.toml or requirements.txt)"
            exit 1
          fi

      - name: ğŸ“¤ Pythonç’°å¢ƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: python-env-${{ github.run_id }}
          path: ${{ inputs.working-directory }}/venv
          retention-days: 1
