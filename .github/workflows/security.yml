name: "Security Scanning"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®šæœŸã‚¹ã‚­ãƒ£ãƒ³
    - cron: '0 18 * * 1'  # UTC 18:00 = JST 03:00 (Monday)
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - secrets
        - dependencies
        - infrastructure

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³ï¼ˆTruffleHogï¼‰
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets' || github.event.inputs.scan_type == ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Upload scan results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: secret-scan-results
        path: trufflehog-results.json
        retention-days: 30

  # Pythonä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  python-security:
    name: Python Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies' || github.event.inputs.scan_type == ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        cd backend
        pip install --upgrade pip
        pip install safety bandit[toml] pip-audit
        pip install -e .[dev]

    # Safety - æ—¢çŸ¥ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    - name: Run Safety scan
      run: |
        cd backend
        safety check --json --output safety-report.json || true

    # Bandit - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œæ¤œå‡º
    - name: Run Bandit scan
      run: |
        cd backend
        bandit -r src/ -f json -o bandit-report.json || true

    # pip-audit - PyPIè„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    - name: Run pip-audit
      run: |
        cd backend
        pip-audit --format=json --output=pip-audit-report.json || true

    - name: Upload Python security reports
      uses: actions/upload-artifact@v4
      with:
        name: python-security-reports
        path: |
          backend/safety-report.json
          backend/bandit-report.json
          backend/pip-audit-report.json
        retention-days: 30

  # JavaScript/TypeScriptä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³
  js-security:
    name: JavaScript Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies' || github.event.inputs.scan_type == ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'
        cache-dependency-path: './frontend/pnpm-lock.yaml'

    - name: Install dependencies
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile

    # pnpm audit
    - name: Run pnpm audit
      working-directory: ./frontend
      run: |
        pnpm audit --json > ../pnpm-audit-report.json || true

    # audit-ci with pnpm
    - name: Run audit-ci
      working-directory: ./frontend
      run: |
        npx audit-ci --package-manager pnpm --report-type json --output-file ../audit-ci-report.json || true

    - name: Upload JS security reports
      uses: actions/upload-artifact@v4
      with:
        name: js-security-reports
        path: |
          pnpm-audit-report.json
          audit-ci-report.json
        retention-days: 30

  # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆCheckovï¼‰
  infrastructure-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'infrastructure' || github.event.inputs.scan_type == ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python for Checkov
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Checkov
      run: pip install checkov

    # Dockerè¨­å®šã‚¹ã‚­ãƒ£ãƒ³
    - name: Run Checkov on Docker files
      run: |
        checkov -f docker-compose*.yml -o json --output-file checkov-docker-report.json || true

    # GitHub Actionsè¨­å®šã‚¹ã‚­ãƒ£ãƒ³
    - name: Run Checkov on GitHub Actions
      run: |
        checkov -d .github/workflows -o json --output-file checkov-github-actions-report.json || true

    - name: Upload infrastructure scan reports
      uses: actions/upload-artifact@v4
      with:
        name: infrastructure-scan-reports
        path: |
          checkov-docker-report.json
          checkov-github-actions-report.json
        retention-days: 30

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, python-security, js-security, infrastructure-scan]
    if: always()

    steps:
    - name: Download all scan results
      uses: actions/download-artifact@v4
      with:
        path: scan-results

    - name: Generate security summary
      run: |
        echo "## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ" > security-summary.md
        echo "" >> security-summary.md
        echo "å®Ÿè¡Œæ—¥æ™‚: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
        echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> security-summary.md
        echo "" >> security-summary.md

        # å„ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ã‚µãƒãƒªãƒ¼
        echo "### ã‚¹ã‚­ãƒ£ãƒ³çŠ¶æ³" >> security-summary.md
        echo "- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.secret-scan.result }}" >> security-summary.md
        echo "- Pythonä¾å­˜é–¢ä¿‚: ${{ needs.python-security.result }}" >> security-summary.md
        echo "- JavaScriptä¾å­˜é–¢ä¿‚: ${{ needs.js-security.result }}" >> security-summary.md
        echo "- ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£: ${{ needs.infrastructure-scan.result }}" >> security-summary.md
        echo "" >> security-summary.md

        if [ "${{ needs.secret-scan.result }}" = "failure" ] ||
           [ "${{ needs.python-security.result }}" = "failure" ] ||
           [ "${{ needs.js-security.result }}" = "failure" ] ||
           [ "${{ needs.infrastructure-scan.result }}" = "failure" ]; then
          echo "âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**" >> security-summary.md
          echo "è©³ç´°ã¯å„ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> security-summary.md
        else
          echo "âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> security-summary.md
        fi

    - name: Upload security summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md
        retention-days: 30

    # PRæ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - name: Comment security results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('security-summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });