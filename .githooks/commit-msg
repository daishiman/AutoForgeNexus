#!/bin/bash
# Commit-msg hook: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œè¨¼

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo "ğŸ“ Validating commit message..."

# Conventional Commits ãƒ‘ã‚¿ãƒ¼ãƒ³
# https://www.conventionalcommits.org/
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,100}"

# ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚±ãƒ¼ã‚¹: ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã€ãƒªãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆ
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert) "; then
    echo "âœ… Merge/Revert commit detected"
    exit 0
fi

# GitFlowã®finishã‚³ãƒŸãƒƒãƒˆ
if echo "$COMMIT_MSG" | grep -qE "^(Finish|Start) (feature|release|hotfix)"; then
    echo "âœ… GitFlow commit detected"
    exit 0
fi

# Conventional Commitsãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo "âŒ Commit message does not follow Conventional Commits format!"
    echo ""
    echo "ğŸ“– Valid format: <type>(<scope>): <subject>"
    echo ""
    echo "Types:"
    echo "  feat     : æ–°æ©Ÿèƒ½"
    echo "  fix      : ãƒã‚°ä¿®æ­£"
    echo "  docs     : ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤‰æ›´"
    echo "  style    : ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´"
    echo "  refactor : ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°"
    echo "  perf     : ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„"
    echo "  test     : ãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»ä¿®æ­£"
    echo "  build    : ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´"
    echo "  ci       : CI/CDè¨­å®šå¤‰æ›´"
    echo "  chore    : ãã®ä»–ã®å¤‰æ›´"
    echo "  revert   : ã‚³ãƒŸãƒƒãƒˆã®å–ã‚Šæ¶ˆã—"
    echo ""
    echo "Examples:"
    echo "  feat: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ "
    echo "  fix(auth): ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£"
    echo "  docs: READMEã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’è¿½åŠ "
    echo ""
    echo "Your message: $COMMIT_MSG"
    exit 1
fi

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é•·ã•ãƒã‚§ãƒƒã‚¯
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)
if [ ${#FIRST_LINE} -gt 100 ]; then
    echo "âš ï¸ Warning: First line is ${#FIRST_LINE} characters (recommended: â‰¤100)"
fi

# ç ´å£Šçš„å¤‰æ›´ã®ãƒã‚§ãƒƒã‚¯
if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE:\|!:"; then
    echo "âš ï¸ BREAKING CHANGE detected!"
    echo "Make sure to update the version accordingly"
fi

echo "âœ… Commit message validation passed!"