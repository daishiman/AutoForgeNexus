#!/bin/bash
# Pre-push hook: „Éó„ÉÉ„Ç∑„É•Ââç„ÅÆÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ

set -e

echo "üöÄ Pre-push checks starting..."

PROTECTED_BRANCH="main"
CURRENT_BRANCH=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

# 1. main„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆÁõ¥Êé•„Éó„ÉÉ„Ç∑„É•Èò≤Ê≠¢
if [ "$CURRENT_BRANCH" = "$PROTECTED_BRANCH" ]; then
    echo "‚ùå Direct push to $PROTECTED_BRANCH branch is not allowed!"
    echo "üí° Please create a pull request instead"
    exit 1
fi

# 2. develop„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆÁõ¥Êé•„Éó„ÉÉ„Ç∑„É•Ë≠¶Âëä
if [ "$CURRENT_BRANCH" = "develop" ]; then
    echo "‚ö†Ô∏è Warning: Pushing directly to develop branch"
    read -p "Are you sure? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 3. „ÉÜ„Çπ„Éà„ÅÆÂÆüË°åÔºàÁí∞Â¢É„ÅåÊï¥„Å£„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
echo "üß™ Running tests..."

# Python„ÉÜ„Çπ„Éà
if [ -d "backend" ] && [ -f "backend/pytest.ini" ]; then
    echo "  Running Python tests..."
    (cd backend && python -m pytest tests/ -x --tb=short) || {
        echo "‚ùå Python tests failed"
        echo "üí° Fix tests before pushing"
        exit 1
    }
fi

# TypeScript„ÉÜ„Çπ„Éà
if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
    if grep -q '"test"' frontend/package.json; then
        echo "  Running TypeScript tests..."
        (cd frontend && pnpm test:ci 2>/dev/null || npm test) || {
            echo "‚ùå TypeScript tests failed"
            echo "üí° Fix tests before pushing"
            exit 1
        }
    fi
fi

# 4. „Éì„É´„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
echo "üèóÔ∏è Checking build..."

# TypeScript„Éì„É´„Éâ
if [ -d "frontend" ] && [ -f "frontend/tsconfig.json" ]; then
    echo "  Checking TypeScript compilation..."
    (cd frontend && npx tsc --noEmit) || {
        echo "‚ùå TypeScript compilation failed"
        echo "üí° Fix type errors before pushing"
        exit 1
    }
fi

# 5. „Éñ„É©„É≥„ÉÅÂêç„ÅÆÊ§úË®º
VALID_BRANCH_PATTERN="^(feature|release|hotfix|bugfix|support)/[a-z0-9-]+$"
if ! echo "$CURRENT_BRANCH" | grep -qE "$VALID_BRANCH_PATTERN|^develop$"; then
    echo "‚ö†Ô∏è Warning: Branch name '$CURRENT_BRANCH' doesn't follow naming convention"
    echo "üí° Expected pattern: feature/*, release/*, hotfix/*, bugfix/*, support/*"
fi

# 6. „Ç≥„Éü„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÁ¢∫Ë™ç
COMMITS=$(git log origin/$CURRENT_BRANCH..HEAD --oneline 2>/dev/null | wc -l || echo "0")
if [ "$COMMITS" -eq "0" ]; then
    echo "‚ÑπÔ∏è No new commits to push"
elif [ "$COMMITS" -gt "20" ]; then
    echo "‚ö†Ô∏è Warning: Pushing $COMMITS commits. Consider squashing if they're related"
fi

echo "‚úÖ Pre-push checks passed!"
echo "üì§ Pushing to remote..."